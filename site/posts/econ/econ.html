<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-10-16">

<title>Practical Econometrics with R – LiaoBingJie’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a1429a6327a406641e894be5e9506cf7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">LiaoBingJie’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/liaobingjie"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lm" id="toc-lm" class="nav-link active" data-scroll-target="#lm"><span class="header-section-number">1</span> LM</a>
  <ul class="collapse">
  <li><a href="#sec-lm-overview" id="toc-sec-lm-overview" class="nav-link" data-scroll-target="#sec-lm-overview"><span class="header-section-number">1.1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#description" id="toc-description" class="nav-link" data-scroll-target="#description"><span class="header-section-number">1.1.1</span> Description</a></li>
  <li><a href="#correlation" id="toc-correlation" class="nav-link" data-scroll-target="#correlation"><span class="header-section-number">1.1.2</span> Correlation</a></li>
  <li><a href="#causalty" id="toc-causalty" class="nav-link" data-scroll-target="#causalty"><span class="header-section-number">1.1.3</span> Causalty</a></li>
  </ul></li>
  <li><a href="#sec-lm-endogenity" id="toc-sec-lm-endogenity" class="nav-link" data-scroll-target="#sec-lm-endogenity"><span class="header-section-number">1.2</span> Endogeneity</a>
  <ul class="collapse">
  <li><a href="#definition" id="toc-definition" class="nav-link" data-scroll-target="#definition"><span class="header-section-number">1.2.1</span> Definition</a></li>
  <li><a href="#solution" id="toc-solution" class="nav-link" data-scroll-target="#solution"><span class="header-section-number">1.2.2</span> Solution</a></li>
  <li><a href="#case-study" id="toc-case-study" class="nav-link" data-scroll-target="#case-study"><span class="header-section-number">1.2.3</span> Case Study</a></li>
  </ul></li>
  <li><a href="#sec-lm-heterogeneity" id="toc-sec-lm-heterogeneity" class="nav-link" data-scroll-target="#sec-lm-heterogeneity"><span class="header-section-number">1.3</span> Heterogeneity</a>
  <ul class="collapse">
  <li><a href="#definition-1" id="toc-definition-1" class="nav-link" data-scroll-target="#definition-1"><span class="header-section-number">1.3.1</span> Definition</a></li>
  <li><a href="#solution-1" id="toc-solution-1" class="nav-link" data-scroll-target="#solution-1"><span class="header-section-number">1.3.2</span> Solution</a></li>
  <li><a href="#case-study-1" id="toc-case-study-1" class="nav-link" data-scroll-target="#case-study-1"><span class="header-section-number">1.3.3</span> Case Study</a></li>
  </ul></li>
  <li><a href="#sec-lm-robustness" id="toc-sec-lm-robustness" class="nav-link" data-scroll-target="#sec-lm-robustness"><span class="header-section-number">1.4</span> Robustness</a>
  <ul class="collapse">
  <li><a href="#residuals" id="toc-residuals" class="nav-link" data-scroll-target="#residuals"><span class="header-section-number">1.4.1</span> Residuals</a></li>
  <li><a href="#normality" id="toc-normality" class="nav-link" data-scroll-target="#normality"><span class="header-section-number">1.4.2</span> Normality</a></li>
  <li><a href="#multi-colinearity" id="toc-multi-colinearity" class="nav-link" data-scroll-target="#multi-colinearity"><span class="header-section-number">1.4.3</span> Multi-Colinearity</a></li>
  <li><a href="#heteroskedasticity" id="toc-heteroskedasticity" class="nav-link" data-scroll-target="#heteroskedasticity"><span class="header-section-number">1.4.4</span> Heteroskedasticity</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">1.5</span> Conclusion</a></li>
  </ul></li>
  <li><a href="#did" id="toc-did" class="nav-link" data-scroll-target="#did"><span class="header-section-number">2</span> DID</a>
  <ul class="collapse">
  <li><a href="#sec-did-overview" id="toc-sec-did-overview" class="nav-link" data-scroll-target="#sec-did-overview"><span class="header-section-number">2.1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#description-1" id="toc-description-1" class="nav-link" data-scroll-target="#description-1"><span class="header-section-number">2.1.1</span> Description</a></li>
  <li><a href="#advantages" id="toc-advantages" class="nav-link" data-scroll-target="#advantages"><span class="header-section-number">2.1.2</span> Advantages</a></li>
  <li><a href="#pta" id="toc-pta" class="nav-link" data-scroll-target="#pta"><span class="header-section-number">2.1.3</span> PTA</a></li>
  <li><a href="#formula-and-code" id="toc-formula-and-code" class="nav-link" data-scroll-target="#formula-and-code"><span class="header-section-number">2.1.4</span> Formula and Code</a></li>
  </ul></li>
  <li><a href="#modeling" id="toc-modeling" class="nav-link" data-scroll-target="#modeling"><span class="header-section-number">2.2</span> Modeling</a>
  <ul class="collapse">
  <li><a href="#sec-did-modeling" id="toc-sec-did-modeling" class="nav-link" data-scroll-target="#sec-did-modeling"><span class="header-section-number">2.2.1</span> Base Model</a></li>
  <li><a href="#sec-did-exogeneity" id="toc-sec-did-exogeneity" class="nav-link" data-scroll-target="#sec-did-exogeneity"><span class="header-section-number">2.2.2</span> Exogeineity</a></li>
  <li><a href="#sec-did-heterogeneity" id="toc-sec-did-heterogeneity" class="nav-link" data-scroll-target="#sec-did-heterogeneity"><span class="header-section-number">2.2.3</span> Heterogeneity</a></li>
  </ul></li>
  <li><a href="#tests" id="toc-tests" class="nav-link" data-scroll-target="#tests"><span class="header-section-number">2.3</span> Tests</a>
  <ul class="collapse">
  <li><a href="#sec-did-es" id="toc-sec-did-es" class="nav-link" data-scroll-target="#sec-did-es"><span class="header-section-number">2.3.1</span> Event Study</a></li>
  <li><a href="#sec-did-placebo" id="toc-sec-did-placebo" class="nav-link" data-scroll-target="#sec-did-placebo"><span class="header-section-number">2.3.2</span> Placebo Tests</a></li>
  </ul></li>
  <li><a href="#staggered-did" id="toc-staggered-did" class="nav-link" data-scroll-target="#staggered-did"><span class="header-section-number">2.4</span> Staggered DID</a></li>
  </ul></li>
  <li><a href="#arima" id="toc-arima" class="nav-link" data-scroll-target="#arima"><span class="header-section-number">3</span> ARIMA</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">3.1</span> Overview</a></li>
  <li><a href="#modeling-1" id="toc-modeling-1" class="nav-link" data-scroll-target="#modeling-1"><span class="header-section-number">3.2</span> Modeling</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction"><span class="header-section-number">3.3</span> Prediction</a></li>
  <li><a href="#residuals-1" id="toc-residuals-1" class="nav-link" data-scroll-target="#residuals-1"><span class="header-section-number">3.4</span> Residuals</a></li>
  <li><a href="#stationarity" id="toc-stationarity" class="nav-link" data-scroll-target="#stationarity"><span class="header-section-number">3.5</span> Stationarity</a></li>
  <li><a href="#darimax" id="toc-darimax" class="nav-link" data-scroll-target="#darimax"><span class="header-section-number">3.6</span> DARIMAX</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Practical Econometrics with R</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Econometrics</div>
  </div>
  </div>



<div class="quarto-title-meta column-page-right">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="lm" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> LM</h1>
<section id="sec-lm-overview" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sec-lm-overview"><span class="header-section-number">1.1</span> Overview</h2>
<section id="description" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="description"><span class="header-section-number">1.1.1</span> Description</h3>
<p>首先调取如下的工具包，暂时不做过多解释，每个都有其独特的功能，后续章节会逐步用到它们。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install and load pacman</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># load all common packages</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    palmerpenguins, tidyverse, modelsummary, flextable, ggdag, dagitty, </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    ggsci, ivreg, marginaleffects, scales, pandoc, car, broom, nortest, </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    lmtest, patchwork, sandwich, GGally, fixest, ggfixest, fpp3, ggforce, </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    urca, readxl, writexl, tidyquant, PortfolioAnalytics, tsgarch, equatags, </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    ROI.plugin.quadprog, ROI.plugin.glpk, here</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>我们直接讨论基础的多元回归，导入 <code>tidyverse</code> 调用 <code>penguins</code> 数据组并且进行标准化，随机选择 10 行数据进行观测，我们不在乎这个数据具体数值内容，而是从列的角度看待数据。列 columns 也可以被称为变量 variables，而行 rows 也可以被称为观测 observations；变量一般包括数值型 numeric (1,2,3)，分类型 catgorical (CHN, USA, UK, JPN)，时间型 temporal (2025-1-4, 12:31:44), 字符型 string (Jordan, Kobe, James) 等基本分类，不同的编程语言都有大同小异的处理方法，暂不深入展开。本案数据组 <code>pegs</code> 有 7 列，包括 3 个分类变量和 4 个数值变量，结构清晰简单，很适合初学。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clean data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pegs <span class="ot">=</span> (</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    penguins <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        species,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        island,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        sex,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">bill_length =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(bill_length_mm)),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">bill_depth =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(bill_depth_mm)),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">flipper_length =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(flipper_length_mm)),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">body_mass =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(body_mass_g)),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>()</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># show sample</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Sample of Penguins"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_8jpqgdxv4jyu4u2yw6wi(i, j, css_id) {
          var table = document.getElementById("tinytable_8jpqgdxv4jyu4u2yw6wi");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_8jpqgdxv4jyu4u2yw6wi(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_8jpqgdxv4jyu4u2yw6wi");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '10', j: 5 }, { i: '10', j: 4 }, { i: '10', j: 3 }, { i: '10', j: 2 }, { i: '10', j: 1 }, { i: '10', j: 0 }, { i: '10', j: 6 },  ], css_id: 'tinytable_css_gft04ezrlvz75whz49bj',}, 
          { positions: [ { i: '2', j: 0 }, { i: '4', j: 0 }, { i: '6', j: 0 }, { i: '8', j: 0 }, { i: '1', j: 2 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '1', j: 0 }, { i: '4', j: 1 }, { i: '3', j: 0 }, { i: '6', j: 1 }, { i: '5', j: 0 }, { i: '8', j: 1 }, { i: '7', j: 0 }, { i: '1', j: 3 }, { i: '9', j: 0 }, { i: '3', j: 3 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '3', j: 1 }, { i: '6', j: 2 }, { i: '5', j: 1 }, { i: '8', j: 2 }, { i: '7', j: 1 }, { i: '1', j: 4 }, { i: '9', j: 1 }, { i: '3', j: 4 }, { i: '2', j: 3 }, { i: '5', j: 4 }, { i: '4', j: 3 }, { i: '5', j: 3 }, { i: '6', j: 3 }, { i: '5', j: 2 }, { i: '8', j: 3 }, { i: '7', j: 2 }, { i: '1', j: 5 }, { i: '9', j: 2 }, { i: '3', j: 5 }, { i: '2', j: 4 }, { i: '5', j: 5 }, { i: '4', j: 4 }, { i: '7', j: 5 }, { i: '6', j: 4 }, { i: '7', j: 4 }, { i: '8', j: 4 }, { i: '7', j: 3 }, { i: '1', j: 6 }, { i: '9', j: 3 }, { i: '3', j: 6 }, { i: '2', j: 5 }, { i: '5', j: 6 }, { i: '4', j: 5 }, { i: '7', j: 6 }, { i: '6', j: 5 }, { i: '9', j: 6 }, { i: '8', j: 5 }, { i: '9', j: 5 }, { i: '9', j: 4 }, { i: '2', j: 6 }, { i: '4', j: 6 }, { i: '6', j: 6 }, { i: '8', j: 6 },  ], css_id: 'tinytable_css_li5eehpw0qoumvxy70mw',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 6 }, { i: '0', j: 5 }, { i: '0', j: 4 }, { i: '0', j: 3 }, { i: '0', j: 2 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_u5t6d873pza3m8d0jic7',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_8jpqgdxv4jyu4u2yw6wi(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_gft04ezrlvz75whz49bj, .table th.tinytable_css_gft04ezrlvz75whz49bj { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_li5eehpw0qoumvxy70mw, .table th.tinytable_css_li5eehpw0qoumvxy70mw { text-align: left; }
      .table td.tinytable_css_u5t6d873pza3m8d0jic7, .table th.tinytable_css_u5t6d873pza3m8d0jic7 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_8jpqgdxv4jyu4u2yw6wi" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Sample of Penguins</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">species</th>
                <th scope="col" data-row="0" data-col="1">island</th>
                <th scope="col" data-row="0" data-col="2">sex</th>
                <th scope="col" data-row="0" data-col="3">bill_length</th>
                <th scope="col" data-row="0" data-col="4">bill_depth</th>
                <th scope="col" data-row="0" data-col="5">flipper_length</th>
                <th scope="col" data-row="0" data-col="6">body_mass</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">Gentoo</td>
                  <td data-row="1" data-col="1">Biscoe</td>
                  <td data-row="1" data-col="2">male</td>
                  <td data-row="1" data-col="3">1.19</td>
                  <td data-row="1" data-col="4">-0.73</td>
                  <td data-row="1" data-col="5">1.50</td>
                  <td data-row="1" data-col="6">1.93</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">Adelie</td>
                  <td data-row="2" data-col="1">Torgersen</td>
                  <td data-row="2" data-col="2">male</td>
                  <td data-row="2" data-col="3">0.03</td>
                  <td data-row="2" data-col="4">0.43</td>
                  <td data-row="2" data-col="5">0.65</td>
                  <td data-row="2" data-col="6">-0.25</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">Chinstrap</td>
                  <td data-row="3" data-col="1">Dream</td>
                  <td data-row="3" data-col="2">female</td>
                  <td data-row="3" data-col="3">-0.08</td>
                  <td data-row="3" data-col="4">0.48</td>
                  <td data-row="3" data-col="5">0.08</td>
                  <td data-row="3" data-col="6">-1.00</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Gentoo</td>
                  <td data-row="4" data-col="1">Biscoe</td>
                  <td data-row="4" data-col="2">male</td>
                  <td data-row="4" data-col="3">0.40</td>
                  <td data-row="4" data-col="4">-1.04</td>
                  <td data-row="4" data-col="5">1.00</td>
                  <td data-row="4" data-col="6">1.12</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">Adelie</td>
                  <td data-row="5" data-col="1">Dream</td>
                  <td data-row="5" data-col="2">male</td>
                  <td data-row="5" data-col="3">-1.12</td>
                  <td data-row="5" data-col="4">0.48</td>
                  <td data-row="5" data-col="5">-0.56</td>
                  <td data-row="5" data-col="6">-0.56</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">Chinstrap</td>
                  <td data-row="6" data-col="1">Dream</td>
                  <td data-row="6" data-col="2">male</td>
                  <td data-row="6" data-col="3">0.97</td>
                  <td data-row="6" data-col="4">0.53</td>
                  <td data-row="6" data-col="5">-0.42</td>
                  <td data-row="6" data-col="6">0.25</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">Chinstrap</td>
                  <td data-row="7" data-col="1">Dream</td>
                  <td data-row="7" data-col="2">male</td>
                  <td data-row="7" data-col="3">1.61</td>
                  <td data-row="7" data-col="4">1.34</td>
                  <td data-row="7" data-col="5">-0.28</td>
                  <td data-row="7" data-col="6">-0.59</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">Chinstrap</td>
                  <td data-row="8" data-col="1">Dream</td>
                  <td data-row="8" data-col="2">female</td>
                  <td data-row="8" data-col="3">-0.55</td>
                  <td data-row="8" data-col="4">-0.28</td>
                  <td data-row="8" data-col="5">-0.99</td>
                  <td data-row="8" data-col="6">-1.25</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">Gentoo</td>
                  <td data-row="9" data-col="1">Biscoe</td>
                  <td data-row="9" data-col="2">male</td>
                  <td data-row="9" data-col="3">0.23</td>
                  <td data-row="9" data-col="4">-0.38</td>
                  <td data-row="9" data-col="5">1.57</td>
                  <td data-row="9" data-col="6">2.18</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">Gentoo</td>
                  <td data-row="10" data-col="1">Biscoe</td>
                  <td data-row="10" data-col="2">male</td>
                  <td data-row="10" data-col="3">0.09</td>
                  <td data-row="10" data-col="4">0.08</td>
                  <td data-row="10" data-col="5">1.29</td>
                  <td data-row="10" data-col="6">1.31</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>我们通过 <code>ggplot</code> 绘图，对数据的分布进行初步观察，通过 boxchart 观察一个数值变量在多个分类变量当中的分布情况，通过 density plot 观察数值变量在多个分类变量当中的密度分布情况，通过 scatter plot 观察两个数值变量在多个分类变量之间的相关性。当然还有很多其他类型的图表，但这三种是学术论文当中最常见的类型，我们暂时先掌握这几个核心图表，后续在其他课程中再讨论其他类型的图表。下图提醒以下特征：</p>
<ul>
<li><code>flipper_length</code> 在三个 <code>species</code> 当中分布基本均匀，且 <code>Gentoo</code> 的 <code>flipper_length</code> 明显高于另外两个 <code>species</code>；<code>Adelie</code> 和 <code>Chinstrap</code> 之间虽然有差异，但是差异较小。</li>
<li><code>body_mass</code> 在三个 <code>species</code> 当中分布也基本均匀，且 <code>Gentoo</code> 的 <code>body_mass</code> 明显高于另外两个 <code>species</code>；<code>Adelie</code> 和 <code>Chinstrap</code> 之间虽然有差异，但是差异较小。</li>
<li><code>body_mass</code> 很明显受到 <code>flipper_length</code> 的影响，即随着 <code>flipper_length</code> 的增加，<code>body_mass</code> 也增加，并且该特征在多个 <code>species</code> 当中保持基本稳定；或者说 <code>flipper_length</code> 和 <code>body_mass</code> 之间具有较强的正相关性。</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot box figure</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sub1 <span class="ot">=</span> (</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> species, <span class="at">y =</span> flipper_length, <span class="at">fill =</span> species)) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_iterm</span>() <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Species"</span>, <span class="at">y =</span> <span class="st">"Flipper Length"</span>, <span class="at">title =</span> <span class="st">"Boxchart"</span>) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot KDE figure</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>sub2 <span class="ot">=</span> (</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> body_mass, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Body Mass"</span>, <span class="at">y =</span> <span class="st">"Density"</span>, <span class="at">title =</span> <span class="st">"KDE"</span>) <span class="sc">+</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># plot scatter figure</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>sub3 <span class="ot">=</span> (</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bill_length, <span class="at">y =</span> body_mass, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Bill Length"</span>, <span class="at">y =</span> <span class="st">"Body Mass"</span>, <span class="at">title =</span> <span class="st">"Scatter"</span>) <span class="sc">+</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into single figure</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>(sub1, sub2, sub3) <span class="sc">+</span> </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Fig 2.1: Sample of Penguins"</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-3-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="econ_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="correlation" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="correlation"><span class="header-section-number">1.1.2</span> Correlation</h3>
<p>一个标准的多元回归模型可以用矩阵表示为：</p>
<p><span class="math display">\[
\mathbf{Y} = \mathbf{X} \mathbf{B} + \mathbf{e}
\]</span></p>
<p>其中</p>
<ul>
<li><span class="math inline">\(\mathbf{Y}\)</span> 是因变量，即输出的结果。</li>
<li><span class="math inline">\(\mathbf{X}\)</span> 是自变量，即输入的原因。</li>
<li><span class="math inline">\(\mathbf{B}\)</span> 是回归系数，即自变量对于因变量的影响程度大小。</li>
<li><span class="math inline">\(\mathbf{e}\)</span> 是残差项，即预测模型与真实模型的差异程度。</li>
</ul>
<p>我们不深入展开公式的历史背景，继续往下推，它等价的广义算法模型就是 ：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="at">formula =</span> Y <span class="sc">~</span> X, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>回到本案，我们建立一个简单的多元回归模型，即通过 <code>flipper_length</code> 和 <code>species</code> 两个自变量来预测企鹅的 <code>body_mass</code>。此时，传统教科书会进行一大堆抽象的数学公式计算，但我觉得数学证明对经管同学并不是很有必要。牢记“我们是乘坐飞机的乘客而不是驾驶飞机的飞行员”这个根本原则，抓住重点、纲举目张、不要陷入数学迷宫无法自拔；因此我们不会手搓数学而是直接调用 <code>R</code> 进行计算，如果得到 <span class="math inline">\(p &lt; 0.05\)</span>，那么就是显著影响；反之那么就没有显著影响；对理论背景有兴趣的同学可以参考 <span class="citation" data-cites="Angrist2009">(<a href="#ref-Angrist2009" role="doc-biblioref"><strong>Angrist2009?</strong></a>)</span>, <span class="citation" data-cites="Stock2018">(<a href="#ref-Stock2018" role="doc-biblioref"><strong>Stock2018?</strong></a>)</span>, <span class="citation" data-cites="Wooldridge2019">(<a href="#ref-Wooldridge2019" role="doc-biblioref"><strong>Wooldridge2019?</strong></a>)</span>, <span class="citation" data-cites="Gujarati2020">(<a href="#ref-Gujarati2020" role="doc-biblioref"><strong>Gujarati2020?</strong></a>)</span>。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pegs_mod1 <span class="ot">=</span> <span class="fu">lm</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">+</span> species, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>代码运算完成后显示，三个主要变量都显著 (<span class="math inline">\(p &lt; 0.05\)</span>)，这意味着模型总体上具有很好的结果，即 <code>flipper_lengh</code> 的变化会导致 <code>body_mass</code> 的变化；<code>species</code> 是分类变量而不是数值变量，因此应该描述为“企鹅从 A 种类变为 B 种类后，体重也会随之变化 X 个单位”；至于它们具体的回归参数数值大小和 <code>R2, AIC, BIC, F, RMSE</code> 等参数，我们暂不解释。这个显著结果对于普通本科同学的论文就基本足够了，但是对于硕士同学是不足够的，我们还需要进一步研究一些深度的问题。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit models</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pegs_mod1 <span class="ot">=</span> <span class="fu">lm</span>(body_mass <span class="sc">~</span> flipper_length <span class="sc">+</span> species, <span class="at">data =</span> pegs)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># show model summary</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> pegs_mod1, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">stars =</span> <span class="cn">TRUE</span>, </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">coef_omit =</span> <span class="st">"Intercept"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Summary of pegs_mod1"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_ldqp55vs0l3wbu5nsh89(i, j, css_id) {
          var table = document.getElementById("tinytable_ldqp55vs0l3wbu5nsh89");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_ldqp55vs0l3wbu5nsh89(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_ldqp55vs0l3wbu5nsh89");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '11', j: 1 },  ], css_id: 'tinytable_css_5yaokkfjbsrh79vi6dfo',}, 
          { positions: [ { i: '3', j: 1 },  ], css_id: 'tinytable_css_jyid9uprlfkq5epamfj2',}, 
          { positions: [ { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '7', j: 1 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '8', j: 1 }, { i: '9', j: 1 }, { i: '10', j: 1 },  ], css_id: 'tinytable_css_rlikazynxqmjzlbcu4vl',}, 
          { positions: [ { i: '0', j: 1 },  ], css_id: 'tinytable_css_c0f9rvwhur8vadl2a9d4',}, 
          { positions: [ { i: '11', j: 0 },  ], css_id: 'tinytable_css_owg2cjk459qfh3bykdyl',}, 
          { positions: [ { i: '3', j: 0 },  ], css_id: 'tinytable_css_5y3dnfugqb5yjaeftx30',}, 
          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '7', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '8', j: 0 }, { i: '9', j: 0 }, { i: '10', j: 0 },  ], css_id: 'tinytable_css_8dh9q8fnol17e79ur976',}, 
          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_maio1607odr2vy065xxz',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_ldqp55vs0l3wbu5nsh89(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_5yaokkfjbsrh79vi6dfo, .table th.tinytable_css_5yaokkfjbsrh79vi6dfo { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_jyid9uprlfkq5epamfj2, .table th.tinytable_css_jyid9uprlfkq5epamfj2 { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_rlikazynxqmjzlbcu4vl, .table th.tinytable_css_rlikazynxqmjzlbcu4vl { text-align: center; }
      .table td.tinytable_css_c0f9rvwhur8vadl2a9d4, .table th.tinytable_css_c0f9rvwhur8vadl2a9d4 { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_owg2cjk459qfh3bykdyl, .table th.tinytable_css_owg2cjk459qfh3bykdyl { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_5y3dnfugqb5yjaeftx30, .table th.tinytable_css_5y3dnfugqb5yjaeftx30 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_8dh9q8fnol17e79ur976, .table th.tinytable_css_8dh9q8fnol17e79ur976 { text-align: left; }
      .table td.tinytable_css_maio1607odr2vy065xxz, .table th.tinytable_css_maio1607odr2vy065xxz { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_ldqp55vs0l3wbu5nsh89" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Summary of pegs_mod1</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0"> </th>
                <th scope="col" data-row="0" data-col="1">(1)</th>
              </tr>
        
        </tbody><tfoot><tr><td colspan="2">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr></tfoot>
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">flipper_length</td>
                  <td data-row="1" data-col="1">0.712***</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">speciesChinstrap</td>
                  <td data-row="2" data-col="1">-0.256***</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">speciesGentoo</td>
                  <td data-row="3" data-col="1">0.355**</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Num.Obs.</td>
                  <td data-row="4" data-col="1">333</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">R2</td>
                  <td data-row="5" data-col="1">0.787</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">R2 Adj.</td>
                  <td data-row="6" data-col="1">0.785</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">AIC</td>
                  <td data-row="7" data-col="1">441.7</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">BIC</td>
                  <td data-row="8" data-col="1">460.7</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">Log.Lik.</td>
                  <td data-row="9" data-col="1">-215.845</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">F</td>
                  <td data-row="10" data-col="1">405.281</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="0">RMSE</td>
                  <td data-row="11" data-col="1">0.46</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot model coefficients</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    pegs_mod1 <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">modelplot</span>(<span class="at">coef_omit =</span> <span class="st">"Intercept"</span>) <span class="sc">+</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Estimate and 95% CI"</span>, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Fig 2.2: Summary of pegs_mod1"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-4-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="econ_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="causalty" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="causalty"><span class="header-section-number">1.1.3</span> Causalty</h3>
<p>相关性 Correlation 是计量经济学的起点，但仅有相关性是不够严谨的，更重要的是因果性 Causality。从法学的角度来讨论，张明楷老师在《刑法学》提出：“因果关系是引起与被引起的关系，前者是后者的原因，后者是前者的结果。”因果关系的理论存在比较复杂的讨论，张明楷老师偏向于认同主流的“条件说”：如果没有 X，就必然不会有 Y，那么 X 是 Y 的原因，Y 是 X 的结果。这个原理很容易理解，假如张三用刀把李四杀死，那么“张三用刀捅杀”是“李四死亡”的必要原因，“李四死亡”是“张三用刀捅杀”的危害结果；反之，如果没有“张三用刀”，那么就不会有“李四死亡”的危害结果，这就是典型的因果关系<span class="citation" data-cites="Zhang2024">(<a href="#ref-Zhang2024" role="doc-biblioref"><strong>Zhang2024?</strong></a>)</span>。但是刑事案件往往不会这么简单，而是多个原因共同地、动态地、复杂地发生作用，最终导致了严重法益侵害结果。我们请出“法外狂徒张三”带来以下几个小案例：</p>
<ul>
<li>张三欲杀害李四，尾随李四下夜班，到路口用水果刀朝着李四胸口捅了几刀，李四倒地；张三认为李四已经死了，便逃离现场，但李四只是装死而没有真的死亡，10 分钟后，李四爬起来正准备打 110 和 120 报警急救，却被酒后驾驶汽车的王五撞倒；李四多处骨折受重伤，王五逃逸，几小时后路人发现血泊中的李四，送医院抢救，但不治身亡。</li>
<li>张三欲杀害李四，在一起打牌时，张三乘机把李四喝的饮用水换成无色无味的剧毒鹤顶红，所有人都不知情；王五突然说口渴想喝水，李四就自然而然地把自己的水给王五喝，张三见状大喊：“哎别喝那个，我这有更好的”，王五不以为然：“没事，我跟李四发小儿，来打牌打牌”；王五一饮而尽，半小时后毒药起效，心脏骤停，王五当场毙命。</li>
<li>张三欲杀害李四，将李四汽车的刹车线剪断，希望李四在高速公路发生交通事故而身亡；李四在高速行驶中，因为刹车失灵，撞上另外的汽车，导致汽车翻个底朝天，司机王五被困在车中无法解救，汽车起火迅速燃烧，李四尝试拯救也无能为力；司机王五被烧死在车里，而李四的车辆虽然受到严重损毁，但他本人并未受到严重的人身伤害。</li>
</ul>
<p>这一系列都是法哲学对于“原因——结果”的深入思考，它们原理对于后期掌握复杂的因果推断和各种假设大有裨益，但有一个主要区别。刑法所讨论的“因果关系”是定性的而非定量的，而经济学讨论的“因果关系”是统计意义上的定量的而非定性的。我们不问：“如果没有 X，是否必然不会发生 Y 的结果”，而是问：“在保持其他因素不变的情况下，X 的变化对 Y 的平均影响有多大？”。换言之，在刑法上，张三朝李四胸口捅了一刀，就构成故意杀人罪，假如张三捅十刀，依然只能构成一个故意杀人罪，而不会构成十个故意杀人罪；在经济学上，张三捅一刀导致李四死亡的概率必然远小于捅十刀致死的概率。一个法官需要确认的是：“张三是否真的朝着李四捅了这一刀？”而一个经济学家需要确认的是：“张三捅的第几刀是导致李四死亡的最关键伤害？”</p>
<p>有点复杂了，先刹车，回到经济学当中。我们通过 <code>R</code> 当中强大的包 <a href="https://r-causal.github.io/ggdag/index.html"><code>ggdag</code></a>，很方便地绘制 DAG 图，以非常明确的方式对“因果推断 Causal Inference” 进行抽象维度的理解。具体而言，本案例有两个自变量，即原因 <code>flipper_length, specie</code>，可以认为分别是 <span class="math inline">\((X1, X2)\)</span>；同时本案有一个因变量，即结果 <code>body_mass</code>，可以认为是 <span class="math inline">\(Y\)</span>。那么，假设本案例当中没有任何其他的干扰因素，即“有且仅有 2 个原因，它们导致了 1 个结果”，那么本案的因果关系便是 <span class="math inline">\((X1, X2) \to Y\)</span>，其 DAG 图如下。需要注意的是，这个假设是很理想注意的假设，实际情况下一定存在未知的干扰因素，而且这样的干扰因素往往会造成严重的结果偏差，具体我们会在后续讨论。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a DAG</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dag1 <span class="ot">=</span> <span class="fu">dagitty</span>(<span class="st">"dag {</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="st">    X1 -&gt; Y</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="st">    X2 -&gt; Y</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># set coordinates</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag1) <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="at">X1 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">X2 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">0</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">X1 =</span> <span class="dv">1</span>,  <span class="at">X2 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">0</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the DAG</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggdag</span>(dag1, <span class="at">node =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dag_text</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dag_edges</span>(<span class="at">edge_colour =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Fig 2.3: DAG of Simple LM"</span>) <span class="sc">+</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_dag_grid</span>() <span class="sc">+</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-5-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="econ_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
<p>根据这个 DAG 图，有以下几个问题需要我们深入思考：</p>
<ul>
<li>回归系数 Coefficients：<code>flipper_length</code> 对于 <code>body_mass</code> 的促进或者抑制作用具体是多少？即，假如 <code>flipper_length</code> 增加或减少一个单位，<code>body_mass</code> 会增加或减少多少？</li>
<li>内生性 Endogeneity：<code>flipper_length</code> 对于 <code>body_mass</code> 的促进或者抑制作用是否还有其他的影响因素？即，我们当前假设是 <code>flipper_length</code> 导致 <code>body_mass</code>，但是否有可能是 <code>unknown_var</code> 同时影响了 <code>flipper_length</code> 和 <code>body_mass</code>？或者 <code>flipper_length</code> 同时影响了 <code>unknown_var</code> 和 <code>body_mass</code>？我们的模型是否可能遗漏了一些重要变量，或者把一个并没有本质关系的变量牵强地让它成为了一个相关变量？</li>
<li>异质性 Heterogeneity：在不同的 <code>species</code> 之间，上述的相关性是否会发生变化？即，假如 <code>Adelie</code> 的促进作用是 1.67，那么 <code>Chinstrap</code> 和 <code>Gentoo</code> 的促进作用分别是多少？它们的促进作用是大于 1.67 还是小于 1.67 ？一个适用于所有群体的平均结论，是否掩盖了某些特定群体的重要特征？吃大锅饭的一群人当中，总有一些雷锋同志，也总有一些南郭先生，我们如何将其分辨出来？</li>
<li>稳健性 Robustness：模型完成后，通过什么方法检测模型本身的正确性和严谨性？即，模型是否满足 Gauss-Markov 所提出的经典假设 <a href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Markov_theorem">Best Linear Unbiased Estimator (BLUE)</a>? 我们得到的这个显著结果是否可能只是巧合，而不是严格的因果关系？假如我们经过艰难险阻，只能得到一个边缘显著的模型 <span class="math inline">\(0.050 &lt; p &lt; 0.060\)</span>，那这个结果是应该接受还是拒绝？</li>
</ul>
<p>以上几个问题分别对应了应用计量经济学的几个不同的层次，它们以铰链的形式共同构成了一个完整的“因果推断”分析流程，将一个简单线性回归的结论逐渐加深加强，将证据效力从“它小概率是这样”推到“它大概率是这样”最后推到“它很大概率是这样”的维度。因果推断是计量经济学的高级内容，它原本不应该出现的这么早，我故意将其在此处先埋个线索，以便更方便、更快捷、更高效地衔接上下文；但是因果关系的数学部分非常复杂，因此我们不展开理论部分，而是直接介绍原理然后跳入实战，以战养兵、战练结合。对理论部分很感兴趣的博士同学可以参考该领域的权威且前沿的文献 <span class="citation" data-cites="Imbens2015">(<a href="#ref-Imbens2015" role="doc-biblioref"><strong>Imbens2015?</strong></a>)</span>，非博士同学普遍没必要深入阅读因果推断的文献。</p>
</section>
</section>
<section id="sec-lm-endogenity" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="sec-lm-endogenity"><span class="header-section-number">1.2</span> Endogeneity</h2>
<section id="definition" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="definition"><span class="header-section-number">1.2.1</span> Definition</h3>
<p>我们已经完成了一个古典回归模型，即结果 <code>body_mass</code> 完全是由原因 <code>flipper_length, species</code> 所导致；换言之，<code>body_mass</code> 没有受到其他因素如 <code>flipper_depth, island, sex</code> 等的影响。但这个模型是不严谨的，它基于一个过于理想主义的假设，即，本模型的因果链条当中没有任何其他外界干扰因素；用学术词语表示为，本模型所有的自变量都是“外生的”，本模型中没有“内生的”自变量。此时我们需要对“外生性 Exogeneity”和“内生性 Endogeneity”进行简要解释。</p>
<ul>
<li>外生性 Exgeneity: 自变量跟误差项几乎没有相关性 <span class="math inline">\(\text{Cov}(X, \epsilon) = 0\)</span>，结果是由该原因所导致。</li>
<li>内生性 Endogeneity: 自变量跟误差项有一定相关性 <span class="math inline">\(\text{Cov}(X, \epsilon) \neq 0\)</span>，结果并不是完全由该原因所致，还有其他原因共同影响。</li>
</ul>
<p>“外生性假设”大幅度地简化了数学运算和算法逻辑，但它忽略了一个不可能避免的现实问题，即模型的自变量至少有一些是内生的；在真实的世界里，很少存在某个事件是绝对外生性的，大部分事件都是由多个复杂因素共同作用而成。经济学家往往处于简化角度，将复杂事件想当然地认为是 <code>X -&gt; Y</code>，但是这样的归纳方式很容易得出一个“高度显著但是一派胡言”的结论。这就是内生性所导致的典型偏误，它是所有计量经济学模型所需要面临的第一个严峻挑战，许多经典文献进行了深度讨论，如 <span class="citation" data-cites="Theil1958">(<a href="#ref-Theil1958" role="doc-biblioref"><strong>Theil1958?</strong></a>)</span>, <span class="citation" data-cites="Sargan1958">(<a href="#ref-Sargan1958" role="doc-biblioref"><strong>Sargan1958?</strong></a>)</span>, <span class="citation" data-cites="Tinbergen1959">(<a href="#ref-Tinbergen1959" role="doc-biblioref"><strong>Tinbergen1959?</strong></a>)</span>, <span class="citation" data-cites="Hausman1978">(<a href="#ref-Hausman1978" role="doc-biblioref"><strong>Hausman1978?</strong></a>)</span>, <span class="citation" data-cites="Imbens1994">(<a href="#ref-Imbens1994" role="doc-biblioref"><strong>Imbens1994?</strong></a>)</span>, <span class="citation" data-cites="Staiger1997">(<a href="#ref-Staiger1997" role="doc-biblioref"><strong>Staiger1997?</strong></a>)</span>。</p>
<p>既然明白了内生性的弊端，接下来就必须讨论如何解决它，一个比较符合硕博阶段的方法是通过“工具变量 Instrument Variables, Z”来处理。然而要构建一组好的工具变量并不容易，因为它的因果关系链条受到严格限制，它只能是 <code>Z -&gt; X -&gt; Y</code>，而不能是任何其他的路径；即，它必须满足以下两个必要条件。</p>
<ul>
<li>相关性 Relevance: 工具变量必须与内生变量显著相关，即 <span class="math inline">\(\text{Cov}(Z, X) \neq 0\)</span>。</li>
<li>排他性 Exclusion: 工具变量不能与因变量或误差项有相关性，即 <span class="math inline">\(\text{Cov}(Z, Y) = \text{Cov}(Z, \epsilon) = 0\)</span>。</li>
</ul>
<p>我们现在通过 DAG 图解释最基础的 2SLS 原理，下图中的 <code>X -&gt; Y</code> 衍生出了两个新的变量 <code>U, Z</code>：</p>
<ul>
<li><code>U</code> 代表未知的协同变量 (Unknown Cofounders)，它们必须同时影响 <code>X</code> 和 <code>Y</code>，但是它永远无法具体计算，因此我们无法知道它对于 <code>X</code> 和 <code>Y</code> 的影响的具体数值是多少，但我们也并不关心这个；同时需要注意 <code>U</code> 不能影响 <code>Z</code>，否则工具变量就失效了。</li>
<li><code>Z</code> 代表工具变量 (Instrument Variables)，它们只影响 <code>X</code> 再传递到 <code>Y</code>；特别注意 <code>Z</code> 不能直接影响 <code>Y</code> 或 <code>U</code>，这是工具变量成立的必要条件。另外，工具变量的数量必须大于等于内生变量的数量，否则算法会报错无法执行。</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a DAG for 2SLS</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dag3 <span class="ot">=</span> <span class="fu">dagitty</span>(<span class="st">"dag{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">    Z -&gt; X -&gt; Y;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; X;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; Y;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># set coordinates for variables</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag3) <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">0</span>, <span class="at">X =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">Z =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">U =</span> <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">0</span>, <span class="at">X =</span> <span class="dv">0</span>,  <span class="at">Z =</span> <span class="dv">0</span>,  <span class="at">U =</span> <span class="dv">1</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot DAG of 2SLS</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggdag</span>(dag3, <span class="at">node =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dag_text</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dag_edges</span>(<span class="at">edge_color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Fig 2.4 DAG of 2SLS"</span>) <span class="sc">+</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_dag_grid</span>() <span class="sc">+</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="econ_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="solution" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="solution"><span class="header-section-number">1.2.2</span> Solution</h3>
<p>我们在前面简要讨论了如何从原理上解决内生性问题，现在介绍如何运用具体的算法完整地实现一个工具变量回归模型，也称 IV-LM 模型，我们需要借用 <a href="https://zeileis.github.io/ivreg"><code>ivreg()</code></a> 包以及内部的 Two-Stage Least Square, 2SLS 原理，其细节比较复杂，继续战略性跳过，有兴趣的同学请参考官网。简而言之，2SLS 包括两个阶段，第一阶段是 Purification，第二阶段是 Estimation，他们共同作用完成对内生变量的剥离和对模型的修正。</p>
<p>第一阶段是 Purification，因为我们模型中的内生变量 <code>X</code> 是“污染的、不纯粹的、有杂质的”变量，因此需要一个工具变量 <code>Z</code>，它起到过滤器的作用，将内生变量的“污染物、杂质、杂音”过滤出去，只保留当中“纯洁、干净、有效的”内容。因此，这个工具变量的“相关性”就非常重要，当且仅当工具变量对内生自变量是强显著和关联的情况下，这个工具变量才具有“过滤污染物”的能力，否则这个工具变量就没有任何意义；但是我们也必须保证工具变量跟干净的结果之间没有相关性，否则就会由于工具变量而干扰了结果，那样我们就无法判断结果到底是由于内生变量所致还是工具变量所致。即，工具变量生效的必要条件是：</p>
<p><span class="math display">\[
\begin{aligned}
\text{Cov}(Z, X) &amp; \neq 0 \\
\text{Cov}(Z, Y) &amp; = \text{Cov}(Z, \epsilon) = 0
\end{aligned}
\]</span></p>
<p>此时可以带入第一阶段，得到公式：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fitsr_stage <span class="ot">=</span> <span class="fu">lm</span>(<span class="at">formula =</span> X <span class="sc">~</span> Z, <span class="at">data =</span> df)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>X_hat <span class="ot">=</span> <span class="fu">predict</span>(<span class="fu">lm</span>(<span class="at">formula =</span> X <span class="sc">~</span> Z, <span class="at">data =</span> df))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>第二阶段 Estimation，我们需要计算自变量的预测值 <code>X_hat</code> 对于因变量 <code>Y</code> 的显著性，意义在于，当内生变量的“污染物”被剥离出去以后，模型对一个“干净”的因变量能否依然保持强相关性、因果性、解释性？如果此时结果依然显著，那就皆大欢喜、打卡下班；但如果结果不显著，那我们必须继续调整工具变量，然后多次尝试直到搭配出一套满意的组合。总体来说，第二阶段比第一阶段更简单、更直观，但是它的结果必须建立在第一阶段的显著结果之上；如果第一阶段不显著，那么即使第二阶段显著，也没有说服力；但是如果第一阶段显著，而第二阶段不显著，也具有一定说服力，只是这样的情况容易被审稿人盯上；当然最美好的结果是第一阶段和第二阶段都显著。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>second_stage <span class="ot">=</span> <span class="fu">lm</span>(<span class="at">formula =</span> Y <span class="sc">~</span> X_hat, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>虽然这两个 <code>lm()</code> 原理上是正确的，但我们并不能手动分两步计算 2SLS，因为这样做会得到错误的置信区间和 p 值；跳过复杂的数学原理，最科学的方案是直接使用 <code>ivreg()</code> 计算，它会在内部完成这两个步骤并自动修正第二阶段的标准误偏差，其表达如下。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>iv_mod <span class="ot">=</span> <span class="fu">ivreg</span>(<span class="at">formula =</span> Y <span class="sc">~</span> X <span class="sc">|</span> Z, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>这个函数返回一个复杂的合并结果，但是并未提供独立的结果，因此我们必须曲线救国，编写两个简单的调用函数分别提取不同阶段的回归结果，再整理成干净表格。虽然有点绕，但是由于 <code>tidyverse</code> 奠定了强大的底层处理流程，因此整段代码的思路很清晰。其中第一个阶段结果包括以下几项：</p>
<ul>
<li><code>Weak Instrument Test</code>：检验工具变量是否显著相关，若显著则说明工具变量有效，反之则无效。</li>
<li><code>Wu-Hausman Test</code>：检验模型是否存在内生性，若显著则说明存在内生性，需要使用工具变量进行控制，反之则不需要。</li>
<li><code>Sargan Test</code>：检验工具变量是否满足外生性条件，若显著则说明工具变量是无效的，反之则说明工具变量是有效的。</li>
</ul>
<p>略过证明细节，我们希望 <code>WI</code> 显著、<code>WH</code> 显著、<code>Sargan</code> 不显著，即可证明原模型是有内生性问题的、工具变量才是有效的、模型才是严谨的。第二阶段追求的结果与普通的线性模型结果类似，主要关注回归系数、显著性、标准误即可。至此，我们已经从概念上完成了一个 IV 模型的主要流程，本小节的内容不可避免的比较抽象，同学们如果感觉不太清楚也无所谓，我们继续用案例加深实际理解；跑完案例再回过头复习此处的抽象内容，相信大家会更加清楚。</p>
</section>
<section id="case-study" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="case-study"><span class="header-section-number">1.2.3</span> Case Study</h3>
<p>我们现在进行案例分析，回到最基础的 <code>pegs_mod1</code> 模型是：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pegs_mod1 <span class="ot">=</span> <span class="fu">lm</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">+</span> species,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>其中自变量是 <code>flipper_length</code> 代表企鹅鳍长，<code>species</code> 代表企鹅种类，结果变量是 <code>body_mass</code> 代表企鹅重量；那么根据我们上一节讨论的内容，假设所有的自变量都是内生变量，即 <code>X = flipper_length, species</code>，再假设工具变量是 <code>Z = bill_depth, island, sex</code>，分别代表企鹅的嘴长度、生活岛屿、性别。即可以得到下面的 DAG 图。特别注意，此处的工具变量严格意义上只能满足第一个条件：相关性，而无法满足第二个必要条件：排斥性。我们此处采纳它们仅仅是出于简化的教学角度，在实战分析中，一定要先检验工具变量的两个缺一不可的必要条件；不能想当然地抓一些变量就拿来充当工具变量，那样非常容易得到 False Positive 的结论。扯远了，回本案例中，我们的 DAG 如下图所示：</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create DAG</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>dag4 <span class="ot">=</span> <span class="fu">dagitty</span>(<span class="st">"dag {</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="st">    Z -&gt; X -&gt; Y</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; X</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; Y</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set coordinates</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag4) <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">2</span>, <span class="at">X =</span> <span class="dv">1</span>, <span class="at">Z =</span> <span class="dv">0</span>, <span class="at">U =</span> <span class="dv">1</span>),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">0</span>, <span class="at">X =</span> <span class="dv">0</span>, <span class="at">Z =</span> <span class="dv">0</span>, <span class="at">U =</span> <span class="dv">1</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># set labels</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>dag4_label <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Y"</span>, <span class="st">"X"</span>, <span class="st">"Z"</span>, <span class="st">"U"</span>),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">c</span>(</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass"</span>, </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length </span><span class="sc">\n</span><span class="st"> species"</span>, </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bill_length </span><span class="sc">\n</span><span class="st"> island </span><span class="sc">\n</span><span class="st"> sex"</span>, </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"U"</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to ggdag type</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>dag4 <span class="ot">=</span> dag4 <span class="sc">%&gt;%</span> <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(dag4_label, <span class="at">by =</span> <span class="st">"name"</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># plot DAG</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggdag</span>(dag4, <span class="at">node =</span> <span class="cn">FALSE</span>, <span class="at">text =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dag_edges</span>(<span class="at">edge_colour =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dag_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> label), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Fig 2.5: DAG of pegs_mod2"</span>) <span class="sc">+</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_dag_grid</span>() <span class="sc">+</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">clip =</span> <span class="st">"off"</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-7-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="econ_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
<p>再根据 DAG 图和 <code>ivreg()</code> 原理，我们构建如下模型；结果显示，第一阶段的 WI 显著（好结果），WH 显著（好结果），Sargan 不显著（好结果）；因此说明我们选择的工具变量是合适的。第二阶段的自变量对于结果具有更强的促进作用，且显著性更高，这说明我们选择的工具变量有效地剥离了内生变量的污染，从而增强了模型的解释力和预测力。因此我们可以认为，原 OLS-LM 具有较强内生性，需要增加工具变量进行调节；新增的工具变量具有较强效果，经工具变量调节后的 IV-LM 具备更高显著性和稳健性。至此，我们系统地完成了一个 2SLS 计算流程。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ivreg</span>(<span class="at">formula =</span> Y <span class="sc">~</span> X <span class="sc">|</span> Z, <span class="at">data =</span> df)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ivreg</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> species <span class="sc">+</span> flipper_length <span class="sc">|</span> bill_depth <span class="sc">+</span> island <span class="sc">+</span> sex, </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create IV model</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>pegs_mod2 <span class="ot">=</span> <span class="fu">ivreg</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> species <span class="sc">+</span> flipper_length  <span class="sc">|</span> bill_depth <span class="sc">+</span> island <span class="sc">+</span> sex,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create UDF to get first stage IV test results</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>get_first_stage_test <span class="ot">=</span> <span class="cf">function</span>(model) {</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    model <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(<span class="at">diagnostics =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">"diagnostics"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"terms"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">pv =</span> <span class="st">`</span><span class="at">p-value</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(terms, statistic, pv) <span class="sc">%&gt;%</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"First Stage Test"</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co"># create UDF to get second stage IV test results</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>get_second_stage_test <span class="ot">=</span> <span class="cf">function</span>(model) {</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    model <span class="sc">%&gt;%</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">"coefficients"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"terms"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">estimate =</span> Estimate, <span class="at">SE =</span> <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span>, <span class="at">pv =</span> <span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(terms, estimate, SE, pv) <span class="sc">%&gt;%</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Second Stage Test"</span>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="co"># show test results</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="fu">get_first_stage_test</span>(pegs_mod2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_b7f61g7yfvtf83qhcu3g(i, j, css_id) {
          var table = document.getElementById("tinytable_b7f61g7yfvtf83qhcu3g");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_b7f61g7yfvtf83qhcu3g(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_b7f61g7yfvtf83qhcu3g");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '5', j: 0 }, { i: '5', j: 1 }, { i: '5', j: 2 },  ], css_id: 'tinytable_css_bty29l0crjxs983sklio',}, 
          { positions: [ { i: '1', j: 0 }, { i: '3', j: 0 }, { i: '3', j: 1 }, { i: '2', j: 0 }, { i: '1', j: 1 }, { i: '4', j: 0 }, { i: '1', j: 2 }, { i: '4', j: 1 }, { i: '3', j: 2 }, { i: '2', j: 1 }, { i: '2', j: 2 }, { i: '4', j: 2 },  ], css_id: 'tinytable_css_3uu963gj8gicvose2ri6',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_bmauffp1nes4k7ak26xx',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_b7f61g7yfvtf83qhcu3g(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_bty29l0crjxs983sklio, .table th.tinytable_css_bty29l0crjxs983sklio { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_3uu963gj8gicvose2ri6, .table th.tinytable_css_3uu963gj8gicvose2ri6 { text-align: left; }
      .table td.tinytable_css_bmauffp1nes4k7ak26xx, .table th.tinytable_css_bmauffp1nes4k7ak26xx { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_b7f61g7yfvtf83qhcu3g" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>First Stage Test</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">terms</th>
                <th scope="col" data-row="0" data-col="1">statistic</th>
                <th scope="col" data-row="0" data-col="2">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">Weak instruments (speciesChinstrap)</td>
                  <td data-row="1" data-col="1">64.22</td>
                  <td data-row="1" data-col="2">0.00</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">Weak instruments (speciesGentoo)</td>
                  <td data-row="2" data-col="1">430.08</td>
                  <td data-row="2" data-col="2">0.00</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">Weak instruments (flipper_length)</td>
                  <td data-row="3" data-col="1">129.62</td>
                  <td data-row="3" data-col="2">0.00</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Wu-Hausman</td>
                  <td data-row="4" data-col="1">68.93</td>
                  <td data-row="4" data-col="2">0.00</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">Sargan</td>
                  <td data-row="5" data-col="1">2.32</td>
                  <td data-row="5" data-col="2">0.13</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_second_stage_test</span>(pegs_mod2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_zzsufet5uhowl2nfpjvs(i, j, css_id) {
          var table = document.getElementById("tinytable_zzsufet5uhowl2nfpjvs");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_zzsufet5uhowl2nfpjvs(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_zzsufet5uhowl2nfpjvs");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 0 }, { i: '4', j: 1 }, { i: '4', j: 2 }, { i: '4', j: 3 },  ], css_id: 'tinytable_css_duqpgy62s6mtfi586gla',}, 
          { positions: [ { i: '3', j: 1 }, { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '3', j: 3 }, { i: '1', j: 2 },  ], css_id: 'tinytable_css_tsj5srjpo9h1la5tm4j6',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 },  ], css_id: 'tinytable_css_o0o5x49o1v81nrmjugh9',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_zzsufet5uhowl2nfpjvs(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_duqpgy62s6mtfi586gla, .table th.tinytable_css_duqpgy62s6mtfi586gla { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_tsj5srjpo9h1la5tm4j6, .table th.tinytable_css_tsj5srjpo9h1la5tm4j6 { text-align: left; }
      .table td.tinytable_css_o0o5x49o1v81nrmjugh9, .table th.tinytable_css_o0o5x49o1v81nrmjugh9 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_zzsufet5uhowl2nfpjvs" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Second Stage Test</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">terms</th>
                <th scope="col" data-row="0" data-col="1">estimate</th>
                <th scope="col" data-row="0" data-col="2">SE</th>
                <th scope="col" data-row="0" data-col="3">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">(Intercept)</td>
                  <td data-row="1" data-col="1">0.61</td>
                  <td data-row="1" data-col="2">0.13</td>
                  <td data-row="1" data-col="3">0.00</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">speciesChinstrap</td>
                  <td data-row="2" data-col="1">-0.49</td>
                  <td data-row="2" data-col="2">0.18</td>
                  <td data-row="2" data-col="3">0.01</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">speciesGentoo</td>
                  <td data-row="3" data-col="1">-1.42</td>
                  <td data-row="3" data-col="2">0.29</td>
                  <td data-row="3" data-col="3">0.00</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">flipper_length</td>
                  <td data-row="4" data-col="1">1.70</td>
                  <td data-row="4" data-col="2">0.15</td>
                  <td data-row="4" data-col="3">0.00</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>我们现在有标准线性模型 OLS-LM 和工具变量模型 IV-LM，分别用数值方法和绘图方法对比他们的差异，发现 IV 模型的回归系数有一些优化，但优化效果并不是特别明显；主要原因在于原有的线性模型 <code>pegs_mod1</code> 已经是显著的了，工具变量的最大意义是将一个不显著的结果“优化”成为显著的结果，而不是将一个已经显著的结果再次强化其显著性。好的工具变量就像优秀的公检法机关，它通过严肃论证和周密调查得到铁证如山，将犯罪嫌疑人定罪量刑；而坏的工具变量就像不负责任的公检法机关，它在程序上有诸多漏洞和瑕疵，疏忽大意甚至故意造成冤假错案，此时就算是已经在程序上将嫌疑人定罪量刑甚至执行了死刑，但是由于严重的程序违法，这些案件最终还是要被翻案。此图下发提供了两个中国刑事司法历史中两个真实的案例作为附录，引导同学们从法学、哲学、经济学、公平正义的底层视角对“因果关推断”有更加透彻的理解。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into list</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pegs_mods <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod1"</span> <span class="ot">=</span> pegs_mod1, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod2"</span> <span class="ot">=</span> pegs_mod2</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># show comparison table</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> pegs_mods, </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">stars =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">coef_omit =</span> <span class="st">"Intercept"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Summary of pegs_mods"</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_akipjhiwxa93yzdam0kx(i, j, css_id) {
          var table = document.getElementById("tinytable_akipjhiwxa93yzdam0kx");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_akipjhiwxa93yzdam0kx(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_akipjhiwxa93yzdam0kx");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '11', j: 1 }, { i: '11', j: 2 },  ], css_id: 'tinytable_css_c72l32cghufzlmgje6cn',}, 
          { positions: [ { i: '3', j: 2 }, { i: '3', j: 1 },  ], css_id: 'tinytable_css_9tvijji5olfi3fsvuyll',}, 
          { positions: [ { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '4', j: 2 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '7', j: 1 }, { i: '4', j: 1 }, { i: '9', j: 1 }, { i: '10', j: 1 }, { i: '7', j: 2 }, { i: '8', j: 1 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '8', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '9', j: 2 }, { i: '10', j: 2 },  ], css_id: 'tinytable_css_viceb0v8ef35qa3z9ud0',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_mpc8oe3vse2gpzuzaix9',}, 
          { positions: [ { i: '11', j: 0 },  ], css_id: 'tinytable_css_9noyqzp0r6qpni7xdtf1',}, 
          { positions: [ { i: '3', j: 0 },  ], css_id: 'tinytable_css_b0vjwbqr55bjhqvxmxc7',}, 
          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '7', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '8', j: 0 }, { i: '9', j: 0 }, { i: '10', j: 0 },  ], css_id: 'tinytable_css_l4ig2rk5pohvtpltgmki',}, 
          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_14affkfov3tatgfspn94',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_akipjhiwxa93yzdam0kx(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_c72l32cghufzlmgje6cn, .table th.tinytable_css_c72l32cghufzlmgje6cn { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_9tvijji5olfi3fsvuyll, .table th.tinytable_css_9tvijji5olfi3fsvuyll { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_viceb0v8ef35qa3z9ud0, .table th.tinytable_css_viceb0v8ef35qa3z9ud0 { text-align: center; }
      .table td.tinytable_css_mpc8oe3vse2gpzuzaix9, .table th.tinytable_css_mpc8oe3vse2gpzuzaix9 { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_9noyqzp0r6qpni7xdtf1, .table th.tinytable_css_9noyqzp0r6qpni7xdtf1 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_b0vjwbqr55bjhqvxmxc7, .table th.tinytable_css_b0vjwbqr55bjhqvxmxc7 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_l4ig2rk5pohvtpltgmki, .table th.tinytable_css_l4ig2rk5pohvtpltgmki { text-align: left; }
      .table td.tinytable_css_14affkfov3tatgfspn94, .table th.tinytable_css_14affkfov3tatgfspn94 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_akipjhiwxa93yzdam0kx" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Summary of pegs_mods</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0"> </th>
                <th scope="col" data-row="0" data-col="1">pegs_mod1</th>
                <th scope="col" data-row="0" data-col="2">pegs_mod2</th>
              </tr>
        
        </tbody><tfoot><tr><td colspan="3">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr></tfoot>
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">flipper_length</td>
                  <td data-row="1" data-col="1">0.712***</td>
                  <td data-row="1" data-col="2">1.701***</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">speciesChinstrap</td>
                  <td data-row="2" data-col="1">-0.256***</td>
                  <td data-row="2" data-col="2">-0.493**</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">speciesGentoo</td>
                  <td data-row="3" data-col="1">0.355**</td>
                  <td data-row="3" data-col="2">-1.419***</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Num.Obs.</td>
                  <td data-row="4" data-col="1">333</td>
                  <td data-row="4" data-col="2">333</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">R2</td>
                  <td data-row="5" data-col="1">0.787</td>
                  <td data-row="5" data-col="2">0.564</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">R2 Adj.</td>
                  <td data-row="6" data-col="1">0.785</td>
                  <td data-row="6" data-col="2">0.560</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">AIC</td>
                  <td data-row="7" data-col="1">441.7</td>
                  <td data-row="7" data-col="2">680.0</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">BIC</td>
                  <td data-row="8" data-col="1">460.7</td>
                  <td data-row="8" data-col="2">699.1</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">Log.Lik.</td>
                  <td data-row="9" data-col="1">-215.845</td>
                  <td data-row="9" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">F</td>
                  <td data-row="10" data-col="1">405.281</td>
                  <td data-row="10" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="11" data-col="0">RMSE</td>
                  <td data-row="11" data-col="1">0.46</td>
                  <td data-row="11" data-col="2">0.66</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot comparison figure</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    pegs_mods <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">modelplot</span>(<span class="at">coef_omit =</span> <span class="st">"Intercept"</span>) <span class="sc">+</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Estimate and 95% CI"</span>, </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Fig 2.6: Summary of pegs_mods"</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-9-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="econ_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
<p>附录案件：</p>
<ul>
<li><p>聂树斌案件：1994 年 8 月，石家庄某玉米地发现一具女尸；9 月，公安局认为聂树斌有重大作案嫌疑；1995 年 4 月，经过“侦查起诉”环节，石家庄中院审判认定聂树斌犯故意杀人罪，判处死刑立即执行。但是案件卷宗缺失了一些关键的定性证据，聂树斌的家人和辩护律师李树亭都认为他不是真凶，于是走上漫漫维权路。2005 年 5 月，另案嫌疑人王书金交代了 1994 年 8 月的石家庄玉米地女尸案件的全部事实，并称自己是案件的唯一真凶，没有其他人参与，案件引起最高法院重视，进入重审阶段。2016 年 12 月，经过极其复杂的司法环节，最高法院巡回法庭改判聂树斌无罪。此案件的王书金就是重要的工具变量，他从根本上改变了聂树斌案件的性质，假如王书金没有被抓、李树亭律师没有奔走呼号、郑成月警官没有坚持真理，那么聂树斌永远都会背上“杀人犯”的罪名。可惜从聂树斌被错误地执行死刑到被平反，已经过过去了整整 20 年，此案的真凶最终也无从查证。河北高院没有被认定王书金是此案的罪犯，且最高法院已经宣判聂树斌无罪，到底是谁杀害了这位可怜的女青年？公检法机关并没有回答这个问题。她和聂树斌都无辜地成为了我国法治改革滚滚洪流当中的一粒带血的尘埃，愿逝者安息。 <a href="https://tv.cctv.com/2016/12/10/VIDE4MICv9f5kVNxvs2lKbSa161210.shtml">CCTV 专访</a> <a href="https://www.youtube.com/watch?v=GCWPbmLJ9aY">锵锵三人行 访谈</a></p></li>
<li><p>佘祥林案件：1994 年 1 月，佘祥林的其中张在玉走失；4 月，当地鱼塘里发现一具高度腐烂的女尸，公安局法医经过“检验”认为是走失的张在玉，公安局认为佘祥林具有重大犯罪嫌疑；9 月，经过简单粗暴的“调查审讯”，荆州中院判处佘祥林犯故意杀人罪，死刑缓期两年执行；1998 年 荆门中院顶住巨大社会道德法律的压力，改判佘祥林有期徒刑 15 年；2005 年 3 月，张在玉“死而复生”返回老家，证明当年鱼塘里的女尸并非张在玉本人，也证明佘祥林是完完全全的冤案；5 月，湖北高院改判佘祥林无罪。佘祥林的运气比聂树斌好太多了，佘祥林的三次审判都在逐级降刑而没有死刑立即执行；并且在他服刑的第 11 年，最关键的工具变量，即本案的“死者”张在玉突然“死而复生”，给当时的政法系统狠狠地上了一课。如果张在玉没有出现，佘祥林再服刑 4 年也就刑满释放出狱了，但余生都要背上“杀妻”的罪名。<a href="https://www.cctv.com/law/20050512/102382.shtml">CCTV 专访</a> <a href="https://www.youtube.com/watch?v=5kk3rnuErFs">锵锵三人行 访谈</a></p></li>
</ul>
</section>
</section>
<section id="sec-lm-heterogeneity" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="sec-lm-heterogeneity"><span class="header-section-number">1.3</span> Heterogeneity</h2>
<section id="definition-1" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="definition-1"><span class="header-section-number">1.3.1</span> Definition</h3>
<p>根据前面的内容，我们的基础模型 OLS-LM 是：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pegs_mod1 <span class="ot">=</span> <span class="fu">lm</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">+</span> species, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>已知模型具有显著性，即 <code>flipper_length</code>对 <code>body_mass</code> 具有积极的促进效果。现在需要进一步思考，在不同的 <code>species</code> 分组中（<code>Adelie, Chinstrap, Gentoo</code>），模型的回归显著性是否存在差异？换言之，我们需要回答一些问题：“模型的平均效应 Average Treatment Effects，ATE 在多个分组间是否保持稳定？是否存在某个分组效应很强，但是另外分组效应很弱的情况？是否存在某个分组实际上是弱效应，但是“被平均”而成为了强效应的情况？或者反之，是否存在某个分组实际上是强效应，但是“被平均”而成为了弱效应的情况？”这些奇奇怪怪的问题所探究的本质都是同一个问题，即条件平均效应 Conditional Average Treatment Effects, CATE 的变化情况。同学们不要看到这个名词就恐惧，CATE 非常简单，只不过是 ATE 在某个特定条件下的子集而已，我们现在来拆解它。</p>
<p>本案中，我们的 ATE 就是 <code>flipper_length</code> 对 <code>body_mass</code> 的平均促进效应，又因为 <code>species</code> 包含三个分类 <code>Adelie, Chinstrap, Gentoo</code>，因此如果我们不考虑全局的平均情况，而考虑每个分类下的局部情况，我们就会得到三个分类各自的回归效应。这就是 <code>flipper_length</code> 对 <code>body_mass</code> 在 <code>Adelie, Chinstrap, Gentoo</code> 三个分组下的促进效应，再简化即可得到三个 CATE 分别是 <code>CATE(Ade), CATE(Chi), CATE(Gen)</code>。它们的简化的数学表达式如下，请注意这是非常抽象的表达式，其中的 ATE 是必须通过另外的模型计算而得到的，而不是直接可以从这个表达式中计算出来。</p>
<p><span class="math display">\[
\begin{aligned}
\text{CATE(Ade)} &amp;= [\text{ATE} | \text{species} = \text{Adelie}] \\
\text{CATE(Chi)} &amp;= [\text{ATE} | \text{species} = \text{Chinstrap}] \\
\text{CATE(Gen)} &amp;= [\text{ATE} | \text{species} = \text{Gentoo}]
\end{aligned}
\]</span></p>
<p>此时，我们需要思考的一个重要问题就是 ATE 和 CATE 在多个分组之间的差异程度，即以下的不等式：</p>
<p><span class="math display">\[
\text{CATE(Ade)} \quad \stackrel{?}{=} \quad
\text{CATE(Chi)} \quad \stackrel{?}{=} \quad
\text{CATE(Gen)} \quad \stackrel{?}{=}
\text{ATE}
\]</span></p>
<p>这就顺理成章地引出了“同质性 Homogeneity”与“异质性 Heterogeneity”两个重要概念，它们的数学表达式如下：</p>
<ul>
<li>同质性 Homogeneity：条件平均效应在多个组之间不存在显著差异，即，<span class="math inline">\(\text{CATE}_i = \text{CATE}_j, \quad \forall i,j\)</span>。</li>
<li>异质性 Heterogeneity：条件平均效应在多个组之间存在较大差异，此时又可以继续划分为以下两种情况：
<ul>
<li>Groupwise: 某个条件回归效应与平均回归效应存在较大差异，即 <span class="math inline">\(\text{CATE}_i \neq \text{ATE}, \quad \exists i\)</span>。</li>
<li>Pairwise: 任意两个条件平均效应之间存在较大差异，即 <span class="math inline">\(\text{CATE}_i \neq \text{CATE}_j, \quad \exists i,j\)</span>。</li>
</ul></li>
</ul>
<p>至此，我们就从原理上完成了对同质性和异质性的定义和区分，至于它的实际计算会在下一小节讨论，接下来需要思考的是为什么要区分它们以及分别适用于什么样的场景？“异质性”在经济研究领域具重要意义，比如国家出台“延迟退休政策”，“职工”有很多不同分类：“公务员、事业单位、军人、民营企业职员、自由职业者、残障人士、进城务工人群、乡村农民”等等，我们必须考虑“延迟退休”政策对于不同人群的平均效果是否存在显著差异？我们当然不希望中国的年轻人成为发达国家那种不想上班的躺平状态，但更不希望中年人成为日本那种不敢退休的社会恐惧。这就要求政府机关深入研究政策效力的“异质性”，即不同组别的劳动者在受到延迟退休的政策刺激时应该具有不一样的反馈，一方面，年轻人应该积极响应认可这份政策并努力工作；另一方面，适龄离休干部可能存在一定程度的抵触和不理解，这不仅是合情合理的，而且也是完全意料之中的。政策制定者必须充分考虑到组间差异，制定出“弹性退休政策”而不是一刀切的“强制退休政策”，否则容易得到一个“失之毫厘谬之千里”的结论。总之，同质性和异质性是实证分析的第二个重点问题，它们并没有道德上的好坏之分，我们必须根据具体情况开展具体分析，更多关于异质性的权威文献包括 <span class="citation" data-cites="Rosen1974">(<a href="#ref-Rosen1974" role="doc-biblioref"><strong>Rosen1974?</strong></a>)</span>, <span class="citation" data-cites="Mundlak1978">(<a href="#ref-Mundlak1978" role="doc-biblioref"><strong>Mundlak1978?</strong></a>)</span>, <span class="citation" data-cites="Heckman1979">(<a href="#ref-Heckman1979" role="doc-biblioref"><strong>Heckman1979?</strong></a>)</span>, <span class="citation" data-cites="Anderson1992">(<a href="#ref-Anderson1992" role="doc-biblioref"><strong>Anderson1992?</strong></a>)</span>, <span class="citation" data-cites="Heckman1998">(<a href="#ref-Heckman1998" role="doc-biblioref"><strong>Heckman1998?</strong></a>)</span>。</p>
</section>
<section id="solution-1" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="solution-1"><span class="header-section-number">1.3.2</span> Solution</h3>
<p>回到本案，我们现在讨论如何检验模型的异质性。其实很简单，就是通过“交互项 Interaction Terms”，在原模型当中增加一个自变量与分类变量的乘积项目。即把 <code>num_var + cat_var</code> 改为 <code>num_var * cat_var</code> 即可，然后再分析这个新模型的交互项的显著性；假如分类变量有很多子类和很多数值变量，这时的交互项目就会非常复杂，因此出于简便角度，我们并不需要完整写清楚所有的交互项目，重点在于修改符号即可。这部分数学公式比较复杂但是算法原理很简单，因此我们继续跳过数学证明部分，直接给出广义的算法原理：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="at">formula =</span> Y <span class="sc">~</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> df)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="at">formula =</span> Y <span class="sc">~</span> X1 <span class="sc">*</span> X2, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>那么根据已有的 <code>pegs_mod1, pegs_mod2</code> 可以推理得到 <code>pegs_mod3, pegs_mod4</code>：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pegs_mod3 <span class="ot">=</span> <span class="fu">lm</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">*</span> species, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>pegs_mod4 <span class="ot">=</span> <span class="fu">ivreg</span>(</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> species <span class="sc">|</span> species <span class="sc">*</span> flipper_length  <span class="sc">|</span> species <span class="sc">*</span> (bill_depth <span class="sc">+</span> bill_length),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>由此，我们从原有的不带交互项的模型 <code>pegs_mod1, pegs_mod2</code> 升级得到带交互项的模型 <code>pegs_mod3</code> 和 <code>pegs_mod4</code>，完成了最核心的四个模型，它们涵盖了本硕阶段的计量经济的所有重要知识点。我们接下来调用 <code>modelplot()</code> 和 <code>modelsummary()</code> 观察它们的回归参数的差异，发现 <code>pegs_mod3</code> 的结果只有两个显著变量，而 <code>pegs_mod4</code> 的结果全都是显著变量，很显然第四模型的效果优于第三模型。究其原因是因为 <code>bill_depth</code> 和 <code>bill_length</code> 作为工具变量对模型进行了深度调节和限制作用，IV 比 OLS 模型更好地处理了异质性问题。但是它们的具体作用机制很复杂了，我们不需要考虑那些理论层次，谨记教员的训话“集中优势兵力歼敌”，我们先把小坦克的油门踩到底，用闪电战一举歼灭敌人。但是马上我们就遇到了一个严肃的问题，这个图并没有回到我们的核心问题：异质性 Heterogeneity，即虽然已经知道 <code>pegs_mod4</code> 的所有变量都显著，但是它并没有告诉我们每个 <code>species</code> 之间的差异性和显著性的程度。如果同学们能思考到这个层次，就已经到达很高的辩证思维层次，我们继续往下推动。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create two models with interaction terms</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pegs_mod3 <span class="ot">=</span> <span class="fu">lm</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">*</span> species, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>pegs_mod4 <span class="ot">=</span> <span class="fu">ivreg</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        body_mass <span class="sc">~</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        species <span class="sc">|</span> species <span class="sc">*</span> flipper_length <span class="sc">|</span> species <span class="sc">*</span> (bill_depth <span class="sc">+</span> bill_length),</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># combine models</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>pegs_mods <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod1"</span> <span class="ot">=</span> pegs_mod1, </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod2"</span> <span class="ot">=</span> pegs_mod2, </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod3"</span> <span class="ot">=</span> pegs_mod3, </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod4"</span> <span class="ot">=</span> pegs_mod4</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># compare models</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> pegs_mods, </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">stars =</span> <span class="cn">TRUE</span>, </span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">coef_omit =</span> <span class="st">"Intercept"</span>,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Summary of pegs_mods"</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_vse9wpg7tler3oj9r1uo(i, j, css_id) {
          var table = document.getElementById("tinytable_vse9wpg7tler3oj9r1uo");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_vse9wpg7tler3oj9r1uo(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_vse9wpg7tler3oj9r1uo");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '15', j: 3 }, { i: '15', j: 2 }, { i: '15', j: 1 }, { i: '15', j: 4 },  ], css_id: 'tinytable_css_34qernh6n2ggv4a4ooq4',}, 
          { positions: [ { i: '7', j: 4 }, { i: '7', j: 3 }, { i: '7', j: 2 }, { i: '7', j: 1 },  ], css_id: 'tinytable_css_16pryo261xfwn4msckfo',}, 
          { positions: [ { i: '4', j: 1 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '4', j: 2 }, { i: '8', j: 1 }, { i: '5', j: 1 }, { i: '10', j: 1 }, { i: '11', j: 1 }, { i: '12', j: 1 }, { i: '13', j: 1 }, { i: '14', j: 1 }, { i: '12', j: 2 }, { i: '3', j: 1 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '6', j: 1 }, { i: '1', j: 3 }, { i: '5', j: 2 }, { i: '9', j: 1 }, { i: '4', j: 3 }, { i: '8', j: 2 }, { i: '9', j: 2 }, { i: '10', j: 2 }, { i: '11', j: 2 }, { i: '9', j: 3 }, { i: '13', j: 2 }, { i: '14', j: 2 }, { i: '12', j: 3 }, { i: '3', j: 2 }, { i: '14', j: 3 }, { i: '2', j: 3 }, { i: '6', j: 2 }, { i: '1', j: 4 }, { i: '5', j: 3 }, { i: '6', j: 3 }, { i: '4', j: 4 }, { i: '8', j: 3 }, { i: '6', j: 4 }, { i: '10', j: 3 }, { i: '11', j: 3 }, { i: '9', j: 4 }, { i: '13', j: 3 }, { i: '11', j: 4 }, { i: '12', j: 4 }, { i: '3', j: 3 }, { i: '14', j: 4 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '8', j: 4 }, { i: '5', j: 4 }, { i: '10', j: 4 }, { i: '13', j: 4 },  ], css_id: 'tinytable_css_mhwql0opfxq1cjx7e7w4',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 4 }, { i: '0', j: 3 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_a44g2ipim4ezizly68ba',}, 
          { positions: [ { i: '15', j: 0 },  ], css_id: 'tinytable_css_oex885bwd7iyqnn1u05f',}, 
          { positions: [ { i: '7', j: 0 },  ], css_id: 'tinytable_css_exrpd0l8pgipmuu5cbyk',}, 
          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '11', j: 0 }, { i: '8', j: 0 }, { i: '9', j: 0 }, { i: '10', j: 0 }, { i: '12', j: 0 }, { i: '13', j: 0 }, { i: '14', j: 0 },  ], css_id: 'tinytable_css_8qy6sf5z46n1nmtmj8qd',}, 
          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_03j6d2n20c78a0pj6pf9',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_vse9wpg7tler3oj9r1uo(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_34qernh6n2ggv4a4ooq4, .table th.tinytable_css_34qernh6n2ggv4a4ooq4 { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_16pryo261xfwn4msckfo, .table th.tinytable_css_16pryo261xfwn4msckfo { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_mhwql0opfxq1cjx7e7w4, .table th.tinytable_css_mhwql0opfxq1cjx7e7w4 { text-align: center; }
      .table td.tinytable_css_a44g2ipim4ezizly68ba, .table th.tinytable_css_a44g2ipim4ezizly68ba { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_oex885bwd7iyqnn1u05f, .table th.tinytable_css_oex885bwd7iyqnn1u05f { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_exrpd0l8pgipmuu5cbyk, .table th.tinytable_css_exrpd0l8pgipmuu5cbyk { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_8qy6sf5z46n1nmtmj8qd, .table th.tinytable_css_8qy6sf5z46n1nmtmj8qd { text-align: left; }
      .table td.tinytable_css_03j6d2n20c78a0pj6pf9, .table th.tinytable_css_03j6d2n20c78a0pj6pf9 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_vse9wpg7tler3oj9r1uo" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Summary of pegs_mods</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0"> </th>
                <th scope="col" data-row="0" data-col="1">pegs_mod1</th>
                <th scope="col" data-row="0" data-col="2">pegs_mod2</th>
                <th scope="col" data-row="0" data-col="3">pegs_mod3</th>
                <th scope="col" data-row="0" data-col="4">pegs_mod4</th>
              </tr>
        
        </tbody><tfoot><tr><td colspan="5">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr></tfoot>
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">flipper_length</td>
                  <td data-row="1" data-col="1">0.712***</td>
                  <td data-row="1" data-col="2">1.701***</td>
                  <td data-row="1" data-col="3">0.573***</td>
                  <td data-row="1" data-col="4">2.145***</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">speciesChinstrap</td>
                  <td data-row="2" data-col="1">-0.256***</td>
                  <td data-row="2" data-col="2">-0.493**</td>
                  <td data-row="2" data-col="3">-0.188+</td>
                  <td data-row="2" data-col="4">-1.256***</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">speciesGentoo</td>
                  <td data-row="3" data-col="1">0.355**</td>
                  <td data-row="3" data-col="2">-1.419***</td>
                  <td data-row="3" data-col="3">0.186</td>
                  <td data-row="3" data-col="4">-1.489***</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">flipper_length × speciesChinstrap</td>
                  <td data-row="4" data-col="1"></td>
                  <td data-row="4" data-col="2"></td>
                  <td data-row="4" data-col="3">0.033</td>
                  <td data-row="4" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">flipper_length × speciesGentoo</td>
                  <td data-row="5" data-col="1"></td>
                  <td data-row="5" data-col="2"></td>
                  <td data-row="5" data-col="3">0.377**</td>
                  <td data-row="5" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">speciesChinstrap × flipper_length</td>
                  <td data-row="6" data-col="1"></td>
                  <td data-row="6" data-col="2"></td>
                  <td data-row="6" data-col="3"></td>
                  <td data-row="6" data-col="4">-1.151**</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">speciesGentoo × flipper_length</td>
                  <td data-row="7" data-col="1"></td>
                  <td data-row="7" data-col="2"></td>
                  <td data-row="7" data-col="3"></td>
                  <td data-row="7" data-col="4">-0.794*</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">Num.Obs.</td>
                  <td data-row="8" data-col="1">333</td>
                  <td data-row="8" data-col="2">333</td>
                  <td data-row="8" data-col="3">333</td>
                  <td data-row="8" data-col="4">333</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">R2</td>
                  <td data-row="9" data-col="1">0.787</td>
                  <td data-row="9" data-col="2">0.564</td>
                  <td data-row="9" data-col="3">0.794</td>
                  <td data-row="9" data-col="4">0.543</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">R2 Adj.</td>
                  <td data-row="10" data-col="1">0.785</td>
                  <td data-row="10" data-col="2">0.560</td>
                  <td data-row="10" data-col="3">0.791</td>
                  <td data-row="10" data-col="4">0.536</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="0">AIC</td>
                  <td data-row="11" data-col="1">441.7</td>
                  <td data-row="11" data-col="2">680.0</td>
                  <td data-row="11" data-col="3">435.0</td>
                  <td data-row="11" data-col="4">699.7</td>
                </tr>
                <tr>
                  <td data-row="12" data-col="0">BIC</td>
                  <td data-row="12" data-col="1">460.7</td>
                  <td data-row="12" data-col="2">699.1</td>
                  <td data-row="12" data-col="3">461.6</td>
                  <td data-row="12" data-col="4">726.4</td>
                </tr>
                <tr>
                  <td data-row="13" data-col="0">Log.Lik.</td>
                  <td data-row="13" data-col="1">-215.845</td>
                  <td data-row="13" data-col="2"></td>
                  <td data-row="13" data-col="3">-210.488</td>
                  <td data-row="13" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="14" data-col="0">F</td>
                  <td data-row="14" data-col="1">405.281</td>
                  <td data-row="14" data-col="2"></td>
                  <td data-row="14" data-col="3">251.731</td>
                  <td data-row="14" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="15" data-col="0">RMSE</td>
                  <td data-row="15" data-col="1">0.46</td>
                  <td data-row="15" data-col="2">0.66</td>
                  <td data-row="15" data-col="3">0.46</td>
                  <td data-row="15" data-col="4">0.68</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot models</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">modelplot</span>(pegs_mods, <span class="at">coef_omit =</span> <span class="st">"Intercept"</span>) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimate"</span>, <span class="at">title =</span> <span class="st">"Fig 2.7: Summary of pegs_mods"</span>) <span class="sc">+</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="econ_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="case-study-1" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="case-study-1"><span class="header-section-number">1.3.3</span> Case Study</h3>
<p>我们前面已经得到了两个显著模型，<code>pegs_mod3, pegs_mod4</code>，现在需要讨论如何检测其每个组之间的回归系数的差异性，即回答“它们是同质的还是异质的？”。我们需要借助另一个神包 <a href="https://marginaleffects.com"><code>marginaleffects</code></a> 进行一些计算，算法比较复杂，不用考虑细节，一通运算后得到数值结果，将结果导入 <code>ggplot</code> 并绘制四张子图。其中第一行是 <code>pegs_mod3</code> 的检测结果，左侧绘制总体异质性对比，即 CATE vs ATE 的对比，它反应的是某个组的效应相对于总体效应的差异性；右侧绘制组间异质性对比，即 CATE(a) vs CATE(b) vs CATE(c)，它反应的是两两成对的分组之间的差异性。第二行是 <code>pegs_mod4</code> 的检测结果。简要分析如下。</p>
<p><code>pegs_mod3</code> 的 <code>species</code> 三个分类 (<code>Adelie, Chinstrap, Gentoo</code>) 相对于零效应都具有显著差异，但是 <code>Gentoo</code> 的系数明显高于 <code>Adelie, Chinstrap</code>，并且 <code>Adelie, Chinstrap</code> 的系数很接近，我们可以大胆推测它们二者之间的组间异质性应该是不显著的。这个推测在右侧子图得到了证实，它显示 <code>Gentoo vs Adelie, Gentoo vs Chinstrap</code> 两组的组间异质性显著，也就是说，这两个配对组之间的回归系数存在较大差异性；但是 <code>Adelie vs Chinstrap</code> 这组的组间异质性 <span class="math inline">\(pv = 0.787\)</span> 不显著，也就是说，这两个配对组之间的回归系数不存在较大差异性。</p>
<p><code>pegs_mod4</code> 的 <code>species</code> 三个分类的单独的异质性依然显著，但是系数的排序发生了变化，<code>Adelie</code> 的系数最高，<code>Gentoo</code> 的系数最低，而 <code>Chinstrap</code> 的系数居中；并且 <code>Chinstrap, Gentoo</code> 的系数很接近，我们也可以大胆推测它们之间的组间异质性很有可能是不显著的，即它们之间可能是同质性的。右侧的子图再次证明我们的推测，<code>Chinstrap, Adelie</code> 的异质性结果显著，<code>Gentoo, Adelie</code> 的异质性结果显著，但是 <code>Gentoo, Chinstrap</code> 的异质性结果不显著 <span class="math inline">\(pv = 0.074\)</span>，如果它的数值再接近 <span class="math inline">\(pv = 0.05\)</span>，我们或许可以谨慎地认为是“边缘显著”；但本案例它依然比较大，不应当认为是边缘显著，而应当直接认为是不显著。</p>
<p>综上所述，我们在原有的 OLS-LM 和 IV-LM 当中分别加入交互项，我们不仅观察到了平均效应 ATE 更观察到了条件平均效应 CATE，并且进一步讨论了如何通过 CATE 的两两配对图形来辨析异质性；从数值层面和图表层面全方面地证明，有交互项的模型相比无交互项的模型，在异质性的分析流程当中具有更高的实证价值。这个结论提醒我们，如果条件允许，我们应当尽量构建带有交互项的回归模型，而尽量避免单纯的简单回归模型，即 <code>cat_var * num_var</code> 模型优先于 <code>cat_var + num_var</code> 模型。而至于更深度的“如何解决异质性”的问题已经超过当前的框架，我们暂且不论，继续踩着小坦克的油门突突突往纵深推进，冲鸭。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate groupwise heterogeneity of pegs_mod3</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>pegs_mod3_group_hete <span class="ot">=</span> (</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> pegs_mod3, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"flipper_length"</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"species"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> <span class="dv">0</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="fu">vcovHC</span>(pegs_mod3, <span class="at">type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(term, species, pv, estimate, conf_lo, conf_hi)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># plot groupwise heterogeneity of pegs_mod3</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>sub1 <span class="ot">=</span> (</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    pegs_mod3_group_hete <span class="sc">%&gt;%</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> species, <span class="at">y =</span> estimate, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">ymin =</span> conf_lo, <span class="at">ymax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">width =</span> <span class="fl">0.2</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>, <span class="at">title =</span> <span class="st">"Groupwise Test of pegs_mod3"</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate pairwise heterogeneity of pegs_mod3</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>pegs_mod3_pair_hete <span class="ot">=</span> (</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> pegs_mod3, </span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"flipper_length"</span>, </span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"species"</span>,</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> difference <span class="sc">~</span> pairwise,</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="fu">vcovHC</span>(pegs_mod3, <span class="at">type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">pairs =</span> hypothesis,</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pairs, pv, estimate, conf_lo, conf_hi)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a><span class="co"># plot pairwise heterogeneity of pegs_mod3</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>sub2 <span class="ot">=</span> (</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    pegs_mod3_pair_hete <span class="sc">%&gt;%</span> </span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pairs, <span class="at">y =</span> estimate, <span class="at">color =</span> pairs)) <span class="sc">+</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">ymin =</span> conf_lo, <span class="at">ymax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">width =</span> <span class="fl">0.2</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>, <span class="at">title =</span> <span class="st">"Pairwise Test of pegs_mod3"</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate zero heterogeneity of pegs_mod4</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>pegs_mod4_group_hete <span class="ot">=</span> (</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> pegs_mod4, </span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"flipper_length"</span>, </span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"species"</span>,</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> <span class="dv">0</span>,</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="fu">vcovHC</span>(pegs_mod4, <span class="at">type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(term, species, pv, estimate, conf_lo, conf_hi)</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a><span class="co"># plot group heterogeneity of pegs_mod4</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>sub3 <span class="ot">=</span> (</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>    pegs_mod4_group_hete <span class="sc">%&gt;%</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> species, <span class="at">y =</span> estimate, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">ymin =</span> conf_lo, <span class="at">ymax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">width =</span> <span class="fl">0.2</span></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>, <span class="at">title =</span> <span class="st">"Group Test of pegs_mod4"</span></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate pairwise heterogeneity of pegs_mod4</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>pegs_mod4_pair_hete <span class="ot">=</span> (</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> pegs_mod4, </span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"flipper_length"</span>, </span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"species"</span>,</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> difference <span class="sc">~</span> pairwise,</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="fu">vcovHC</span>(pegs_mod4, <span class="at">type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>        <span class="at">pairs =</span> hypothesis,</span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pairs, pv, estimate, conf_lo, conf_hi)</span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a><span class="co"># plot pairwise heterogeneity of pegs_mod4</span></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a>sub4 <span class="ot">=</span> (</span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>    pegs_mod4_pair_hete <span class="sc">%&gt;%</span> </span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pairs, <span class="at">y =</span> estimate, <span class="at">color =</span> pairs)) <span class="sc">+</span></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(</span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">ymin =</span> conf_lo, <span class="at">ymax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">width =</span> <span class="fl">0.2</span></span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>, <span class="at">title =</span> <span class="st">"Pairwise Test of pegs_mod4"</span></span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into single figure</span></span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>(sub1, sub2, sub3, sub4) <span class="sc">+</span> </span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Fig 2.8: Heterogeneity Test"</span>)</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-11-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="econ_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-lm-robustness" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="sec-lm-robustness"><span class="header-section-number">1.4</span> Robustness</h2>
<section id="residuals" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="residuals"><span class="header-section-number">1.4.1</span> Residuals</h3>
<p>残差检验是模型的最后一步，为了更好理解它，我们需要解释两个重要的基础概念。前面已经提过“预测矩阵”，但是没有进行精确界定，所谓的“预测矩阵 Prediction Matrix” <span class="math inline">\(\mathbf{\widehat{Y}}\)</span> 就是当我们计算得到了回归参数矩阵 <span class="math inline">\(\mathbf{\widehat{B}}\)</span> 之后，将这个参数矩阵与目标矩阵 <span class="math inline">\(\mathbf{X}\)</span> 相乘，即可得到基于模型的预测值。</p>
<p><span class="math display">\[
\mathbf{\widehat{Y}} = \mathbf{X} \mathbf{\widehat{B}}
\]</span></p>
<p>那么根据常识我们知道，任何预测都不可能完全等于实际数据，因此预测值跟观测值必然有一定差异，而这部分差异就是模型的“残差 Residuals”。在计量经济学中，残差并不仅仅代表预测的“好坏”，它更重要的意义是衡量模型未能捕捉到的随机变动项；残差分析的目的就是检查这些未被解释的部分是否符合统计假设，从而评估模型的有效性。</p>
<p><span class="math display">\[
\mathbf{e} = \mathbf{Y} - \mathbf{\hat{Y}}
\]</span></p>
<p>先简单回归我们现有的四个模型：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pegs_mod1<span class="sc">:</span> <span class="fu">lm</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">+</span> species, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>pegs_mod2<span class="sc">:</span> <span class="fu">ivreg</span>(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">|</span> species <span class="sc">|</span> bill_depth <span class="sc">+</span> bill_length, </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>pegs_mod3<span class="sc">:</span> <span class="fu">lm</span>(</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> flipper_length <span class="sc">*</span> species, </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>pegs_mod4<span class="sc">:</span> <span class="fu">ivreg</span>(</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> body_mass <span class="sc">~</span> species <span class="sc">|</span> species <span class="sc">*</span> flipper_length  <span class="sc">|</span> species <span class="sc">*</span> (bill_depth <span class="sc">+</span> bill_length),</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pegs</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>为了更清晰的观察每个模型的综合表现，我们分别计算每一个模型对应的残差和预测值，产生 8 个新的变量；我们将他们合并到原始数据组 <code>pegs</code> 当中，最后的表格结构如下。本小节的残差分析将基于这个扩展的数据组 <code>pegs</code> 进行，而不是原有的 <code>pegs</code> 进行。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate residuals and predictions</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pegs <span class="ot">=</span> (</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_mod1 =</span> <span class="fu">residuals</span>(pegs_mod1), <span class="at">fit_mod1 =</span> <span class="fu">fitted</span>(pegs_mod1),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_mod2 =</span> <span class="fu">residuals</span>(pegs_mod2), <span class="at">fit_mod2 =</span> <span class="fu">fitted</span>(pegs_mod2),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_mod3 =</span> <span class="fu">residuals</span>(pegs_mod3), <span class="at">fit_mod3 =</span> <span class="fu">fitted</span>(pegs_mod3),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_mod4 =</span> <span class="fu">residuals</span>(pegs_mod4), <span class="at">fit_mod4 =</span> <span class="fu">fitted</span>(pegs_mod4)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co"># show dataframe</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Appended Sample of Penguins"</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_if7v5fe6021hezh096ua(i, j, css_id) {
          var table = document.getElementById("tinytable_if7v5fe6021hezh096ua");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_if7v5fe6021hezh096ua(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_if7v5fe6021hezh096ua");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '10', j: 0 }, { i: '10', j: 7 }, { i: '10', j: 4 }, { i: '10', j: 2 }, { i: '10', j: 1 }, { i: '10', j: 8 }, { i: '10', j: 6 }, { i: '10', j: 13 }, { i: '10', j: 5 }, { i: '10', j: 12 }, { i: '10', j: 10 }, { i: '10', j: 11 }, { i: '10', j: 9 }, { i: '10', j: 3 }, { i: '10', j: 14 },  ], css_id: 'tinytable_css_z7ak3dqpqooln7yddt8i',}, 
          { positions: [ { i: '3', j: 0 }, { i: '3', j: 1 }, { i: '2', j: 0 }, { i: '7', j: 1 }, { i: '6', j: 0 }, { i: '5', j: 1 }, { i: '5', j: 0 }, { i: '9', j: 0 }, { i: '6', j: 4 }, { i: '7', j: 0 }, { i: '3', j: 2 }, { i: '2', j: 1 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '6', j: 1 }, { i: '9', j: 2 }, { i: '6', j: 6 }, { i: '9', j: 1 }, { i: '6', j: 5 }, { i: '2', j: 3 }, { i: '3', j: 3 }, { i: '2', j: 2 }, { i: '5', j: 3 }, { i: '6', j: 3 }, { i: '7', j: 3 }, { i: '1', j: 0 }, { i: '9', j: 3 }, { i: '6', j: 7 }, { i: '4', j: 0 }, { i: '1', j: 4 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '8', j: 0 }, { i: '5', j: 4 }, { i: '2', j: 8 }, { i: '7', j: 4 }, { i: '1', j: 1 }, { i: '9', j: 4 }, { i: '6', j: 8 }, { i: '4', j: 1 }, { i: '1', j: 5 }, { i: '2', j: 5 }, { i: '3', j: 5 }, { i: '8', j: 1 }, { i: '5', j: 5 }, { i: '2', j: 9 }, { i: '7', j: 5 }, { i: '1', j: 2 }, { i: '9', j: 5 }, { i: '6', j: 9 }, { i: '4', j: 2 }, { i: '1', j: 6 }, { i: '2', j: 6 }, { i: '3', j: 6 }, { i: '8', j: 2 }, { i: '5', j: 6 }, { i: '2', j: 10 }, { i: '7', j: 6 }, { i: '1', j: 3 }, { i: '9', j: 6 }, { i: '6', j: 10 }, { i: '4', j: 3 }, { i: '1', j: 7 }, { i: '2', j: 7 }, { i: '3', j: 7 }, { i: '8', j: 3 }, { i: '5', j: 7 }, { i: '2', j: 11 }, { i: '7', j: 7 }, { i: '8', j: 7 }, { i: '9', j: 7 }, { i: '6', j: 11 }, { i: '4', j: 4 }, { i: '1', j: 8 }, { i: '9', j: 11 }, { i: '3', j: 8 }, { i: '8', j: 4 }, { i: '5', j: 8 }, { i: '2', j: 12 }, { i: '7', j: 8 }, { i: '8', j: 8 }, { i: '9', j: 8 }, { i: '6', j: 12 }, { i: '4', j: 5 }, { i: '1', j: 9 }, { i: '9', j: 12 }, { i: '3', j: 9 }, { i: '8', j: 5 }, { i: '5', j: 9 }, { i: '2', j: 13 }, { i: '7', j: 9 }, { i: '8', j: 9 }, { i: '9', j: 9 }, { i: '6', j: 13 }, { i: '4', j: 6 }, { i: '1', j: 10 }, { i: '9', j: 13 }, { i: '3', j: 10 }, { i: '8', j: 6 }, { i: '5', j: 10 }, { i: '2', j: 14 }, { i: '7', j: 10 }, { i: '8', j: 10 }, { i: '9', j: 10 }, { i: '6', j: 14 }, { i: '4', j: 7 }, { i: '1', j: 11 }, { i: '9', j: 14 }, { i: '3', j: 11 }, { i: '4', j: 11 }, { i: '5', j: 11 }, { i: '8', j: 12 }, { i: '7', j: 11 }, { i: '8', j: 11 }, { i: '4', j: 9 }, { i: '1', j: 13 }, { i: '4', j: 8 }, { i: '1', j: 12 }, { i: '4', j: 13 }, { i: '3', j: 12 }, { i: '4', j: 12 }, { i: '5', j: 12 }, { i: '8', j: 13 }, { i: '7', j: 12 }, { i: '3', j: 14 }, { i: '4', j: 10 }, { i: '1', j: 14 }, { i: '5', j: 14 }, { i: '5', j: 13 }, { i: '4', j: 14 }, { i: '3', j: 13 }, { i: '8', j: 14 }, { i: '7', j: 13 }, { i: '7', j: 14 },  ], css_id: 'tinytable_css_cy03vv2i2zo1t7ctksu3',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 11 }, { i: '0', j: 5 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 2 }, { i: '0', j: 9 }, { i: '0', j: 1 }, { i: '0', j: 8 }, { i: '0', j: 6 }, { i: '0', j: 13 }, { i: '0', j: 12 }, { i: '0', j: 10 }, { i: '0', j: 7 }, { i: '0', j: 14 },  ], css_id: 'tinytable_css_qd0prgsqiyqjsd3js7y1',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_if7v5fe6021hezh096ua(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_z7ak3dqpqooln7yddt8i, .table th.tinytable_css_z7ak3dqpqooln7yddt8i { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_cy03vv2i2zo1t7ctksu3, .table th.tinytable_css_cy03vv2i2zo1t7ctksu3 { text-align: left; }
      .table td.tinytable_css_qd0prgsqiyqjsd3js7y1, .table th.tinytable_css_qd0prgsqiyqjsd3js7y1 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_if7v5fe6021hezh096ua" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Appended Sample of Penguins</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">species</th>
                <th scope="col" data-row="0" data-col="1">island</th>
                <th scope="col" data-row="0" data-col="2">sex</th>
                <th scope="col" data-row="0" data-col="3">bill_length</th>
                <th scope="col" data-row="0" data-col="4">bill_depth</th>
                <th scope="col" data-row="0" data-col="5">flipper_length</th>
                <th scope="col" data-row="0" data-col="6">body_mass</th>
                <th scope="col" data-row="0" data-col="7">res_mod1</th>
                <th scope="col" data-row="0" data-col="8">fit_mod1</th>
                <th scope="col" data-row="0" data-col="9">res_mod2</th>
                <th scope="col" data-row="0" data-col="10">fit_mod2</th>
                <th scope="col" data-row="0" data-col="11">res_mod3</th>
                <th scope="col" data-row="0" data-col="12">fit_mod3</th>
                <th scope="col" data-row="0" data-col="13">res_mod4</th>
                <th scope="col" data-row="0" data-col="14">fit_mod4</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">Chinstrap</td>
                  <td data-row="1" data-col="1">Dream</td>
                  <td data-row="1" data-col="2">female</td>
                  <td data-row="1" data-col="3">0.47</td>
                  <td data-row="1" data-col="4">0.38</td>
                  <td data-row="1" data-col="5">-0.63</td>
                  <td data-row="1" data-col="6">-0.88</td>
                  <td data-row="1" data-col="7">-0.10</td>
                  <td data-row="1" data-col="8">-0.78</td>
                  <td data-row="1" data-col="9">0.09</td>
                  <td data-row="1" data-col="10">-0.96</td>
                  <td data-row="1" data-col="11">-0.13</td>
                  <td data-row="1" data-col="12">-0.75</td>
                  <td data-row="1" data-col="13">-0.02</td>
                  <td data-row="1" data-col="14">-0.85</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">Gentoo</td>
                  <td data-row="2" data-col="1">Biscoe</td>
                  <td data-row="2" data-col="2">female</td>
                  <td data-row="2" data-col="3">0.45</td>
                  <td data-row="2" data-col="4">-1.09</td>
                  <td data-row="2" data-col="5">1.07</td>
                  <td data-row="2" data-col="6">0.62</td>
                  <td data-row="2" data-col="7">-0.43</td>
                  <td data-row="2" data-col="8">1.05</td>
                  <td data-row="2" data-col="9">-0.39</td>
                  <td data-row="2" data-col="10">1.01</td>
                  <td data-row="2" data-col="11">-0.41</td>
                  <td data-row="2" data-col="12">1.03</td>
                  <td data-row="2" data-col="13">-0.37</td>
                  <td data-row="2" data-col="14">0.99</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">Gentoo</td>
                  <td data-row="3" data-col="1">Biscoe</td>
                  <td data-row="3" data-col="2">male</td>
                  <td data-row="3" data-col="3">1.00</td>
                  <td data-row="3" data-col="4">-0.68</td>
                  <td data-row="3" data-col="5">1.07</td>
                  <td data-row="3" data-col="6">0.90</td>
                  <td data-row="3" data-col="7">-0.15</td>
                  <td data-row="3" data-col="8">1.05</td>
                  <td data-row="3" data-col="9">-0.11</td>
                  <td data-row="3" data-col="10">1.01</td>
                  <td data-row="3" data-col="11">-0.13</td>
                  <td data-row="3" data-col="12">1.03</td>
                  <td data-row="3" data-col="13">-0.09</td>
                  <td data-row="3" data-col="14">0.99</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Gentoo</td>
                  <td data-row="4" data-col="1">Biscoe</td>
                  <td data-row="4" data-col="2">male</td>
                  <td data-row="4" data-col="3">1.11</td>
                  <td data-row="4" data-col="4">-0.94</td>
                  <td data-row="4" data-col="5">1.36</td>
                  <td data-row="4" data-col="6">1.68</td>
                  <td data-row="4" data-col="7">0.43</td>
                  <td data-row="4" data-col="8">1.25</td>
                  <td data-row="4" data-col="9">0.18</td>
                  <td data-row="4" data-col="10">1.50</td>
                  <td data-row="4" data-col="11">0.38</td>
                  <td data-row="4" data-col="12">1.30</td>
                  <td data-row="4" data-col="13">0.30</td>
                  <td data-row="4" data-col="14">1.38</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">Chinstrap</td>
                  <td data-row="5" data-col="1">Dream</td>
                  <td data-row="5" data-col="2">male</td>
                  <td data-row="5" data-col="3">1.46</td>
                  <td data-row="5" data-col="4">1.19</td>
                  <td data-row="5" data-col="5">0.36</td>
                  <td data-row="5" data-col="6">-0.31</td>
                  <td data-row="5" data-col="7">-0.24</td>
                  <td data-row="5" data-col="8">-0.07</td>
                  <td data-row="5" data-col="9">-1.04</td>
                  <td data-row="5" data-col="10">0.73</td>
                  <td data-row="5" data-col="11">-0.17</td>
                  <td data-row="5" data-col="12">-0.15</td>
                  <td data-row="5" data-col="13">-0.45</td>
                  <td data-row="5" data-col="14">0.14</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">Adelie</td>
                  <td data-row="6" data-col="1">Torgersen</td>
                  <td data-row="6" data-col="2">female</td>
                  <td data-row="6" data-col="3">-0.79</td>
                  <td data-row="6" data-col="4">0.02</td>
                  <td data-row="6" data-col="5">-0.35</td>
                  <td data-row="6" data-col="6">-0.81</td>
                  <td data-row="6" data-col="7">-0.49</td>
                  <td data-row="6" data-col="8">-0.32</td>
                  <td data-row="6" data-col="9">-0.83</td>
                  <td data-row="6" data-col="10">0.01</td>
                  <td data-row="6" data-col="11">-0.44</td>
                  <td data-row="6" data-col="12">-0.38</td>
                  <td data-row="6" data-col="13">-1.09</td>
                  <td data-row="6" data-col="14">0.28</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">Gentoo</td>
                  <td data-row="7" data-col="1">Biscoe</td>
                  <td data-row="7" data-col="2">female</td>
                  <td data-row="7" data-col="3">0.34</td>
                  <td data-row="7" data-col="4">-1.49</td>
                  <td data-row="7" data-col="5">1.29</td>
                  <td data-row="7" data-col="6">0.62</td>
                  <td data-row="7" data-col="7">-0.58</td>
                  <td data-row="7" data-col="8">1.20</td>
                  <td data-row="7" data-col="9">-0.76</td>
                  <td data-row="7" data-col="10">1.38</td>
                  <td data-row="7" data-col="11">-0.61</td>
                  <td data-row="7" data-col="12">1.23</td>
                  <td data-row="7" data-col="13">-0.66</td>
                  <td data-row="7" data-col="14">1.28</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">Adelie</td>
                  <td data-row="8" data-col="1">Dream</td>
                  <td data-row="8" data-col="2">female</td>
                  <td data-row="8" data-col="3">-1.36</td>
                  <td data-row="8" data-col="4">0.43</td>
                  <td data-row="8" data-col="5">-1.35</td>
                  <td data-row="8" data-col="6">-1.31</td>
                  <td data-row="8" data-col="7">-0.28</td>
                  <td data-row="8" data-col="8">-1.03</td>
                  <td data-row="8" data-col="9">0.37</td>
                  <td data-row="8" data-col="10">-1.68</td>
                  <td data-row="8" data-col="11">-0.36</td>
                  <td data-row="8" data-col="12">-0.95</td>
                  <td data-row="8" data-col="13">0.54</td>
                  <td data-row="8" data-col="14">-1.85</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">Adelie</td>
                  <td data-row="9" data-col="1">Dream</td>
                  <td data-row="9" data-col="2">male</td>
                  <td data-row="9" data-col="3">-0.44</td>
                  <td data-row="9" data-col="4">0.68</td>
                  <td data-row="9" data-col="5">0.01</td>
                  <td data-row="9" data-col="6">-0.25</td>
                  <td data-row="9" data-col="7">-0.19</td>
                  <td data-row="9" data-col="8">-0.07</td>
                  <td data-row="9" data-col="9">-0.87</td>
                  <td data-row="9" data-col="10">0.62</td>
                  <td data-row="9" data-col="11">-0.08</td>
                  <td data-row="9" data-col="12">-0.17</td>
                  <td data-row="9" data-col="13">-1.30</td>
                  <td data-row="9" data-col="14">1.04</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">Gentoo</td>
                  <td data-row="10" data-col="1">Biscoe</td>
                  <td data-row="10" data-col="2">male</td>
                  <td data-row="10" data-col="3">0.23</td>
                  <td data-row="10" data-col="4">-0.38</td>
                  <td data-row="10" data-col="5">1.57</td>
                  <td data-row="10" data-col="6">2.18</td>
                  <td data-row="10" data-col="7">0.78</td>
                  <td data-row="10" data-col="8">1.40</td>
                  <td data-row="10" data-col="9">0.32</td>
                  <td data-row="10" data-col="10">1.86</td>
                  <td data-row="10" data-col="11">0.68</td>
                  <td data-row="10" data-col="12">1.50</td>
                  <td data-row="10" data-col="13">0.52</td>
                  <td data-row="10" data-col="14">1.66</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>基于这个扩展的数据组 <code>pegs</code>，我们对残差进行以下三项检验流程，分别是：</p>
<ul>
<li>正态性 Normality: 残差的分布应当符合正态分布规律。</li>
<li>多重共线性 Multi-colinearity: 多个自变量之间应该不存在显著的线性相关。</li>
<li>异方差性 Heteroskedasticity: 残差的方差在多个自变量之间应该保持基本稳定。</li>
</ul>
<p>我们希望检验的结果是，残差符合正态分布、变量不存在多重共线性、残差没有异方差性。这样就可以基本推定我们的模型具备较高的严谨性、稳健性、可靠性；我们现在逐个简要介绍这三项检验。</p>
</section>
<section id="normality" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="normality"><span class="header-section-number">1.4.2</span> Normality</h3>
<p>我们现在讨论残差分析的第一个方面：正态性，即残差的分布应该呈现基本的正态分布特征。一般通过 <code>Shapiro-Wilk</code> 进行数值检测和 <code>QQ Plot</code> 进行图形观察，这部分检验的理论已经非常成熟，经典文献可以参考 <span class="citation" data-cites="Shapiro1965">(<a href="#ref-Shapiro1965" role="doc-biblioref"><strong>Shapiro1965?</strong></a>)</span>, <span class="citation" data-cites="Royston1982">(<a href="#ref-Royston1982" role="doc-biblioref"><strong>Royston1982?</strong></a>)</span>, <span class="citation" data-cites="Royston1995">(<a href="#ref-Royston1995" role="doc-biblioref"><strong>Royston1995?</strong></a>)</span>。如果 <code>sw_test()</code> 结果显著，则残差不符合正态分布；反之则符合。而 <code>QQ Plot</code> 能直观地展示残差分布与理论正态分布的吻合程度，它揭示数据点是否紧密地沿着一条直线分布，有助于判断残差是否存在偏离正态分布。但是根据中心极限定理 <a href="https://en.wikipedia.org/wiki/Central_limit_theorem">(Central Limit Theorem)</a>，当样本数量足够大 <span class="math inline">\(n &gt; 100\)</span> 的情况下，即使正态性检验显著，只要 QQ 图没有显示出极端异常的偏离，我们通常也可以接受这个结果，而不必机械地纠结于它在数值上是否“显著”。</p>
<p>回到本案，我们计算 <code>pegs</code> 四个模型的残差 <code>res_mod1, res_mod2, res_mod3, res_mod4</code> 并进行正态性检验，数值结果显示前两个模型 <code>pegs_mod1</code> 和 <code>pegs_mod2</code> 满足正态性要求，但是后两个模型 <code>pegs_mod3</code> 和 <code>pegs_mod4</code> 不满足；而图形结果则提示模型没有特别明显的偏离值，应该是符合正态分布。如前文所述，由于我们的样本量 <span class="math inline">\(N=333\)</span> 足够大，虽然 <code>sw_test()</code> 呈显著结果，但是这种程度的非正态性并不会对我们的最终结论构成严重威胁；我们将此检验结果作为模型稳健性诊断的一个信号，然后踩着小坦克油门继续往下推。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test normality of residuals</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">shapiro.test</span>(pegs<span class="sc">$</span>res_mod1) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>(),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">shapiro.test</span>(pegs<span class="sc">$</span>res_mod2) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>(),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">shapiro.test</span>(pegs<span class="sc">$</span>res_mod3) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>(),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">shapiro.test</span>(pegs<span class="sc">$</span>res_mod4) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>()</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">pv =</span> p.value) <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"pegs_mod1"</span>, <span class="st">"pegs_mod2"</span>, <span class="st">"pegs_mod3"</span>, <span class="st">"pegs_mod4"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(model, statistic, pv, <span class="sc">-</span>method) <span class="sc">%&gt;%</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Normality Test"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_mlp72ecfuqito5je7ea3(i, j, css_id) {
          var table = document.getElementById("tinytable_mlp72ecfuqito5je7ea3");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_mlp72ecfuqito5je7ea3(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_mlp72ecfuqito5je7ea3");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 0 }, { i: '4', j: 1 }, { i: '4', j: 2 },  ], css_id: 'tinytable_css_mbw219z2xjgboi5wm5xz',}, 
          { positions: [ { i: '3', j: 0 }, { i: '3', j: 1 }, { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '2', j: 1 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '1', j: 1 }, { i: '1', j: 2 },  ], css_id: 'tinytable_css_uzo27clkpm902y2yg7g8',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_9lj8rqplci9j9pq6qpjd',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_mlp72ecfuqito5je7ea3(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_mbw219z2xjgboi5wm5xz, .table th.tinytable_css_mbw219z2xjgboi5wm5xz { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_uzo27clkpm902y2yg7g8, .table th.tinytable_css_uzo27clkpm902y2yg7g8 { text-align: left; }
      .table td.tinytable_css_9lj8rqplci9j9pq6qpjd, .table th.tinytable_css_9lj8rqplci9j9pq6qpjd { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_mlp72ecfuqito5je7ea3" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Normality Test</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">model</th>
                <th scope="col" data-row="0" data-col="1">statistic</th>
                <th scope="col" data-row="0" data-col="2">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">pegs_mod1</td>
                  <td data-row="1" data-col="1">0.99</td>
                  <td data-row="1" data-col="2">0.20</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">pegs_mod2</td>
                  <td data-row="2" data-col="1">0.99</td>
                  <td data-row="2" data-col="2">0.09</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">pegs_mod3</td>
                  <td data-row="3" data-col="1">0.99</td>
                  <td data-row="3" data-col="2">0.02</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">pegs_mod4</td>
                  <td data-row="4" data-col="1">0.98</td>
                  <td data-row="4" data-col="2">0.00</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot QQ of mod1</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>sub1 <span class="ot">=</span> (</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> res_mod1, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Theoretical"</span>, <span class="at">y =</span> <span class="st">"Sample"</span>, <span class="at">title =</span> <span class="st">"pegs_mod1"</span>) <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># plot QQ of mod2</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>sub2 <span class="ot">=</span> (</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> res_mod2, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Theoretical"</span>, <span class="at">y =</span> <span class="st">"Sample"</span>, <span class="at">title =</span> <span class="st">"pegs_mod2"</span>) <span class="sc">+</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot QQ of mod3</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>sub3 <span class="ot">=</span> (</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> res_mod3, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Theoretical"</span>, <span class="at">y =</span> <span class="st">"Sample"</span>, <span class="at">title =</span> <span class="st">"pegs_mod3"</span>) <span class="sc">+</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="co"># plot QQ of mod4</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>sub4 <span class="ot">=</span> (</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    pegs <span class="sc">%&gt;%</span> </span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> res_mod4, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Theoretical"</span>, <span class="at">y =</span> <span class="st">"Sample"</span>, <span class="at">title =</span> <span class="st">"pegs_mod4"</span>) <span class="sc">+</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into single figure</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>(sub1, sub2, sub3, sub4) <span class="sc">+</span> </span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">+</span> </span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Fig 2.9: Normality Test"</span>)</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="econ_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multi-colinearity" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="multi-colinearity"><span class="header-section-number">1.4.3</span> Multi-Colinearity</h3>
<p>我们现在讨论残差分析的第二个话题：多重共线性，即某个自变量与另外的自变量之间存在高度相关性。在因果判断时，它的存在会让我们无法精确地辨识出每个自变量的独立影响，即结果 <code>Y</code> 是由因素 <code>D1</code> 所致，但是 <code>D1</code> 又跟 <code>D2</code> 高度线性相关，那说明 <code>D2</code> 也对结果 <code>Y</code> 产生了影响。这是我们不希望遇到的情况，各个自变量的系数估计值会变得不稳定、标准误增大，从而降低了我们对模型结果的信心和精确度。我们主要通过 <code>vif()</code> 函数检测共线性，这部分的经典文献来自于 <span class="citation" data-cites="Belsley1980">(<a href="#ref-Belsley1980" role="doc-biblioref"><strong>Belsley1980?</strong></a>)</span>, <span class="citation" data-cites="Fox2016">(<a href="#ref-Fox2016" role="doc-biblioref"><strong>Fox2016?</strong></a>)</span>，算法得出的 <code>GVIF</code> 作为主要判断标准：</p>
<ul>
<li>如 <code>GVIF &lt; 5</code>，则自变量基本上不存在多重共线性。</li>
<li>如 <code>5 &lt; GVIF &lt; 10</code>，则自变量具有一定共线性。</li>
<li>如 <code>10 &lt; GVIF</code>，则自变量存在严重共线性。</li>
</ul>
<p>从模型结果来看，只有 <code>pegs_mod1</code> 不具有共线性，而其他三个模型都存在共线性，<code>pegs_mod4</code> 的最高共线性甚至冲破了 60。这个问题的主要原因是，我们的自变量当中包含了分类变量，而分别变量被当成哑变量，它与数值变量相乘，会产生很多交互数据，所以导致严重共线性。为了更好地解释模型，我们不再依赖 <code>GVIF</code> 而采信 <code>adj_GVIF</code>，其判断标准依然以 <span class="math inline">\(\text{adj\_GVIF} = 10\)</span> 作为重度共线性的分界。另外，对于已经存在共线性的模型，有时候可以通过 <code>scales()</code> 函数进行处理，但如果共线性是由于自变量本身所引起的，那么即使进行了 <code>scales()</code> 也无法从根本上消除。我们在数据处理的第一步就执行了 <code>scales()</code>，这说明当前观察到的多重共线性是更深层次的结构性问题，而非简单的变量尺度差异所致，因此通过进一步的标准化也难以消除。</p>
<p>回到本案当中，在我们最关心的变量 <code>flipper_length:species</code> 当中，<code>pegs_mod3</code> 具有较少的共线性，但是 <code>pegs_mod4</code> 具有一定的共线性；因此我们虽然可以继续使用 <code>pegs_mod4</code> 但必须谨慎地汇报结果，而不能过于乐观地解读。导致这种较高共线性的原因主要有两个方面：（1）模型交互项，<code>pegs_mod3</code> 和 <code>pegs_mod4</code> 都包含了交互项，交互项很容易与原始的主效应产生相关性。（2）样本量限制，总数据样本只有 3 百多行，这对于 <code>pegs_mod4</code> 这样一个包含了多重交互项的复杂工具变量模型而言，很容易出现高度相关性，导致了在复杂模型中难以避免的共线性问题。另外，需要注意的是，增加分类变量的维度并不会降低共线性，反而通常会因为引入更多的哑变量和交互项而增加多重共线性的风险，特别是在小样本量的情况下。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into a list</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pegs_mods <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod1"</span> <span class="ot">=</span> pegs_mod1,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod2"</span> <span class="ot">=</span> pegs_mod2,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod3"</span> <span class="ot">=</span> pegs_mod3,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pegs_mod4"</span> <span class="ot">=</span> pegs_mod4</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># create UDF to re-run calculation</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>get_gvif <span class="ot">=</span> <span class="cf">function</span>(model, model_name) {</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vif</span>(model) <span class="sc">%&gt;%</span> </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"terms"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">DF =</span> Df, </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">adj_GVIF =</span> <span class="st">`</span><span class="at">GVIF^(1/(2*Df))</span><span class="st">`</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> model_name,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">adj_GVIF =</span> (adj_GVIF)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(model, terms, DF, GVIF, adj_GVIF)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="co"># get gvif results</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>pegs_gvif <span class="ot">=</span> <span class="fu">map2</span>(pegs_mods, <span class="fu">names</span>(pegs_mods), get_gvif) <span class="sc">%&gt;%</span> <span class="fu">list_rbind</span>()</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="co"># show gvif table</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>pegs_gvif <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Multi-colinearity Test"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_vu3kotsv7lzcgm897sqv(i, j, css_id) {
          var table = document.getElementById("tinytable_vu3kotsv7lzcgm897sqv");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_vu3kotsv7lzcgm897sqv(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_vu3kotsv7lzcgm897sqv");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '10', j: 3 }, { i: '10', j: 2 }, { i: '10', j: 1 }, { i: '10', j: 0 }, { i: '10', j: 4 },  ], css_id: 'tinytable_css_adawz6gih1fqhl5mjnok',}, 
          { positions: [ { i: '2', j: 0 }, { i: '4', j: 0 }, { i: '6', j: 0 }, { i: '8', j: 0 }, { i: '1', j: 0 }, { i: '1', j: 2 }, { i: '3', j: 0 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '3', j: 1 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '5', j: 0 }, { i: '8', j: 1 }, { i: '7', j: 0 }, { i: '1', j: 3 }, { i: '9', j: 0 }, { i: '3', j: 3 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '8', j: 2 }, { i: '7', j: 1 }, { i: '1', j: 4 }, { i: '9', j: 1 }, { i: '3', j: 4 }, { i: '2', j: 3 }, { i: '5', j: 4 }, { i: '4', j: 3 }, { i: '5', j: 3 }, { i: '6', j: 3 }, { i: '7', j: 3 }, { i: '8', j: 3 }, { i: '9', j: 3 }, { i: '7', j: 4 }, { i: '9', j: 2 }, { i: '9', j: 4 }, { i: '2', j: 4 }, { i: '4', j: 4 }, { i: '6', j: 4 }, { i: '8', j: 4 },  ], css_id: 'tinytable_css_d2myvlrhi2g91tskqm3v',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 4 }, { i: '0', j: 3 }, { i: '0', j: 2 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_t7hdadp14zz3iye8ezjl',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_vu3kotsv7lzcgm897sqv(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_adawz6gih1fqhl5mjnok, .table th.tinytable_css_adawz6gih1fqhl5mjnok { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_d2myvlrhi2g91tskqm3v, .table th.tinytable_css_d2myvlrhi2g91tskqm3v { text-align: left; }
      .table td.tinytable_css_t7hdadp14zz3iye8ezjl, .table th.tinytable_css_t7hdadp14zz3iye8ezjl { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_vu3kotsv7lzcgm897sqv" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Multi-colinearity Test</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">model</th>
                <th scope="col" data-row="0" data-col="1">terms</th>
                <th scope="col" data-row="0" data-col="2">DF</th>
                <th scope="col" data-row="0" data-col="3">GVIF</th>
                <th scope="col" data-row="0" data-col="4">adj_GVIF</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">pegs_mod1</td>
                  <td data-row="1" data-col="1">flipper_length</td>
                  <td data-row="1" data-col="2">1.00</td>
                  <td data-row="1" data-col="3">4.44</td>
                  <td data-row="1" data-col="4">4.44</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">pegs_mod1</td>
                  <td data-row="2" data-col="1">species</td>
                  <td data-row="2" data-col="2">2.00</td>
                  <td data-row="2" data-col="3">4.44</td>
                  <td data-row="2" data-col="4">2.11</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">pegs_mod2</td>
                  <td data-row="3" data-col="1">species</td>
                  <td data-row="3" data-col="2">2.00</td>
                  <td data-row="3" data-col="3">10.17</td>
                  <td data-row="3" data-col="4">3.19</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">pegs_mod2</td>
                  <td data-row="4" data-col="1">flipper_length</td>
                  <td data-row="4" data-col="2">1.00</td>
                  <td data-row="4" data-col="3">10.17</td>
                  <td data-row="4" data-col="4">10.17</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">pegs_mod3</td>
                  <td data-row="5" data-col="1">flipper_length</td>
                  <td data-row="5" data-col="2">1.00</td>
                  <td data-row="5" data-col="3">10.57</td>
                  <td data-row="5" data-col="4">10.57</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">pegs_mod3</td>
                  <td data-row="6" data-col="1">species</td>
                  <td data-row="6" data-col="2">2.00</td>
                  <td data-row="6" data-col="3">12.36</td>
                  <td data-row="6" data-col="4">3.52</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">pegs_mod3</td>
                  <td data-row="7" data-col="1">flipper_length:species</td>
                  <td data-row="7" data-col="2">2.00</td>
                  <td data-row="7" data-col="3">16.19</td>
                  <td data-row="7" data-col="4">4.02</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">pegs_mod4</td>
                  <td data-row="8" data-col="1">species</td>
                  <td data-row="8" data-col="2">2.00</td>
                  <td data-row="8" data-col="3">76.89</td>
                  <td data-row="8" data-col="4">8.77</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">pegs_mod4</td>
                  <td data-row="9" data-col="1">flipper_length</td>
                  <td data-row="9" data-col="2">1.00</td>
                  <td data-row="9" data-col="3">60.24</td>
                  <td data-row="9" data-col="4">60.24</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">pegs_mod4</td>
                  <td data-row="10" data-col="1">species:flipper_length</td>
                  <td data-row="10" data-col="2">2.00</td>
                  <td data-row="10" data-col="3">88.05</td>
                  <td data-row="10" data-col="4">9.38</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot gvif chart</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    pegs_gvif <span class="sc">%&gt;%</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> terms, <span class="at">y =</span> adj_GVIF, <span class="at">fill =</span> model)) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_iterm</span>() <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Adjusted GVIF"</span>, </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Fig 2.10: Multi-colinearity Test"</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="econ_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="heteroskedasticity" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="heteroskedasticity"><span class="header-section-number">1.4.4</span> Heteroskedasticity</h3>
<p>我们现在讨论残差分析的最后一个方面：异方差性，即残差在整个样本当中的稳定性。</p>
<ul>
<li>异方差性 Heteroskedasticity: 残差的方差随自变量变化而存在显著差异，即残差的变动幅度不是恒定的。</li>
<li>同方差性 Homoskedasticity: 残差的方差随自变量变化而没有显著差异，即残差的变动幅度是恒定的。</li>
</ul>
<p>在线性模型中，我们总是希望模型满足同方差性，而拒绝异方差性；可以简单的认为“异方差性”总是“不好的”、“同方差性”总是“好的”。假如我们一个模型当中有很多个残差，它们被划分为多个小组，选择任意其中的第 <span class="math inline">\(i, \ j\)</span> 两个小组，那么它们各自的方差应该非常接近样本的平均方差，即可得到异质性检验的重要标准：</p>
<p><span class="math display">\[
\sigma_i^2 = \sigma_j^2 = \sigma^2, \quad \forall i \neq j
\]</span></p>
<p>注意，<span class="math inline">\(i,\ j\)</span> 一般都是分类变量，如汽车品牌、车辆颜色、经销商名称、注册城市等等；但这并不是排斥数值变量，某些特定情况的数值变量也可以作为分组依据，但是需要谨慎对待；绝大多数经济学的实证分析依然以分类变量的维度来讨论异方差性。回到本案中，我们有四个模型，但是其中 <code>pegs_mod1, pegs_mod3</code> 是没有交互项的模型，而 <code>pegs_mod2, pegs_mod4</code> 是具有交互项的模型。因此，我们必须根据模型性质分别处理，用现成的 <code>bptest()</code> 检测 OLS-LM 的同方差性，再手动编写一个半自动的 <code>phtest()</code> 检测 IV-LM 的同方差性，有关经典文献可以参考 <span class="citation" data-cites="Breusch1979">(<a href="#ref-Breusch1979" role="doc-biblioref"><strong>Breusch1979?</strong></a>)</span>, <span class="citation" data-cites="Pagan1983">(<a href="#ref-Pagan1983" role="doc-biblioref"><strong>Pagan1983?</strong></a>)</span>, <span class="citation" data-cites="Cameron2005">(<a href="#ref-Cameron2005" role="doc-biblioref"><strong>Cameron2005?</strong></a>)</span>。</p>
<p>我们继续略过算法细节，跑出结果显示 <code>pegs_mod1</code> 显著，即模型中存在异方差；<code>pegs_mod2</code> 处于边缘显著，我们可以从显著或者不显著的视角同时开展分析，但是必须非常小心；<code>pegs_mod3, pegs_mod4</code> 都显著，即模型都存在异方差。但是需要特别注意，因为我们的模型中包含了分类变量的交互项，此时异方差性是较为常见的现象。而至于异方差在模型当中实际反应的深层问题或意义，已经牵扯到它与“研究设计 Research Design”的复杂关联，通常需要对该研究设计具有更深度的掌握和理解；我们暂且不论这些复杂的“研究设计”问题，重点在于理解异方差检验的框架，如果能掌握到这个程度，对于本硕博的论文写作已经很足够了。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### test heterosckedasticity for OLS models</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bptest</span>(pegs_mod1) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"pegs_mod1"</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bptest</span>(pegs_mod3) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"pegs_mod3"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">pv =</span> p.value) <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(model, statistic, pv) <span class="sc">%&gt;%</span> </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Heterosckedasticity Test of OLS Models"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_t0l03xaido5xeheinjuz(i, j, css_id) {
          var table = document.getElementById("tinytable_t0l03xaido5xeheinjuz");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_t0l03xaido5xeheinjuz(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_t0l03xaido5xeheinjuz");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '2', j: 1 }, { i: '2', j: 0 }, { i: '2', j: 2 },  ], css_id: 'tinytable_css_1kl4izb041i7z89emnpn',}, 
          { positions: [ { i: '1', j: 0 }, { i: '1', j: 1 }, { i: '1', j: 2 },  ], css_id: 'tinytable_css_0lyjjcxe95n1eoiypgke',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 2 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_nkz8pkk04ra8iswgiz34',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_t0l03xaido5xeheinjuz(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_1kl4izb041i7z89emnpn, .table th.tinytable_css_1kl4izb041i7z89emnpn { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_0lyjjcxe95n1eoiypgke, .table th.tinytable_css_0lyjjcxe95n1eoiypgke { text-align: left; }
      .table td.tinytable_css_nkz8pkk04ra8iswgiz34, .table th.tinytable_css_nkz8pkk04ra8iswgiz34 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_t0l03xaido5xeheinjuz" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Heterosckedasticity Test of OLS Models</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">model</th>
                <th scope="col" data-row="0" data-col="1">statistic</th>
                <th scope="col" data-row="0" data-col="2">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">pegs_mod1</td>
                  <td data-row="1" data-col="1">8.77</td>
                  <td data-row="1" data-col="2">0.03</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">pegs_mod3</td>
                  <td data-row="2" data-col="1">10.95</td>
                  <td data-row="2" data-col="2">0.05</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### test heterosckedasticity for IV models</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create UDF to run Pagan-Hall test</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>phtest <span class="ot">=</span> <span class="cf">function</span>(iv_model) {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate Pagan-Hall test statistic</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    res_squared <span class="ot">=</span> <span class="fu">I</span>(<span class="fu">residuals</span>(iv_model)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    instruments <span class="ot">=</span> <span class="fu">model.matrix</span>(iv_model, <span class="at">component =</span> <span class="st">"instruments"</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    aux_model <span class="ot">=</span> <span class="fu">lm</span>(res_squared <span class="sc">~</span> instruments <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">=</span> <span class="fu">nobs</span>(iv_model)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    r2 <span class="ot">=</span> <span class="fu">summary</span>(aux_model)<span class="sc">$</span>r.squared</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    test_stat <span class="ot">=</span> n <span class="sc">*</span> r2</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">=</span> <span class="fu">ncol</span>(instruments) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    pv_chi <span class="ot">=</span> <span class="fu">pchisq</span>(test_stat, <span class="at">df =</span> df, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># combine results</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">statistic =</span> test_stat,</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> df,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> pv_chi</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># show results</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(results)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co"># run Pagan-Hall test</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">phtest</span>(pegs_mod2) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"pegs_mod2"</span>),</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">phtest</span>(pegs_mod4) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"pegs_mod4"</span>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(model, statistic, pv) <span class="sc">%&gt;%</span> </span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Heterosckedasticity Test of IV Models"</span>)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_6shw2y1nkcub926rb0df(i, j, css_id) {
          var table = document.getElementById("tinytable_6shw2y1nkcub926rb0df");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_6shw2y1nkcub926rb0df(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_6shw2y1nkcub926rb0df");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '2', j: 1 }, { i: '2', j: 0 }, { i: '2', j: 2 },  ], css_id: 'tinytable_css_bo76vrf00yrp1oc6b96t',}, 
          { positions: [ { i: '1', j: 0 }, { i: '1', j: 1 }, { i: '1', j: 2 },  ], css_id: 'tinytable_css_2z99s7q5poouptay76ds',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 2 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_d3a3in2vstxi531y9g9i',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_6shw2y1nkcub926rb0df(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_bo76vrf00yrp1oc6b96t, .table th.tinytable_css_bo76vrf00yrp1oc6b96t { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_2z99s7q5poouptay76ds, .table th.tinytable_css_2z99s7q5poouptay76ds { text-align: left; }
      .table td.tinytable_css_d3a3in2vstxi531y9g9i, .table th.tinytable_css_d3a3in2vstxi531y9g9i { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_6shw2y1nkcub926rb0df" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Heterosckedasticity Test of IV Models</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">model</th>
                <th scope="col" data-row="0" data-col="1">statistic</th>
                <th scope="col" data-row="0" data-col="2">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">pegs_mod2</td>
                  <td data-row="1" data-col="1">111.56</td>
                  <td data-row="1" data-col="2">0.00</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">pegs_mod4</td>
                  <td data-row="2" data-col="1">109.81</td>
                  <td data-row="2" data-col="2">0.00</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>如果模型具有异方差，我们无法通过简单的模型变换以消除异方差性，最常见的处理方法是使用异方差稳健标准误 (Robust Standard Error)。虽然听起来它很强大，但它实际上并不能消除异方差性。即，它不能调整回归系数 <span class="math inline">\(\hat{\beta_i}\)</span> 本身，它只能适当地调整回归系数的标准误。这意味着，回归系数估计保持不变，但其对应的标准误会被重新计算，以纠正异方差造成的偏差；这个调整后的标准误会用于后续的假设检验和置信区间构建，如一个 95% 的置信区间的计算方法是：<span class="math inline">\(\hat{\beta_i} \pm 1.96 * \text{SE}(\hat{\beta_i})\)</span>。这个区间的结果，就是 RSE 所返回的经过调整后的结果；更多深入理论可以参考经典文献： <span class="citation" data-cites="White1980">(<a href="#ref-White1980" role="doc-biblioref"><strong>White1980?</strong></a>)</span>, <span class="citation" data-cites="Zeileis2004">(<a href="#ref-Zeileis2004" role="doc-biblioref"><strong>Zeileis2004?</strong></a>)</span>, <span class="citation" data-cites="CribariNeto2011">(<a href="#ref-CribariNeto2011" role="doc-biblioref"><strong>CribariNeto2011?</strong></a>)</span>。</p>
<p>换个类比，监狱的劳动改造无法将已经判刑的罪犯直接改判为无罪，被判刑 10 年的犯人依然需要服刑 10 年，但是监狱会对犯人进行劳动改造和就业教育，比如法律学习、电气维修、农业种植、生活服务等等，罪犯依然享受与正常人类似的基本人权。一旦他刑满释放，他的劳动技能可以为其提供基本的生活保障，而不会让他出狱后完全脱离社会节奏；异方差稳健标准误并不改变模型的基本设定或系数估计，而是通过修正标准误，确保我们对系数的假设检验和置信区间依然是有效的和可信的。经过劳动改造的罪犯出狱后应当被“合理预期”是正常人，而不应当被歧视为罪犯；经过稳健控制的实证结果应当被“合理预期”是符合要求的结果汇报在结论中。因此，本案例的四个模型对应的结果表格如下。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show robust table</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> pegs_mods, </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">stars =</span> <span class="cn">TRUE</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="st">"robust"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Robust SE of pegs_mods"</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_bjn8804fh3u2hz7ih5t8(i, j, css_id) {
          var table = document.getElementById("tinytable_bjn8804fh3u2hz7ih5t8");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_bjn8804fh3u2hz7ih5t8(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_bjn8804fh3u2hz7ih5t8");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '17', j: 2 }, { i: '17', j: 1 }, { i: '17', j: 3 }, { i: '17', j: 4 },  ], css_id: 'tinytable_css_66nld82hsz96wxk6bia7',}, 
          { positions: [ { i: '8', j: 2 }, { i: '8', j: 4 }, { i: '8', j: 3 }, { i: '8', j: 1 },  ], css_id: 'tinytable_css_cjl3doqbiifm9ojm9rbc',}, 
          { positions: [ { i: '3', j: 1 }, { i: '4', j: 1 }, { i: '1', j: 1 }, { i: '7', j: 1 }, { i: '3', j: 2 }, { i: '9', j: 1 }, { i: '6', j: 1 }, { i: '11', j: 1 }, { i: '12', j: 1 }, { i: '13', j: 1 }, { i: '14', j: 1 }, { i: '2', j: 1 }, { i: '16', j: 1 }, { i: '12', j: 2 }, { i: '5', j: 1 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '16', j: 2 }, { i: '4', j: 2 }, { i: '10', j: 1 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '3', j: 3 }, { i: '9', j: 2 }, { i: '15', j: 1 }, { i: '11', j: 2 }, { i: '7', j: 3 }, { i: '13', j: 2 }, { i: '14', j: 2 }, { i: '15', j: 2 }, { i: '11', j: 3 }, { i: '12', j: 3 }, { i: '5', j: 2 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '16', j: 3 }, { i: '4', j: 3 }, { i: '10', j: 2 }, { i: '6', j: 3 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '9', j: 3 }, { i: '10', j: 3 }, { i: '6', j: 4 }, { i: '7', j: 4 }, { i: '13', j: 3 }, { i: '14', j: 3 }, { i: '15', j: 3 }, { i: '11', j: 4 }, { i: '12', j: 4 }, { i: '5', j: 3 }, { i: '1', j: 4 }, { i: '15', j: 4 }, { i: '16', j: 4 }, { i: '4', j: 4 }, { i: '5', j: 4 }, { i: '10', j: 4 }, { i: '9', j: 4 }, { i: '14', j: 4 }, { i: '13', j: 4 },  ], css_id: 'tinytable_css_gkl51cs1sdxboat7wpdj',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 4 }, { i: '0', j: 3 },  ], css_id: 'tinytable_css_88hyb7kzqhmo344gbviz',}, 
          { positions: [ { i: '17', j: 0 },  ], css_id: 'tinytable_css_9xi2z8jw2s2j3vocmjw9',}, 
          { positions: [ { i: '8', j: 0 },  ], css_id: 'tinytable_css_9qfyva316ovz8jhbocen',}, 
          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '7', j: 0 }, { i: '12', j: 0 }, { i: '9', j: 0 }, { i: '10', j: 0 }, { i: '11', j: 0 }, { i: '16', j: 0 }, { i: '13', j: 0 }, { i: '14', j: 0 }, { i: '15', j: 0 },  ], css_id: 'tinytable_css_m53gagut53takk0lk2rs',}, 
          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_kdnvpzb4fud00vhdx1zw',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_bjn8804fh3u2hz7ih5t8(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_66nld82hsz96wxk6bia7, .table th.tinytable_css_66nld82hsz96wxk6bia7 { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_cjl3doqbiifm9ojm9rbc, .table th.tinytable_css_cjl3doqbiifm9ojm9rbc { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_gkl51cs1sdxboat7wpdj, .table th.tinytable_css_gkl51cs1sdxboat7wpdj { text-align: center; }
      .table td.tinytable_css_88hyb7kzqhmo344gbviz, .table th.tinytable_css_88hyb7kzqhmo344gbviz { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_9xi2z8jw2s2j3vocmjw9, .table th.tinytable_css_9xi2z8jw2s2j3vocmjw9 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_9qfyva316ovz8jhbocen, .table th.tinytable_css_9qfyva316ovz8jhbocen { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_m53gagut53takk0lk2rs, .table th.tinytable_css_m53gagut53takk0lk2rs { text-align: left; }
      .table td.tinytable_css_kdnvpzb4fud00vhdx1zw, .table th.tinytable_css_kdnvpzb4fud00vhdx1zw { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_bjn8804fh3u2hz7ih5t8" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Robust SE of pegs_mods</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0"> </th>
                <th scope="col" data-row="0" data-col="1">pegs_mod1</th>
                <th scope="col" data-row="0" data-col="2">pegs_mod2</th>
                <th scope="col" data-row="0" data-col="3">pegs_mod3</th>
                <th scope="col" data-row="0" data-col="4">pegs_mod4</th>
              </tr>
        
        </tbody><tfoot><tr><td colspan="5">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr></tfoot>
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">(Intercept)</td>
                  <td data-row="1" data-col="1">-0.070</td>
                  <td data-row="1" data-col="2">0.608***</td>
                  <td data-row="1" data-col="3">-0.177*</td>
                  <td data-row="1" data-col="4">1.031***</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">flipper_length</td>
                  <td data-row="2" data-col="1">0.712***</td>
                  <td data-row="2" data-col="2">1.701***</td>
                  <td data-row="2" data-col="3">0.573***</td>
                  <td data-row="2" data-col="4">2.145***</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">speciesChinstrap</td>
                  <td data-row="3" data-col="1">-0.256***</td>
                  <td data-row="3" data-col="2">-0.493*</td>
                  <td data-row="3" data-col="3">-0.188+</td>
                  <td data-row="3" data-col="4">-1.256***</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">speciesGentoo</td>
                  <td data-row="4" data-col="1">0.355**</td>
                  <td data-row="4" data-col="2">-1.419***</td>
                  <td data-row="4" data-col="3">0.186</td>
                  <td data-row="4" data-col="4">-1.489***</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">flipper_length × speciesChinstrap</td>
                  <td data-row="5" data-col="1"></td>
                  <td data-row="5" data-col="2"></td>
                  <td data-row="5" data-col="3">0.033</td>
                  <td data-row="5" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">flipper_length × speciesGentoo</td>
                  <td data-row="6" data-col="1"></td>
                  <td data-row="6" data-col="2"></td>
                  <td data-row="6" data-col="3">0.377***</td>
                  <td data-row="6" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">speciesChinstrap × flipper_length</td>
                  <td data-row="7" data-col="1"></td>
                  <td data-row="7" data-col="2"></td>
                  <td data-row="7" data-col="3"></td>
                  <td data-row="7" data-col="4">-1.151**</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">speciesGentoo × flipper_length</td>
                  <td data-row="8" data-col="1"></td>
                  <td data-row="8" data-col="2"></td>
                  <td data-row="8" data-col="3"></td>
                  <td data-row="8" data-col="4">-0.794*</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">Num.Obs.</td>
                  <td data-row="9" data-col="1">333</td>
                  <td data-row="9" data-col="2">333</td>
                  <td data-row="9" data-col="3">333</td>
                  <td data-row="9" data-col="4">333</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">R2</td>
                  <td data-row="10" data-col="1">0.787</td>
                  <td data-row="10" data-col="2">0.564</td>
                  <td data-row="10" data-col="3">0.794</td>
                  <td data-row="10" data-col="4">0.543</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="0">R2 Adj.</td>
                  <td data-row="11" data-col="1">0.785</td>
                  <td data-row="11" data-col="2">0.560</td>
                  <td data-row="11" data-col="3">0.791</td>
                  <td data-row="11" data-col="4">0.536</td>
                </tr>
                <tr>
                  <td data-row="12" data-col="0">AIC</td>
                  <td data-row="12" data-col="1">441.7</td>
                  <td data-row="12" data-col="2">680.0</td>
                  <td data-row="12" data-col="3">435.0</td>
                  <td data-row="12" data-col="4">699.7</td>
                </tr>
                <tr>
                  <td data-row="13" data-col="0">BIC</td>
                  <td data-row="13" data-col="1">460.7</td>
                  <td data-row="13" data-col="2">699.1</td>
                  <td data-row="13" data-col="3">461.6</td>
                  <td data-row="13" data-col="4">726.4</td>
                </tr>
                <tr>
                  <td data-row="14" data-col="0">Log.Lik.</td>
                  <td data-row="14" data-col="1">-215.845</td>
                  <td data-row="14" data-col="2"></td>
                  <td data-row="14" data-col="3">-210.488</td>
                  <td data-row="14" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="15" data-col="0">F</td>
                  <td data-row="15" data-col="1">464.091</td>
                  <td data-row="15" data-col="2"></td>
                  <td data-row="15" data-col="3">318.591</td>
                  <td data-row="15" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="16" data-col="0">RMSE</td>
                  <td data-row="16" data-col="1">0.46</td>
                  <td data-row="16" data-col="2">0.66</td>
                  <td data-row="16" data-col="3">0.46</td>
                  <td data-row="16" data-col="4">0.68</td>
                </tr>
                <tr>
                  <td data-row="17" data-col="0">Std.Errors</td>
                  <td data-row="17" data-col="1">HC3</td>
                  <td data-row="17" data-col="2">HC3</td>
                  <td data-row="17" data-col="3">HC3</td>
                  <td data-row="17" data-col="4">HC3</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot robust models</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">modelplot</span>(<span class="at">model =</span> pegs_mods, <span class="at">vcov =</span> <span class="st">"robust"</span>) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Coefficient and 95% CI"</span>, <span class="at">y =</span> <span class="st">""</span>, </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Fig 2.11: Summary of Robust Models"</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="econ_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">1.5</span> Conclusion</h2>
<p>至此，我们已经跑完了一个 Linear Model 最主要的环节，有必要进行一些小结；我们开着小坦克突突突往前冲，略过了很多细节，是为了集中大家的注意力在最核心的原理上。希望同学们在学习过程中，不要被花里胡哨的数学证明所迷惑，始终关注在基础原理和逻辑思维上；抓基层、打基础、苦练基本功。</p>
<ul>
<li>Modeling
<ul>
<li>对原始数据进行必要的清洗，形成干净数据 tidy data；</li>
<li>严肃的文章应当保留完整的数据清理代码，而不能只提供一个数据结果；</li>
<li>明确研究设计的主体架构，初步梳理可能的因果关系传导机制和影响强度；</li>
<li>建立简单的多元回归模型 <code>lm(Y ~ X)</code> 观察基准回归结果；</li>
</ul></li>
<li>Exogeneity
<ul>
<li>将简单模型扩展至工具变量模型 <code>ivreg(Y ~ X_exo | X_edo | Z)</code>；</li>
<li>根据 2SLS 开展 Weak Instrument, Wu-Hausman, Sargan 检验；</li>
<li>如果不存在内生性，则继续使用 OLS-LM；如果存在内生性，则考虑使用 IV-LM；</li>
<li>工具变量需要耐心、运气、想象力，不要着急，在失败中寻找正确的路径；</li>
</ul></li>
<li>Heterogeneity
<ul>
<li>在原有模型中增加交互项目，将 “+” 改成 “*“；</li>
<li>若是 OLS-LM: <code>lm(Y ~ X1 * X2)</code>；</li>
<li>若是 IV-LM: <code>ivreg(Y ~ X_exo | X_exo * X_edo | X_exo * Z)</code>；</li>
<li>注意观察 Groupwise VS Pairwise 差异性，有时候会爆大装备；</li>
</ul></li>
<li>Residuals
<ul>
<li>正态性，使用 <code>shapiro.test()</code> 检验，同时参考 <code>QQ</code> 图形；</li>
<li>多重共线性，使用 <code>vif()</code> 检验，主要参考 <code>adj_GVIF</code> 的结果；</li>
<li>异方差性，使用 <code>bptest()</code> 检验 OLS-LM，使用 <code>phtest()</code> 检验 IV-LM；</li>
<li>模型异方差无法根治，可以通过 <code>vcov = "robust"()</code> 进行稳健性调整；</li>
</ul></li>
</ul>
</section>
</section>
<section id="did" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> DID</h1>
<section id="sec-did-overview" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-did-overview"><span class="header-section-number">2.1</span> Overview</h2>
<section id="description-1" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="description-1"><span class="header-section-number">2.1.1</span> Description</h3>
<p>双重差分 (DID) 是当前经管领域用于评估政策或事件因果效应的核心计量工具，它对于政策分析有非常重要的意义。在深入讨论前，我们先举一个简单的例子，以感性认识带动理性认识。</p>
<p>某大学经济学院希望评估“使用英文原版教材授课”的效果。我们选择两个非人为干预的学生班级，每班大约30人，具有基本相似的高考背景和学术能力，上学期期末考试的平均成绩分别是 67 和 69分。我们让其中一个班作为实验组 treat 使用英文原版教材授课，另一个班级作为控制组 control 继续沿用中国教材授课；假设两位老师交叉上课、上课水平、上课态度、上课时长都基本一致。一个学期后，进行同样试卷的考试，统计分数发现，英文教材授课的学生期末考试成绩从上学期的 67 分提高到 77 分，提高 <span class="math inline">\(\Delta_1 = 10\)</span>；中文教材授课的学生的期末考试成绩从上学期的 69 分提高到 72 分，提高 <span class="math inline">\(\Delta_2 = 3\)</span>。通过比较实验组和控制组在上学期和本学期的成绩变化，我们发现实验组在政策后期的成绩额外提高了 <span class="math inline">\(\Delta_1 - \Delta_2 = 7\)</span>，这说明“使用英文原版教材授课”确实提高了同学的考试成绩。文字比较绕，我们可以用一个表格，非常清晰地表示如下：</p>
<table class="caption-top table">
<caption>Simple DID Example</caption>
<thead>
<tr class="header">
<th></th>
<th>last-term</th>
<th>this-term</th>
<th>increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Eng-books</td>
<td>67</td>
<td>77</td>
<td>10</td>
</tr>
<tr class="even">
<td>Chi-books</td>
<td>69</td>
<td>72</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>这个简单的案例最大程度地描述了 DID 的原理，我们现在从特例推广到一般。一个标准的 DID 模型的演化逻辑是由一项“政策冲击 Policy Shock”无差别地、从外部地、突然地影响了观测对象；其中受到政策冲击的是“实验组 Treat”，未受到政策冲击的是“控制组 Control”；政策发生之前的时间状态是 Pre-Policy，政策发生后的时间状态是 Post-Policy。那么我们通过观察实验组和控制组在政策前和政策后的差异程度，来分析政策的净效应；即如下表格所示：</p>
<table class="caption-top table">
<caption>Basic DID Framework</caption>
<colgroup>
<col style="width: 14%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>group/time</th>
<th>pre-policy</th>
<th>post-policy</th>
<th>difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>treat</td>
<td><span class="math inline">\(Y_{tre, pre}\)</span></td>
<td><span class="math inline">\(Y_{tre, pos}\)</span></td>
<td><span class="math inline">\(Y_{tre, pos} - Y_{tre, pre}\)</span></td>
</tr>
<tr class="even">
<td>control</td>
<td><span class="math inline">\(Y_{con, pre}\)</span></td>
<td><span class="math inline">\(Y_{con, pos}\)</span></td>
<td><span class="math inline">\(Y_{con, pos} - Y_{con, pre}\)</span></td>
</tr>
</tbody>
</table>
<p>从这个表格可以推导 DID 估计量，即，在排除掉控制组的时间趋势后，政策冲击对实验组的净效应，也称“对处理组的平均处理效应 Average Treatment Effect on the Treated, ATT”。专业名词太绕口了，它的原理很简单，就是先算实验组前后的变化 <span class="math inline">\(\Delta_{\text{tre}}\)</span>，再算控制组前后的变化 <span class="math inline">\(\Delta_{\text{con}}\)</span> ，最后用前者减去后者 <span class="math inline">\(\Delta_{\text{tre}} - \Delta_{\text{con}}\)</span>，一共两次差分，所以叫“双重差分 Difference-in-Differences”，就是这么简单粗暴。可以表示如下：</p>
<p><span class="math display">\[
\text{DID} = (Y_{tre, pos} - Y_{tre, pre}) - (Y_{con, pos} - Y_{con, pre})
\]</span></p>
</section>
<section id="advantages" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="advantages"><span class="header-section-number">2.1.2</span> Advantages</h3>
<p>我们已经在前面详细讨论过 LM，既然它已经很完整丰富，为什么还需要另外用 DID 模型？换言之，DID 相对于传统的 LM 的必要性和先进性在哪里？是否存在一些问题是 LM 无法解决或者解决效果并不尽如人意？以及 DID 是如何解决这些困难？为了从更深度的哲学高度掌握 DID 的核心价值，我们有必要分析传统 LM 存在的三个严重局限性。</p>
<ul>
<li><p>选择偏误 Selection Bias: 实验组和控制组的划分并非完全随机，可能存在较大的隐形的先天差异，从而导致估计量偏误。比如，实验组的学生可能本身学习能力更强、学习态度更投入、学习资源更充沛等原因，从而导致实验组同学的成绩提升更多，而不是因为教材的原因导致的成绩增加。</p></li>
<li><p>时间趋势偏误 Time Trend Bias: 在政策实施期间，影响所有个体的外部环境可能发生较大的隐形的变化，从而混淆政策效应的估计。比如，在政策实施期间，学校可能整体提升了教学质量、增加了课外辅导资源、降低了考试难度，从而会影响所有学生的成绩，最终导致成绩提升的原因并非完全是教材的变化。</p></li>
<li><p>遗漏交互项偏误 Omited Interaction Bias: 即使将实验组组、控制组、政策前、政策后的所有变量都放入模型中，如果没有交互项，传统的线性模型只能估计组别之间的平均差异和一个共同的时间趋势；它无法捕捉到政策对实验组产生的额外的、区别于控制组自身的影响，即，排除了组间固有差异和共同时间趋势后的净效应。</p></li>
</ul>
<p>DID 模型正好完美解决了这三个局限性。首先它通过组内差分消除了不随时间变化的组间固有差异，从而解决了选择偏误；其次它通过组间差分剥离了影响所有个体的共同时间趋势，从而解决了时间趋势偏误；最后它通过交互项系数精确量化了政策冲击排除掉所有混淆因素后对处理组的净效应，从而解决了遗漏交互项偏误。综上所述，DID 自从 2010 年以来在经济管理领域中变得愈发流行，并迅速成为评估政策因果效应的“扛把子”；相较于简单的线性回归模型，它能更有效地识别因果关系；相比于复杂的机器学习模型，它更容易理解和解释。这些因素使得 DID 在理论和实践上都具有很强的生命力，我们将简要介绍它的重要假设、数学公式、算法原理，然后用一个真实案例进行实战。</p>
</section>
<section id="pta" class="level3" data-number="2.1.3">
<h3 data-number="2.1.3" class="anchored" data-anchor-id="pta"><span class="header-section-number">2.1.3</span> PTA</h3>
<p>在前述的 DID 模型中，它隐含了一个重要的假设，即“平行趋势假设 Parallel Trend Assumption”，我们故意把它放在本小节的最后，是为了避免过多的理论在前部分对同学的感性认识造成较大压力，现在是比较合适的时机。所谓“平行趋势假设 PTA” 是指，在无政策干预下，实验组与控制组的结果变量随时间的变化路径应基本平行；比如实验组变动了 10 个单位，那么控制组也应该是变化 10 个单位左右，控制组的变化既不能严重过大（比如 50 个单位）、过小（比如 0.1 个单位）、更不可能反向变化。用数学表示即为，实验组和控制组的斜率需要保持基本一致，即：</p>
<p><span class="math display">\[
\text{k}_{\text{tre}} \approx \text{k}_{\text{con}}
\]</span></p>
<p>那么很显然，以下情况就是典型的违反了 PTA 的案例：</p>
<ul>
<li>实验组和控制组的增幅相差太大，明显超过了合理的、平行的、可接受的范围。</li>
<li>实验组和控制组的增幅完全相反，即一个积极上升而另一个消极下降。</li>
</ul>
<p>可惜的是，我们很难通过某种算法精确地验证 PTA，它并不是一个可以被直接“证明或证伪”的假设，而更依赖多期趋势图、安慰剂检验、事件研究法等方法，以图表和数值联合检验，这既是政策分析的挑战也是魅力。一方面，我们终于不必被 <span class="math inline">\(p&lt;0.05\)</span> 的机械标准所束缚，可以在尊重数据和逻辑的前提下更好地发挥学术洞察力与创造力；另一方面，我们失去了最权威的甄别标准，一项处于边缘显著状态 <span class="math inline">\(0.05 &lt; p &lt; 0.06\)</span> 的政策具有了很多种不同的解释。而且在多种解释之间，学者们往往很难达成共识，因此我们更看重实实在在的“经济性、合理性、稳健性”，它们在社会生活中对于人民群众产生了直接影响。我们需要跳出教条主义的框架，以更加动态灵活的方式来剖析政策导致的非常复杂效应，政策效应有时候会延迟、有时候会提前、有时候会震荡波动。更多关于 PTA 的量化检验将会在后续通过代码直接计算，现在不做过多数学推理；“好读书、不求甚解”在经济学初期是非常有益处的学习方式。</p>
</section>
<section id="formula-and-code" class="level3" data-number="2.1.4">
<h3 data-number="2.1.4" class="anchored" data-anchor-id="formula-and-code"><span class="header-section-number">2.1.4</span> Formula and Code</h3>
<p>但是上述的 DID 原理只是提出了最广义的逻辑，它并没有回答“如何计算具体的数值”这个问题，我们需要将其转为线性回归模型以便进行量化分析。根据 <span class="citation" data-cites="Card1994">(<a href="#ref-Card1994" role="doc-biblioref"><strong>Card1994?</strong></a>)</span>, <span class="citation" data-cites="Eissa1996">(<a href="#ref-Eissa1996" role="doc-biblioref"><strong>Eissa1996?</strong></a>)</span>, <span class="citation" data-cites="Duflo2001">(<a href="#ref-Duflo2001" role="doc-biblioref"><strong>Duflo2001?</strong></a>)</span>, <span class="citation" data-cites="Bertrand2004">(<a href="#ref-Bertrand2004" role="doc-biblioref"><strong>Bertrand2004?</strong></a>)</span>, <span class="citation" data-cites="Qian2008">(<a href="#ref-Qian2008" role="doc-biblioref"><strong>Qian2008?</strong></a>)</span>, <span class="citation" data-cites="Angrist2009">(<a href="#ref-Angrist2009" role="doc-biblioref"><strong>Angrist2009?</strong></a>)</span> 等经典文献，我们不加证明地给出 DID 的数学公式如下：</p>
<p><span class="math display">\[
Y_{it}
    =
    \beta_0
    + \beta_1 \text{Treat}_i
    + \beta_2 \text{Post}_t
    + \beta_3 (\text{Treat}_i \times \text{Post}_t)
    + \epsilon_{it}
\]</span></p>
<p>其中：</p>
<ul>
<li><span class="math inline">\(Y_{it}\)</span>: 结果变量，即个体 <span class="math inline">\(i\)</span> 在时间 <span class="math inline">\(t\)</span> 的观测值。</li>
<li><span class="math inline">\(\text{Treat}_i\)</span>: 若 <span class="math inline">\(i\)</span> 是实验组，则为 1，若 <span class="math inline">\(i\)</span> 控制组则为 0。</li>
<li><span class="math inline">\(\text{Post}_t\)</span>: 若 <span class="math inline">\(t\)</span> 是在政策冲击之后，则为 1，若 <span class="math inline">\(t\)</span> 在政策冲击之前则为 0。</li>
<li><span class="math inline">\(\text{Treat}_i \times \text{Post}_t\)</span>: 交互项目，只有 <span class="math inline">\(i\)</span> 是实验组且 <span class="math inline">\(t\)</span> 是在政策之后才为 1，否则为 0。</li>
<li><span class="math inline">\(\epsilon_{it}\)</span>: 残差项，表示其他未被模型解释的部分。</li>
<li><span class="math inline">\(\beta_1\)</span>: 实验组相对于控制组在政策冲击之前的平均差异。</li>
<li><span class="math inline">\(\beta_2\)</span>: 控制组在政策冲击前后的平均差异。</li>
<li><span class="math inline">\(\beta_3\)</span>: 实验组在政策冲击后的变化与控制组在政策冲击后的变化之间的差异。</li>
</ul>
<p>我们重点讨论 <span class="math inline">\(\beta_3\)</span> 的统计学意义，在满足平行趋势假设的前提下，它衡量政策对处理组的平均处理效应（Average Treatment Effect on the Treated, ATT）。如果它显著，那就说明政策确实对实验组起到了刺激作用，这意味着该政策确实对处理组产生了显著的因果效应，即政策起到了“原因”的作用，从而产生了“结果”改变。如果它不显著，那就说明在政策冲击后，处理组和控制组的结果变量之间并未观察到显著的额外差异，可以认为该政策不具有显著的因果效应。</p>
<p>为了计算这个结果，我们需要将数学公式转为 <code>R</code> 代码，幸运的是这部分“公式 —— 代码”的转换工作已经被神包 <code>fixest</code> 完成，它是专门处理 panel data 的神包，用它来应付 DID 只是小菜一碟。我们“拿来主义”直接得到一个标准 DID 算法框架，开启案例实战；对它的深入细节感兴趣的同学请参考官网 <a href="https://lrberge.github.io/fixest/"><code>fixest</code></a>。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> Treat <span class="sc">*</span> Post <span class="sc">|</span> FE1 <span class="sc">+</span> FE2, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>其中：</p>
<ul>
<li><code>Y</code>: 结果变量。</li>
<li><code>Treat</code>: 在该列中，以 1 表示实验组，以 0 表示控制组。</li>
<li><code>Post</code>: 在该列中，以 1 表示政策冲击之后，以 0 表示政策冲击之前。</li>
<li><code>*</code>: 即 <code>Treat * Post</code> 的交互项，即之前多次强调的 <span class="math inline">\(\beta_3\)</span> ATT 的系数。</li>
<li><code>|</code>: 固定效应的分隔符，左侧是因变量和自变量，右侧是固定效应。</li>
<li><code>FE1, FE2</code>: Fixed Effects，约定俗成的表述是 <code>FE1</code> 代表个体固定效应，<code>FE2</code> 代表时间固定效应。</li>
</ul>
<p>特别注意的是，<code>Treat, Post</code> 两个变量在双向固定效应模型中通常会被组别固定效应吸收，而不会再单独估计，即，我们一般不考虑它们单独的系数大小和显著性，只关注它们联合的显著性，但它们本身应该保留，而不能贸然删去。另外，<code>FE1, FE2</code> 是必须要有的项目，其中 <code>FE1</code> 有助于控制不随时间变化的个体异质性，如学生自身的学习能力、家庭背景等；<code>FE2</code> 有助于控制不随个体变化但随时间变化的共同冲击，如学校整体教学改革、考试难度调整等。这两个固定效应共同构成了一个标准的“双向固定效应 Two-Way Fixed Effects”，不理解也没事，我们暂时不需要知道它具体是什么意思。至此，一个标准的 DID 流程就介绍完毕，至于深入的理论和计算暂且不论，直接转入实战。</p>
</section>
</section>
<section id="modeling" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="modeling"><span class="header-section-number">2.2</span> Modeling</h2>
<section id="sec-did-modeling" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="sec-did-modeling"><span class="header-section-number">2.2.1</span> Base Model</h3>
<p>我们现在将前面的理论与代码结合起来，看看一个完整的 DID 流程具体包括哪些步骤。2020 年某省公安厅实行“交通安全年”，从严整治酒驾行为，目的是在于尽力遏制酒驾所致的重大交通事故。该政策自 6 月 1 日生效，先从核心城市 A 和 B 市试行，暂时不在 C 和 D 市开展，如果政策效果好，则后续继续扩展试点范围；如果政策效果不太好，则停止该政策。这个数据组名为 <code>dui</code>，这是美国法律规定的 Driving Under Influence，它对应中国刑法第133条规定的“危险驾驶罪”的醉驾行为和刑法第144条规定的“以危险方法危害公共安全罪”的毒驾行为。我们先不深入讨论中国、美国之间的刑法原理差异性，读取数据发现它包含 5 列，简要解释如下：</p>
<ul>
<li>第一列 <code>date</code> 是时间列，其数据格式是来自于 <code>lubridate</code> (处理时间序列的神包) 的 <code>date</code> 格式。</li>
<li>第二列 <code>city</code> 代表 <code>AAA, BBB, CCC, DDD</code> 四个已经脱密的城市名称。</li>
<li>第三列 <code>cases</code> 代表当月查处的醉酒驾驶机动车的案件数量，毒驾行为暂时不做讨论。</li>
<li>第四列 <code>cars</code> 代表当月机动车的平均交通压力，数据由交警支队提供，反应早晚高峰交通的拥堵情况。</li>
<li>第五列 <code>bikes</code> 代表代表非机动车的平均交通压力，数值由交警支队提供。</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set random seed for reproducibility</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create sample data</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>dui <span class="ot">=</span> (</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> <span class="fu">ymd</span>(<span class="st">"2020-1-1"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">AAA_cases =</span> <span class="fu">c</span>(<span class="dv">54</span>, <span class="dv">64</span>, <span class="dv">53</span>, <span class="dv">45</span>, <span class="dv">41</span>, <span class="dv">42</span>, <span class="dv">26</span>, <span class="dv">22</span>, <span class="dv">20</span>, <span class="dv">24</span>, <span class="dv">17</span>, <span class="dv">16</span>),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">BBB_cases =</span> <span class="fu">c</span>(<span class="dv">38</span>, <span class="dv">50</span>, <span class="dv">41</span>, <span class="dv">37</span>, <span class="dv">35</span>, <span class="dv">36</span>, <span class="dv">24</span>, <span class="dv">19</span>, <span class="dv">15</span>, <span class="dv">19</span>, <span class="dv">11</span>, <span class="dv">11</span>),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">CCC_cases =</span> <span class="fu">c</span>(<span class="dv">81</span>, <span class="dv">92</span>, <span class="dv">67</span>, <span class="dv">64</span>, <span class="dv">58</span>, <span class="dv">54</span>, <span class="dv">64</span>, <span class="dv">71</span>, <span class="dv">82</span>, <span class="dv">93</span>, <span class="dv">83</span>, <span class="dv">81</span>),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">DDD_cases =</span> <span class="fu">c</span>(<span class="dv">101</span>, <span class="dv">123</span>, <span class="dv">108</span>, <span class="dv">99</span>, <span class="dv">83</span>, <span class="dv">82</span>, <span class="dv">79</span>, <span class="dv">85</span>, <span class="dv">106</span>, <span class="dv">112</span>, <span class="dv">106</span>, <span class="dv">104</span>),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">AAA_cars =</span> <span class="dv">1000</span> <span class="sc">*</span> AAA_cases <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">10</span>, <span class="dv">3</span>),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">BBB_cars =</span> <span class="dv">1000</span> <span class="sc">*</span> BBB_cases <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">10</span>, <span class="dv">3</span>),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">CCC_cars =</span> <span class="dv">5000</span> <span class="sc">*</span> CCC_cases <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">10</span>, <span class="dv">3</span>),</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">DDD_cars =</span> <span class="dv">5000</span> <span class="sc">*</span> DDD_cases <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">10</span>, <span class="dv">3</span>),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">AAA_bikes =</span> <span class="dv">1000</span> <span class="sc">*</span> AAA_cars <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">BBB_bikes =</span> <span class="dv">1000</span> <span class="sc">*</span> BBB_cars <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">CCC_bikes =</span> <span class="dv">1000</span> <span class="sc">*</span> CCC_cars <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">DDD_bikes =</span> <span class="dv">1000</span> <span class="sc">*</span> CCC_cars <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="sc">-</span>date,</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"city"</span>, <span class="st">".value"</span>),</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_sep =</span> <span class="st">"_"</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cars =</span> <span class="fu">log</span>(cars), <span class="at">bikes =</span> <span class="fu">log</span>(bikes))</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="co"># show sample data</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    dui <span class="sc">%&gt;%</span> </span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Sample of DUI"</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_yotmhfzyknbt9wc889sv(i, j, css_id) {
          var table = document.getElementById("tinytable_yotmhfzyknbt9wc889sv");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_yotmhfzyknbt9wc889sv(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_yotmhfzyknbt9wc889sv");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '10', j: 3 }, { i: '10', j: 2 }, { i: '10', j: 1 }, { i: '10', j: 0 }, { i: '10', j: 4 },  ], css_id: 'tinytable_css_l1l6wz57ay7rzpo0f3q3',}, 
          { positions: [ { i: '2', j: 0 }, { i: '4', j: 0 }, { i: '6', j: 0 }, { i: '8', j: 0 }, { i: '1', j: 0 }, { i: '1', j: 2 }, { i: '3', j: 0 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '3', j: 1 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '5', j: 0 }, { i: '8', j: 1 }, { i: '7', j: 0 }, { i: '1', j: 3 }, { i: '9', j: 0 }, { i: '3', j: 3 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '8', j: 2 }, { i: '7', j: 1 }, { i: '1', j: 4 }, { i: '9', j: 1 }, { i: '3', j: 4 }, { i: '2', j: 3 }, { i: '5', j: 4 }, { i: '4', j: 3 }, { i: '5', j: 3 }, { i: '6', j: 3 }, { i: '7', j: 3 }, { i: '8', j: 3 }, { i: '9', j: 3 }, { i: '7', j: 4 }, { i: '9', j: 2 }, { i: '9', j: 4 }, { i: '2', j: 4 }, { i: '4', j: 4 }, { i: '6', j: 4 }, { i: '8', j: 4 },  ], css_id: 'tinytable_css_8xch2fclac1rkegg0rm4',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 4 }, { i: '0', j: 3 }, { i: '0', j: 2 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_0gi9mmcgl6xg0myblef9',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_yotmhfzyknbt9wc889sv(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_l1l6wz57ay7rzpo0f3q3, .table th.tinytable_css_l1l6wz57ay7rzpo0f3q3 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_8xch2fclac1rkegg0rm4, .table th.tinytable_css_8xch2fclac1rkegg0rm4 { text-align: left; }
      .table td.tinytable_css_0gi9mmcgl6xg0myblef9, .table th.tinytable_css_0gi9mmcgl6xg0myblef9 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_yotmhfzyknbt9wc889sv" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Sample of DUI</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">date</th>
                <th scope="col" data-row="0" data-col="1">city</th>
                <th scope="col" data-row="0" data-col="2">cases</th>
                <th scope="col" data-row="0" data-col="3">cars</th>
                <th scope="col" data-row="0" data-col="4">bikes</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">2020-01-01</td>
                  <td data-row="1" data-col="1">AAA</td>
                  <td data-row="1" data-col="2">54.00</td>
                  <td data-row="1" data-col="3">13.26</td>
                  <td data-row="1" data-col="4">20.21</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">2020-01-01</td>
                  <td data-row="2" data-col="1">BBB</td>
                  <td data-row="2" data-col="2">38.00</td>
                  <td data-row="2" data-col="3">12.76</td>
                  <td data-row="2" data-col="4">19.62</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">2020-01-01</td>
                  <td data-row="3" data-col="1">CCC</td>
                  <td data-row="3" data-col="2">81.00</td>
                  <td data-row="3" data-col="3">15.04</td>
                  <td data-row="3" data-col="4">21.94</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">2020-01-01</td>
                  <td data-row="4" data-col="1">DDD</td>
                  <td data-row="4" data-col="2">101.00</td>
                  <td data-row="4" data-col="3">15.77</td>
                  <td data-row="4" data-col="4">22.00</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">2020-02-01</td>
                  <td data-row="5" data-col="1">AAA</td>
                  <td data-row="5" data-col="2">64.00</td>
                  <td data-row="5" data-col="3">13.23</td>
                  <td data-row="5" data-col="4">20.11</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">2020-02-01</td>
                  <td data-row="6" data-col="1">BBB</td>
                  <td data-row="6" data-col="2">50.00</td>
                  <td data-row="6" data-col="3">13.26</td>
                  <td data-row="6" data-col="4">20.16</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">2020-02-01</td>
                  <td data-row="7" data-col="1">CCC</td>
                  <td data-row="7" data-col="2">92.00</td>
                  <td data-row="7" data-col="3">15.34</td>
                  <td data-row="7" data-col="4">22.35</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">2020-02-01</td>
                  <td data-row="8" data-col="1">DDD</td>
                  <td data-row="8" data-col="2">123.00</td>
                  <td data-row="8" data-col="3">15.12</td>
                  <td data-row="8" data-col="4">22.02</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">2020-03-01</td>
                  <td data-row="9" data-col="1">AAA</td>
                  <td data-row="9" data-col="2">53.00</td>
                  <td data-row="9" data-col="3">13.42</td>
                  <td data-row="9" data-col="4">20.45</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0">2020-03-01</td>
                  <td data-row="10" data-col="1">BBB</td>
                  <td data-row="10" data-col="2">41.00</td>
                  <td data-row="10" data-col="3">12.47</td>
                  <td data-row="10" data-col="4">19.34</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>我们提取数据绘图，当前最关注的问题就是新法案 6 月份在 <code>AAA, BBB</code> 两市月实行后，对于当地的重大交通事故发生数量是否有显著抑制作用？另外，作为对比的 <code>CCC, DDD</code> 两市的重大交通事故数量是否有特殊变化？因此我们所考虑的列是 <code>cases</code> 的政策前后差异以及在 <code>AAA, BBB, CCC, DDD</code> 之间的组间差异。至于其他信息暂且不论，它们的意义在后续会开展讨论。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot cases per city</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">=</span> (</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    dui <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> cases, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">ymd</span>(<span class="st">"2020-6-1"</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(<span class="at">breaks =</span> <span class="fu">breaks_pretty</span>(<span class="at">n =</span> <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"DUI Cases"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># plot dui per city</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>fig2 <span class="ot">=</span> (</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    dui <span class="sc">%&gt;%</span> </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> cars, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">ymd</span>(<span class="st">"2020-6-1"</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(<span class="at">breaks =</span> <span class="fu">breaks_pretty</span>(<span class="at">n =</span> <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Cars Index"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot petrol per city</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>fig3 <span class="ot">=</span> (</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    dui <span class="sc">%&gt;%</span> </span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> bikes, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">ymd</span>(<span class="st">"2020-6-1"</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(<span class="at">breaks =</span> <span class="fu">breaks_pretty</span>(<span class="at">n =</span> <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bikes Index"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into single figure</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>(fig1, fig2, fig3) <span class="sc">+</span> </span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Fig 3.1: Traffic Cases DID"</span>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="econ_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
<p>我们已知 DID 的算法原理，将案例的主要参数代入，得到模型；</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">feols</span>(<span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> treat <span class="sc">*</span> post <span class="sc">|</span> date <span class="sc">+</span> city, <span class="at">data =</span> dui)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><code>cases</code>: 醉酒驾驶案件数量；</li>
<li><code>date</code>: 用于固定时间效应的月份；</li>
<li><code>city</code>: 用于固定单位效应的城市；</li>
</ul>
<p>跑代码结果显示 treat:post 显著 <span class="math inline">\(p = 0.03\)</span> 且参数 <span class="math inline">\(\beta = -22.49\)</span>，说明严格的交管政策显著降低了酒驾案件数量，我们可以认为该市公安局的政策是显著有效的。至此，我们完成了一个最基础的 DID 模型测算，初步证明了政策效力；接下来我们在基准模型之上增加一点难度，大概思路跟 LM 一样，主要考虑内生性 Endogeneity 和异质性 Heterogeneity；但是注意，DID 模型不需要执行单独的异方差 Heteroskedasticity 的检验，因为它已经被内置的算法工具 <code>vcov()</code> 处理掉了。因此我们主要手动验证内生性和异质性，如果这两项检测都通过，我们再继续往下推进到事件分析 Event Study 和安慰剂检测 Placebo Tests，从而完成整个 DID 分析流程。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create treat and post columns for dui</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>dui <span class="ot">=</span> (</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    dui <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">treat =</span> <span class="fu">ifelse</span>(city <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"AAA"</span>, <span class="st">"BBB"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">post =</span> <span class="fu">ifelse</span>(date <span class="sc">&gt;</span> <span class="fu">ymd</span>(<span class="st">"2020-6-1"</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co"># fit an OLS-DID model</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>dui_mod1 <span class="ot">=</span> <span class="fu">feols</span>(</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> treat <span class="sc">*</span> post <span class="sc">|</span> city <span class="sc">+</span> date,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="sc">~</span> city,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dui</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize dui_mod1</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    dui_mod1 <span class="sc">%&gt;%</span> </span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">se =</span> std.error, <span class="at">pv =</span> p.value) <span class="sc">%&gt;%</span> </span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Summary of dui_mod1"</span>)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_fquyu6ocxel271fmba7a(i, j, css_id) {
          var table = document.getElementById("tinytable_fquyu6ocxel271fmba7a");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_fquyu6ocxel271fmba7a(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_fquyu6ocxel271fmba7a");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '1', j: 0 }, { i: '1', j: 1 }, { i: '1', j: 2 }, { i: '1', j: 3 }, { i: '1', j: 4 },  ], css_id: 'tinytable_css_whndmivsksobs7o5a8s6',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 },  ], css_id: 'tinytable_css_orb5hx4xv5d6vqqi02bw',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_fquyu6ocxel271fmba7a(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_whndmivsksobs7o5a8s6, .table th.tinytable_css_whndmivsksobs7o5a8s6 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_orb5hx4xv5d6vqqi02bw, .table th.tinytable_css_orb5hx4xv5d6vqqi02bw { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_fquyu6ocxel271fmba7a" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Summary of dui_mod1</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">term</th>
                <th scope="col" data-row="0" data-col="1">estimate</th>
                <th scope="col" data-row="0" data-col="2">se</th>
                <th scope="col" data-row="0" data-col="3">statistic</th>
                <th scope="col" data-row="0" data-col="4">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">treat:post</td>
                  <td data-row="1" data-col="1">-30.50</td>
                  <td data-row="1" data-col="2">5.65</td>
                  <td data-row="1" data-col="3">-5.40</td>
                  <td data-row="1" data-col="4">0.01</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</section>
<section id="sec-did-exogeneity" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="sec-did-exogeneity"><span class="header-section-number">2.2.2</span> Exogeineity</h3>
<p>从 <a href="#sec-lm-endogenity" class="quarto-xref">Section&nbsp;1.2</a> 我们已经知道什么是内生性和外生性，DID 模型与 LM 一样受到内生性的影响，DID 同样需要处理内生性导致的模型误差，总体处理逻辑与 LM 处理相似，不再赘述。简而言之，我们将自变量拆为内生部分和外生部分，并加入工具变量，再进行 2SLS 即可。第一阶段是求解内生变量的预测值，我们用工具变量 <span class="math inline">\(Z_{it}\)</span> 和所有其他的外生变量 <span class="math inline">\(\text{Treat}_i, \text{Post}_t\)</span> 来对内生变量 <span class="math inline">\(\text{Treat}_i \times \text{Post}_t\)</span> 进行回归，目的是为了得到该内生变量的预测值 <span class="math inline">\(\widehat{(\text{Treat}_i \times \text{Post}_t)}\)</span>。</p>
<p><span class="math display">\[
\begin{aligned}
    \text{Treat}_i \times \text{Post}_t =
    \alpha_0 +
    \alpha_1 \text{Treat}_i +
    \alpha_2 \text{Post}_t +
    \alpha_3 Z_{it} +
    \nu_{it}
\end{aligned}
\]</span></p>
<p>第二阶段是将第一阶段的预测结果代入主回归模型，我们用一个由工具变量生成的“干净”的预测值 <span class="math inline">\(\widehat{(\text{Treat}_i \times \text{Post}_t)}\)</span> ，来替换掉模型中“被污染”的内生变量 <span class="math inline">\(\text{Treat}_i \times \text{Post}_t\)</span>，从而得到无偏的因果效应估计。</p>
<p><span class="math display">\[
\begin{aligned}
Y_{it} =
    \beta_0 +
    \beta_1 \text{Treat}_i +
    \beta_2 \text{Post}_t +
    \beta_{3} \widehat{(\text{Treat}_i \times \text{Post}_t)} +
    \epsilon_{it}
\end{aligned}
\]</span></p>
<p>数学公式虽然比较复杂，但是 IV-DID 的算法原理很简单，就是在 OLS-DID 的最右侧先执行第一阶段回归，然后将结果代入到左侧原有的主回归当中。但是请注意，从形式上看，这是“增加了”两个变量，然而本质上它的作用是“替换”，而没有增加或删减任何变量。即：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>OLS<span class="sc">-</span>DID<span class="sc">:</span> <span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> Treat <span class="sc">*</span> Post <span class="sc">|</span> FE1 <span class="sc">+</span> FE2, <span class="at">data =</span> df)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>IV<span class="sc">-</span>DID<span class="sc">:</span> <span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> Treat <span class="sc">*</span> Post <span class="sc">|</span> FE1 <span class="sc">+</span> FE2 <span class="sc">|</span> X_edo <span class="sc">~</span> Z, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>原理解释完毕，回到本案中，我们根据常识假设 <code>cars</code> 是内生变量、<code>bikes</code> 是工具变量；换言之，我们希望通过 <code>bikes</code> 来“清理” <code>cars</code> 变量对于整个模型的“污染”，从而得到一个更“干净”的判断结果。这部分内容在 <a href="#sec-lm-endogenity" class="quarto-xref">Section&nbsp;1.2</a> 已经做了详细介绍，忘记的同学可以再爬楼回去翻一翻，大同小异；最后我们建立如下的 IV-DID 模型，并在代码中跑出结果。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">feols</span>(<span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> treat <span class="sc">*</span> post <span class="sc">|</span> date <span class="sc">+</span> city <span class="sc">|</span> cars <span class="sc">~</span> bikes, <span class="at">data =</span> dui)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>我们跑完结果得到4行数据，分别代表第一阶段的工具变量显著性和第二阶段主回归的显著性，简要解析如下。</p>
<p>在第一阶段中：</p>
<ul>
<li><code>bikes</code> 显著，即 <code>bikes</code> 对于 <code>cars</code> 具有显著刺激作用，说明我们的工具变量是强有效的，这是非常重要的结果；它直接决定我们的 IV-DID 能否继续往下推演，如果这个结果不显著，那必须调整模型参数，直到得到显著结果。</li>
<li><code>treat:post</code> 不显著，即 <code>treat:post</code> 对于 <code>cars</code> 没有显著刺激作用，说明政策效应对于交通压力并无影响；这个结果并不很重要，我们也并不关心政策对于交通或者出行的影响，我们关心的是政策对于醉驾的影响。</li>
</ul>
<p>在第二阶段中：</p>
<ul>
<li><code>fit_cars</code> 显著，即 <code>fit_cars</code> 对于 <code>cases</code> 有显著影响，说明经过工具变量“清理”后的内生变量对于最终的醉驾案件的数量具有直接重要的影响；其参数高达 20.5，即说明如果交通压力增加 1 个单位，醉驾的案件会增加 20.5 件，但实际情况不是这么简单的传导机制，我们暂时只关注这个“显著”结果接口，不深入讨论。</li>
<li><code>treat:post</code> 显著，即除了上述原因之外，政策本身还从其他的维度对于醉驾案件产生显著影响，并且这个影响是负相关的，即政策加强 1 个单位，醉驾案件减少 9.06 件；但实际情况会远比这个数据更复杂，它说明政策对于醉驾的强力压制性。</li>
</ul>
<p>这个结果清晰地分离出两条截然不同的影响路径，一方面，汽车交通压力作为一种风险机制，其增加会推升醉驾案件数量，这是显而易见的结果；另一方面，在控制了上述机制后，政策干预本身通过其他渠道，独立且有效地降低了醉驾案件，印证了政策本身的效力。因此，我们可以认为尽管面临着汽车数量增加带来的不利背景，但该政策干预本身对降低醉驾案件起到了显著的直接抑制作用，且所有标准误均在城市层面进行了聚类调整，保证了估计结果的稳健性。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit an IV-DID model</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>dui_mod2 <span class="ot">=</span> <span class="fu">feols</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> treat <span class="sc">*</span> post <span class="sc">|</span> city <span class="sc">+</span> date <span class="sc">|</span> cars <span class="sc">~</span> bikes,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="sc">~</span> city,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dui</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize IV-DID</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    dui_mod2 <span class="sc">%&gt;%</span> </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(<span class="at">stage =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coeftable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">estimate =</span> Estimate, <span class="at">se =</span> <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span>, </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">tv =</span> <span class="st">`</span><span class="at">t value</span><span class="st">`</span>, <span class="at">pv =</span> <span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Summary of dui_mod2"</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_zfgun3dqqgv75exi80mk(i, j, css_id) {
          var table = document.getElementById("tinytable_zfgun3dqqgv75exi80mk");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_zfgun3dqqgv75exi80mk(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_zfgun3dqqgv75exi80mk");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 0 }, { i: '4', j: 1 }, { i: '4', j: 2 }, { i: '4', j: 3 }, { i: '4', j: 4 }, { i: '4', j: 5 },  ], css_id: 'tinytable_css_cbmhahlhie2ycabv16hn',}, 
          { positions: [ { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '3', j: 1 }, { i: '1', j: 0 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '3', j: 3 }, { i: '1', j: 2 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '3', j: 5 }, { i: '1', j: 4 }, { i: '1', j: 5 }, { i: '2', j: 5 },  ], css_id: 'tinytable_css_mrqu8ypud2e09uo7qf9f',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 5 },  ], css_id: 'tinytable_css_q8go02i30hdwieugmpo5',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_zfgun3dqqgv75exi80mk(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_cbmhahlhie2ycabv16hn, .table th.tinytable_css_cbmhahlhie2ycabv16hn { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_mrqu8ypud2e09uo7qf9f, .table th.tinytable_css_mrqu8ypud2e09uo7qf9f { text-align: left; }
      .table td.tinytable_css_q8go02i30hdwieugmpo5, .table th.tinytable_css_q8go02i30hdwieugmpo5 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_zfgun3dqqgv75exi80mk" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Summary of dui_mod2</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">iv</th>
                <th scope="col" data-row="0" data-col="1">coefficient</th>
                <th scope="col" data-row="0" data-col="2">estimate</th>
                <th scope="col" data-row="0" data-col="3">se</th>
                <th scope="col" data-row="0" data-col="4">tv</th>
                <th scope="col" data-row="0" data-col="5">pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">First stage: cars</td>
                  <td data-row="1" data-col="1">bikes</td>
                  <td data-row="1" data-col="2">0.88</td>
                  <td data-row="1" data-col="3">0.09</td>
                  <td data-row="1" data-col="4">9.86</td>
                  <td data-row="1" data-col="5">0.00</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">First stage: cars</td>
                  <td data-row="2" data-col="1">treat:post</td>
                  <td data-row="2" data-col="2">0.10</td>
                  <td data-row="2" data-col="3">0.25</td>
                  <td data-row="2" data-col="4">0.38</td>
                  <td data-row="2" data-col="5">0.73</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">Second stage</td>
                  <td data-row="3" data-col="1">fit_cars</td>
                  <td data-row="3" data-col="2">9.31</td>
                  <td data-row="3" data-col="3">2.07</td>
                  <td data-row="3" data-col="4">4.50</td>
                  <td data-row="3" data-col="5">0.02</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">Second stage</td>
                  <td data-row="4" data-col="1">treat:post</td>
                  <td data-row="4" data-col="2">-23.51</td>
                  <td data-row="4" data-col="3">2.97</td>
                  <td data-row="4" data-col="4">-7.91</td>
                  <td data-row="4" data-col="5">0.00</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</section>
<section id="sec-did-heterogeneity" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="sec-did-heterogeneity"><span class="header-section-number">2.2.3</span> Heterogeneity</h3>
<p>如我们在 <a href="#sec-lm-heterogeneity" class="quarto-xref">Section&nbsp;1.3</a> 所讨论的一样，异质性分析是研究多个分组当中的组间差异。即在本案例中，<code>AAA, BBB, CCC, DDD</code> 之间的差异程度，首先我们知道 <code>CCC, DDD</code> 没有受到政策冲击，因此它的显著性应该是0，这是很重要的基准；然后我们需要考虑几个问题：（1）<code>AAA</code> 相对于平均显著性的差异性？（2）<code>BBB</code> 相对于平均显著性的差异性？（3）<code>AAA, BBB</code> 之间是否有差异性？这几个问题所指向的本质都是“异质性 Heterogeneity”，具体细节我们不再赘述，忘记的同学请往前翻一翻。我们接下来不加证明直接提出 <code>fixest</code> 对此问题的解决方案，对深度感兴趣的同学可以参考：<a href="https://lrberge.github.io/fixest/reference/i.html">fixest factor</a>，对原始理论感兴趣的同学请参考 <span class="citation" data-cites="Berge2018">(<a href="#ref-Berge2018" role="doc-biblioref"><strong>Berge2018?</strong></a>)</span>。</p>
<p>我们标准的 OLS-DID 模型和带有工具变量的 IV-DID 模型是：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>OLS<span class="sc">-</span>DID<span class="sc">:</span> <span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> Treat <span class="sc">*</span> Post <span class="sc">|</span> FE1 <span class="sc">+</span> FE2, <span class="at">data =</span> df)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>IV<span class="sc">-</span>DID<span class="sc">:</span> <span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> Treat <span class="sc">*</span> Post <span class="sc">|</span> FE1 <span class="sc">+</span> FE2 <span class="sc">|</span> X_edo <span class="sc">~</span> Z, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>那么在 <code>fixest</code> 当中处理这个问题的思路也比较直接，只需要在原模型当中增加一个分类变量的交互项即可，本质上的思路跟 OLS-LM 很相似，都是通过“交互项 Interaction Terms”来实现。如果分类变量的交互项当中，经历政策冲击的组出现了显著结果，并且不同的组之间的结果存在显著差异性，那么可以认为模型存在明显的组间差异；反之则不存在组间差异。整个探究的过程很像在一堆人当中找到谁是“滥竽充数”的南郭先生，以及谁是“真材实料”的伯牙子期。我们不介绍这部分的数学公式，直接给出对应的代码原理如下：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>OLS<span class="sc">-</span>DID Hete<span class="sc">:</span> <span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> <span class="fu">i</span>(Factor_Var, Treat <span class="sc">*</span> Post) <span class="sc">|</span> FE1 <span class="sc">+</span> FE2, <span class="at">data =</span> df)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>IV<span class="sc">-</span>DID Hete<span class="sc">:</span> <span class="fu">feols</span>(<span class="at">fml =</span> Y <span class="sc">~</span> Treat <span class="sc">+</span> Post <span class="sc">+</span> <span class="fu">i</span>(Factor_Var, Treat <span class="sc">*</span> Post) <span class="sc">|</span> FE1 <span class="sc">+</span> FE2 <span class="sc">|</span> X_edo <span class="sc">~</span> Z, <span class="at">data =</span> df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>根据这个原理，我们先处理简单的不包含工具变量的 OLS 模型，即为：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dui_mod1_hete <span class="ot">=</span> <span class="fu">feols</span>(<span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> <span class="fu">i</span>(city, treat <span class="sc">*</span> post) <span class="sc">|</span> city <span class="sc">+</span> date, <span class="at">data =</span> dui)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>但是这个模型只能返回 Groupwise 异质性，即每个组相对于总体平均显著性的差异程度，而无法解释每个组两两匹配成对的差异性，即 Pairwise 异质性。因此为了更好的观测组间异质性，我们继续借用 <a href="#sec-lm-heterogeneity" class="quarto-xref">Section&nbsp;1.3</a> 提到过的神包 <code>marginaleffects</code> 然后分别进行 Groupwise 和 Pariwise 异质性检验。结果如下图所示，<code>AAA, BBB</code> 两组各自独立与平均效应存在显著差异，但是 <code>AAA, BBB</code> 之间的差异性不显著，其中原因主要是它们之间过于简单的交互项形成了“多重共线性”；我们不展开具体内容，这个表格和图已经很好的反应了 OLS-DID 模型的异质性检测结果。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### for OLS-DID</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate heterogeneity test of dui_did</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>dui_mod1_hete <span class="ot">=</span> <span class="fu">feols</span>(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> <span class="fu">i</span>(city, treat <span class="sc">*</span> post) <span class="sc">|</span> city <span class="sc">+</span> date, </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="sc">~</span> city,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dui</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate groupwise heterogeneity</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>dui_mod1_group_hete <span class="ot">=</span> (</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> dui_mod1_hete, </span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"city"</span>,</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> <span class="dv">0</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> std.error,</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">sv =</span> s.value,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>dui_mod1_group_hete <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Groupwise Heterogeneity of dui_mod1"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_ixmcnjr4z8dv6h8mxbez(i, j, css_id) {
          var table = document.getElementById("tinytable_ixmcnjr4z8dv6h8mxbez");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_ixmcnjr4z8dv6h8mxbez(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_ixmcnjr4z8dv6h8mxbez");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 7 }, { i: '4', j: 2 }, { i: '4', j: 4 }, { i: '4', j: 0 }, { i: '4', j: 8 }, { i: '4', j: 3 }, { i: '4', j: 5 }, { i: '4', j: 6 }, { i: '4', j: 1 }, { i: '4', j: 9 },  ], css_id: 'tinytable_css_1bkw4yll0v9x99aixeyc',}, 
          { positions: [ { i: '3', j: 0 }, { i: '1', j: 2 }, { i: '3', j: 1 }, { i: '3', j: 2 }, { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '3', j: 3 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '1', j: 4 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '2', j: 7 }, { i: '2', j: 2 }, { i: '1', j: 5 }, { i: '2', j: 5 }, { i: '3', j: 5 }, { i: '2', j: 8 }, { i: '3', j: 8 }, { i: '1', j: 6 }, { i: '2', j: 6 }, { i: '3', j: 6 }, { i: '2', j: 9 }, { i: '3', j: 9 }, { i: '1', j: 7 }, { i: '1', j: 8 }, { i: '3', j: 7 }, { i: '1', j: 9 },  ], css_id: 'tinytable_css_i5jh0zfhpxm7iggbfeou',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 8 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 6 }, { i: '0', j: 1 }, { i: '0', j: 9 }, { i: '0', j: 5 }, { i: '0', j: 7 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_rnowwd63s7rk2n2d6k2y',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_ixmcnjr4z8dv6h8mxbez(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_1bkw4yll0v9x99aixeyc, .table th.tinytable_css_1bkw4yll0v9x99aixeyc { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_i5jh0zfhpxm7iggbfeou, .table th.tinytable_css_i5jh0zfhpxm7iggbfeou { text-align: left; }
      .table td.tinytable_css_rnowwd63s7rk2n2d6k2y, .table th.tinytable_css_rnowwd63s7rk2n2d6k2y { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_ixmcnjr4z8dv6h8mxbez" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Groupwise Heterogeneity of dui_mod1</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">term</th>
                <th scope="col" data-row="0" data-col="1">contrast</th>
                <th scope="col" data-row="0" data-col="2">city</th>
                <th scope="col" data-row="0" data-col="3">estimate</th>
                <th scope="col" data-row="0" data-col="4">se</th>
                <th scope="col" data-row="0" data-col="5">statistic</th>
                <th scope="col" data-row="0" data-col="6">pv</th>
                <th scope="col" data-row="0" data-col="7">sv</th>
                <th scope="col" data-row="0" data-col="8">conf_lo</th>
                <th scope="col" data-row="0" data-col="9">conf_hi</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">treat</td>
                  <td data-row="1" data-col="1">1 - 0</td>
                  <td data-row="1" data-col="2">AAA</td>
                  <td data-row="1" data-col="3">-16.75</td>
                  <td data-row="1" data-col="4">2.48</td>
                  <td data-row="1" data-col="5">-6.75</td>
                  <td data-row="1" data-col="6">0.00</td>
                  <td data-row="1" data-col="7">36.02</td>
                  <td data-row="1" data-col="8">-21.61</td>
                  <td data-row="1" data-col="9">-11.89</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">treat</td>
                  <td data-row="2" data-col="1">1 - 0</td>
                  <td data-row="2" data-col="2">BBB</td>
                  <td data-row="2" data-col="3">-13.75</td>
                  <td data-row="2" data-col="4">2.48</td>
                  <td data-row="2" data-col="5">-5.54</td>
                  <td data-row="2" data-col="6">0.00</td>
                  <td data-row="2" data-col="7">25.02</td>
                  <td data-row="2" data-col="8">-18.61</td>
                  <td data-row="2" data-col="9">-8.89</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">treat</td>
                  <td data-row="3" data-col="1">1 - 0</td>
                  <td data-row="3" data-col="2">CCC</td>
                  <td data-row="3" data-col="3">0.00</td>
                  <td data-row="3" data-col="4">NA</td>
                  <td data-row="3" data-col="5">NA</td>
                  <td data-row="3" data-col="6">NA</td>
                  <td data-row="3" data-col="7">NA</td>
                  <td data-row="3" data-col="8">NA</td>
                  <td data-row="3" data-col="9">NA</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">treat</td>
                  <td data-row="4" data-col="1">1 - 0</td>
                  <td data-row="4" data-col="2">DDD</td>
                  <td data-row="4" data-col="3">0.00</td>
                  <td data-row="4" data-col="4">NA</td>
                  <td data-row="4" data-col="5">NA</td>
                  <td data-row="4" data-col="6">NA</td>
                  <td data-row="4" data-col="7">NA</td>
                  <td data-row="4" data-col="8">NA</td>
                  <td data-row="4" data-col="9">NA</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate pairwise heterogeneity</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>dui_mod1_pair_hete <span class="ot">=</span> (</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> dui_mod1_hete, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"city"</span>,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> difference <span class="sc">~</span> pairwise,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> std.error,</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">sv =</span> s.value,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>dui_mod1_pair_hete <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Pairwise Heterogeneity of dui_mod1"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_5v86qmuhwylzwhbwrjn3(i, j, css_id) {
          var table = document.getElementById("tinytable_5v86qmuhwylzwhbwrjn3");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_5v86qmuhwylzwhbwrjn3(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_5v86qmuhwylzwhbwrjn3");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '6', j: 6 }, { i: '6', j: 0 }, { i: '6', j: 2 }, { i: '6', j: 4 }, { i: '6', j: 1 }, { i: '6', j: 3 }, { i: '6', j: 5 }, { i: '6', j: 7 },  ], css_id: 'tinytable_css_duous6omqdjq22mky95z',}, 
          { positions: [ { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '5', j: 2 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '5', j: 3 }, { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '4', j: 4 }, { i: '5', j: 4 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '3', j: 1 }, { i: '3', j: 3 }, { i: '4', j: 3 }, { i: '4', j: 5 }, { i: '5', j: 5 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '3', j: 6 }, { i: '4', j: 6 }, { i: '5', j: 6 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '2', j: 5 }, { i: '3', j: 5 }, { i: '3', j: 7 }, { i: '4', j: 7 }, { i: '5', j: 7 }, { i: '1', j: 4 }, { i: '1', j: 6 }, { i: '2', j: 6 }, { i: '1', j: 5 }, { i: '1', j: 7 }, { i: '2', j: 7 },  ], css_id: 'tinytable_css_a2eo76gstmegap03bmwv',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 2 }, { i: '0', j: 4 }, { i: '0', j: 6 }, { i: '0', j: 3 }, { i: '0', j: 5 }, { i: '0', j: 7 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_p3zjohwt95idy5h67i83',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_5v86qmuhwylzwhbwrjn3(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_duous6omqdjq22mky95z, .table th.tinytable_css_duous6omqdjq22mky95z { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_a2eo76gstmegap03bmwv, .table th.tinytable_css_a2eo76gstmegap03bmwv { text-align: left; }
      .table td.tinytable_css_p3zjohwt95idy5h67i83, .table th.tinytable_css_p3zjohwt95idy5h67i83 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_5v86qmuhwylzwhbwrjn3" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Pairwise Heterogeneity of dui_mod1</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">hypothesis</th>
                <th scope="col" data-row="0" data-col="1">estimate</th>
                <th scope="col" data-row="0" data-col="2">se</th>
                <th scope="col" data-row="0" data-col="3">statistic</th>
                <th scope="col" data-row="0" data-col="4">pv</th>
                <th scope="col" data-row="0" data-col="5">sv</th>
                <th scope="col" data-row="0" data-col="6">conf_lo</th>
                <th scope="col" data-row="0" data-col="7">conf_hi</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">(BBB) - (AAA)</td>
                  <td data-row="1" data-col="1">3.00</td>
                  <td data-row="1" data-col="2">0.00</td>
                  <td data-row="1" data-col="3">100663296.00</td>
                  <td data-row="1" data-col="4">0.00</td>
                  <td data-row="1" data-col="5"></td>
                  <td data-row="1" data-col="6">3.00</td>
                  <td data-row="1" data-col="7">3.00</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">(CCC) - (AAA)</td>
                  <td data-row="2" data-col="1">16.75</td>
                  <td data-row="2" data-col="2">2.48</td>
                  <td data-row="2" data-col="3">6.75</td>
                  <td data-row="2" data-col="4">0.00</td>
                  <td data-row="2" data-col="5">36.02</td>
                  <td data-row="2" data-col="6">11.89</td>
                  <td data-row="2" data-col="7">21.61</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">(DDD) - (AAA)</td>
                  <td data-row="3" data-col="1">16.75</td>
                  <td data-row="3" data-col="2">2.48</td>
                  <td data-row="3" data-col="3">6.75</td>
                  <td data-row="3" data-col="4">0.00</td>
                  <td data-row="3" data-col="5">36.02</td>
                  <td data-row="3" data-col="6">11.89</td>
                  <td data-row="3" data-col="7">21.61</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">(CCC) - (BBB)</td>
                  <td data-row="4" data-col="1">13.75</td>
                  <td data-row="4" data-col="2">2.48</td>
                  <td data-row="4" data-col="3">5.54</td>
                  <td data-row="4" data-col="4">0.00</td>
                  <td data-row="4" data-col="5">25.02</td>
                  <td data-row="4" data-col="6">8.89</td>
                  <td data-row="4" data-col="7">18.61</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">(DDD) - (BBB)</td>
                  <td data-row="5" data-col="1">13.75</td>
                  <td data-row="5" data-col="2">2.48</td>
                  <td data-row="5" data-col="3">5.54</td>
                  <td data-row="5" data-col="4">0.00</td>
                  <td data-row="5" data-col="5">25.02</td>
                  <td data-row="5" data-col="6">8.89</td>
                  <td data-row="5" data-col="7">18.61</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">(DDD) - (CCC)</td>
                  <td data-row="6" data-col="1">0.00</td>
                  <td data-row="6" data-col="2">NA</td>
                  <td data-row="6" data-col="3">NA</td>
                  <td data-row="6" data-col="4">NA</td>
                  <td data-row="6" data-col="5">NA</td>
                  <td data-row="6" data-col="6">NA</td>
                  <td data-row="6" data-col="7">NA</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot groupwise heterogeneity</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">=</span> (</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    dui_mod1_group_hete <span class="sc">%&gt;%</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> city, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">xmin =</span> conf_lo, <span class="at">xmax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">height =</span> <span class="fl">0.5</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimate"</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Groupwise Heterogeneity"</span>) <span class="sc">+</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="co"># plot pairwise heterogeneity</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>fig2 <span class="ot">=</span> (</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    dui_mod1_pair_hete <span class="sc">%&gt;%</span>  </span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> hypothesis, <span class="at">color =</span> hypothesis)) <span class="sc">+</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">xmin =</span> conf_lo, <span class="at">xmax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">height =</span> <span class="fl">0.5</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimate"</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Pairwise Heterogeneity"</span>) <span class="sc">+</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into one figure</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>(fig1, fig2) <span class="sc">+</span> </span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Fig 3.2: Heterogeneity Test of dui_mod1"</span>)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-22-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="econ_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
<p>我们采用几乎完全一样的算法原理计算 <code>dui_mod2</code> 的异质性，并且进一步拆分为总体异质性和组间异质性，得到如下结果。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### for IV-DID</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate heterogeneity</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>dui_mod2_hete <span class="ot">=</span> <span class="fu">feols</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fml =</span> cases <span class="sc">~</span> treat <span class="sc">+</span> post <span class="sc">+</span> <span class="fu">i</span>(city, treat <span class="sc">*</span> post) <span class="sc">|</span> city <span class="sc">+</span> date <span class="sc">|</span> cars <span class="sc">~</span> bikes, </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="sc">~</span> city,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dui</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate groupwise heterogeneity</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>dui_mod2_group_hete <span class="ot">=</span> (</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> dui_mod2_hete, </span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"city"</span>,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> <span class="dv">0</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> std.error,</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">sv =</span> s.value,</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>dui_mod2_group_hete <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Groupwise Heterogeneity of dui_mod2"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_rt636ozyslj6ldm4voc8(i, j, css_id) {
          var table = document.getElementById("tinytable_rt636ozyslj6ldm4voc8");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_rt636ozyslj6ldm4voc8(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_rt636ozyslj6ldm4voc8");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '4', j: 7 }, { i: '4', j: 2 }, { i: '4', j: 4 }, { i: '4', j: 0 }, { i: '4', j: 8 }, { i: '4', j: 3 }, { i: '4', j: 5 }, { i: '4', j: 6 }, { i: '4', j: 1 }, { i: '4', j: 9 },  ], css_id: 'tinytable_css_0sclege7npyjp48ofqaz',}, 
          { positions: [ { i: '3', j: 0 }, { i: '1', j: 2 }, { i: '3', j: 1 }, { i: '3', j: 2 }, { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '3', j: 3 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '1', j: 4 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '2', j: 7 }, { i: '2', j: 2 }, { i: '1', j: 5 }, { i: '2', j: 5 }, { i: '3', j: 5 }, { i: '2', j: 8 }, { i: '3', j: 8 }, { i: '1', j: 6 }, { i: '2', j: 6 }, { i: '3', j: 6 }, { i: '2', j: 9 }, { i: '3', j: 9 }, { i: '1', j: 7 }, { i: '1', j: 8 }, { i: '3', j: 7 }, { i: '1', j: 9 },  ], css_id: 'tinytable_css_95i2lu9jx5480nexkwlr',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 8 }, { i: '0', j: 3 }, { i: '0', j: 4 }, { i: '0', j: 6 }, { i: '0', j: 1 }, { i: '0', j: 9 }, { i: '0', j: 5 }, { i: '0', j: 7 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_iurdbdr7jugpfbkmzpes',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_rt636ozyslj6ldm4voc8(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_0sclege7npyjp48ofqaz, .table th.tinytable_css_0sclege7npyjp48ofqaz { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_95i2lu9jx5480nexkwlr, .table th.tinytable_css_95i2lu9jx5480nexkwlr { text-align: left; }
      .table td.tinytable_css_iurdbdr7jugpfbkmzpes, .table th.tinytable_css_iurdbdr7jugpfbkmzpes { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_rt636ozyslj6ldm4voc8" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Groupwise Heterogeneity of dui_mod2</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">term</th>
                <th scope="col" data-row="0" data-col="1">contrast</th>
                <th scope="col" data-row="0" data-col="2">city</th>
                <th scope="col" data-row="0" data-col="3">estimate</th>
                <th scope="col" data-row="0" data-col="4">se</th>
                <th scope="col" data-row="0" data-col="5">statistic</th>
                <th scope="col" data-row="0" data-col="6">pv</th>
                <th scope="col" data-row="0" data-col="7">sv</th>
                <th scope="col" data-row="0" data-col="8">conf_lo</th>
                <th scope="col" data-row="0" data-col="9">conf_hi</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">treat</td>
                  <td data-row="1" data-col="1">1 - 0</td>
                  <td data-row="1" data-col="2">AAA</td>
                  <td data-row="1" data-col="3">-12.94</td>
                  <td data-row="1" data-col="4">0.92</td>
                  <td data-row="1" data-col="5">-14.07</td>
                  <td data-row="1" data-col="6">0.00</td>
                  <td data-row="1" data-col="7">146.91</td>
                  <td data-row="1" data-col="8">-14.74</td>
                  <td data-row="1" data-col="9">-11.13</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">treat</td>
                  <td data-row="2" data-col="1">1 - 0</td>
                  <td data-row="2" data-col="2">BBB</td>
                  <td data-row="2" data-col="3">-10.87</td>
                  <td data-row="2" data-col="4">1.13</td>
                  <td data-row="2" data-col="5">-9.58</td>
                  <td data-row="2" data-col="6">0.00</td>
                  <td data-row="2" data-col="7">69.79</td>
                  <td data-row="2" data-col="8">-13.09</td>
                  <td data-row="2" data-col="9">-8.65</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">treat</td>
                  <td data-row="3" data-col="1">1 - 0</td>
                  <td data-row="3" data-col="2">CCC</td>
                  <td data-row="3" data-col="3">0.00</td>
                  <td data-row="3" data-col="4">NA</td>
                  <td data-row="3" data-col="5">NA</td>
                  <td data-row="3" data-col="6">NA</td>
                  <td data-row="3" data-col="7">NA</td>
                  <td data-row="3" data-col="8">NA</td>
                  <td data-row="3" data-col="9">NA</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">treat</td>
                  <td data-row="4" data-col="1">1 - 0</td>
                  <td data-row="4" data-col="2">DDD</td>
                  <td data-row="4" data-col="3">0.00</td>
                  <td data-row="4" data-col="4">NA</td>
                  <td data-row="4" data-col="5">NA</td>
                  <td data-row="4" data-col="6">NA</td>
                  <td data-row="4" data-col="7">NA</td>
                  <td data-row="4" data-col="8">NA</td>
                  <td data-row="4" data-col="9">NA</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate pairwise heterogeneity</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>dui_mod2_pair_hete <span class="ot">=</span> (</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slopes</span>(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> dui_mod2_hete, </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"city"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">hypothesis =</span> difference <span class="sc">~</span> pairwise,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> std.error,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">sv =</span> s.value,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">pv =</span> p.value, </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_lo =</span> conf.low, </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf_hi =</span> conf.high</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>dui_mod2_pair_hete <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Pairwise Heterogeneity of dui_mod2"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_juyxdcc64t08jd4nyodn(i, j, css_id) {
          var table = document.getElementById("tinytable_juyxdcc64t08jd4nyodn");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_juyxdcc64t08jd4nyodn(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_juyxdcc64t08jd4nyodn");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '6', j: 6 }, { i: '6', j: 0 }, { i: '6', j: 2 }, { i: '6', j: 4 }, { i: '6', j: 1 }, { i: '6', j: 3 }, { i: '6', j: 5 }, { i: '6', j: 7 },  ], css_id: 'tinytable_css_7qqflif7oobg84310dgk',}, 
          { positions: [ { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '5', j: 2 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '5', j: 3 }, { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '4', j: 4 }, { i: '5', j: 4 }, { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '3', j: 1 }, { i: '3', j: 3 }, { i: '4', j: 3 }, { i: '4', j: 5 }, { i: '5', j: 5 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '2', j: 4 }, { i: '3', j: 4 }, { i: '3', j: 6 }, { i: '4', j: 6 }, { i: '5', j: 6 }, { i: '1', j: 3 }, { i: '2', j: 3 }, { i: '2', j: 5 }, { i: '3', j: 5 }, { i: '3', j: 7 }, { i: '4', j: 7 }, { i: '5', j: 7 }, { i: '1', j: 4 }, { i: '1', j: 6 }, { i: '2', j: 6 }, { i: '1', j: 5 }, { i: '1', j: 7 }, { i: '2', j: 7 },  ], css_id: 'tinytable_css_kioqjs5sns048ibm5ti8',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 2 }, { i: '0', j: 4 }, { i: '0', j: 6 }, { i: '0', j: 3 }, { i: '0', j: 5 }, { i: '0', j: 7 }, { i: '0', j: 1 },  ], css_id: 'tinytable_css_k3iefliq3m2w198s28s4',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_juyxdcc64t08jd4nyodn(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_7qqflif7oobg84310dgk, .table th.tinytable_css_7qqflif7oobg84310dgk { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_kioqjs5sns048ibm5ti8, .table th.tinytable_css_kioqjs5sns048ibm5ti8 { text-align: left; }
      .table td.tinytable_css_k3iefliq3m2w198s28s4, .table th.tinytable_css_k3iefliq3m2w198s28s4 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_juyxdcc64t08jd4nyodn" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Pairwise Heterogeneity of dui_mod2</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">hypothesis</th>
                <th scope="col" data-row="0" data-col="1">estimate</th>
                <th scope="col" data-row="0" data-col="2">se</th>
                <th scope="col" data-row="0" data-col="3">statistic</th>
                <th scope="col" data-row="0" data-col="4">pv</th>
                <th scope="col" data-row="0" data-col="5">sv</th>
                <th scope="col" data-row="0" data-col="6">conf_lo</th>
                <th scope="col" data-row="0" data-col="7">conf_hi</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">(BBB) - (AAA)</td>
                  <td data-row="1" data-col="1">2.07</td>
                  <td data-row="1" data-col="2">0.23</td>
                  <td data-row="1" data-col="3">9.11</td>
                  <td data-row="1" data-col="4">0.00</td>
                  <td data-row="1" data-col="5">63.43</td>
                  <td data-row="1" data-col="6">1.62</td>
                  <td data-row="1" data-col="7">2.51</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">(CCC) - (AAA)</td>
                  <td data-row="2" data-col="1">12.94</td>
                  <td data-row="2" data-col="2">0.92</td>
                  <td data-row="2" data-col="3">14.07</td>
                  <td data-row="2" data-col="4">0.00</td>
                  <td data-row="2" data-col="5">146.91</td>
                  <td data-row="2" data-col="6">11.13</td>
                  <td data-row="2" data-col="7">14.74</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">(DDD) - (AAA)</td>
                  <td data-row="3" data-col="1">12.94</td>
                  <td data-row="3" data-col="2">0.92</td>
                  <td data-row="3" data-col="3">14.07</td>
                  <td data-row="3" data-col="4">0.00</td>
                  <td data-row="3" data-col="5">146.91</td>
                  <td data-row="3" data-col="6">11.13</td>
                  <td data-row="3" data-col="7">14.74</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">(CCC) - (BBB)</td>
                  <td data-row="4" data-col="1">10.87</td>
                  <td data-row="4" data-col="2">1.13</td>
                  <td data-row="4" data-col="3">9.58</td>
                  <td data-row="4" data-col="4">0.00</td>
                  <td data-row="4" data-col="5">69.79</td>
                  <td data-row="4" data-col="6">8.65</td>
                  <td data-row="4" data-col="7">13.09</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">(DDD) - (BBB)</td>
                  <td data-row="5" data-col="1">10.87</td>
                  <td data-row="5" data-col="2">1.13</td>
                  <td data-row="5" data-col="3">9.58</td>
                  <td data-row="5" data-col="4">0.00</td>
                  <td data-row="5" data-col="5">69.79</td>
                  <td data-row="5" data-col="6">8.65</td>
                  <td data-row="5" data-col="7">13.09</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">(DDD) - (CCC)</td>
                  <td data-row="6" data-col="1">0.00</td>
                  <td data-row="6" data-col="2">NA</td>
                  <td data-row="6" data-col="3">NA</td>
                  <td data-row="6" data-col="4">NA</td>
                  <td data-row="6" data-col="5">NA</td>
                  <td data-row="6" data-col="6">NA</td>
                  <td data-row="6" data-col="7">NA</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot groupwise heterogeneity</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">=</span> (</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    dui_mod2_group_hete <span class="sc">%&gt;%</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> city, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">xmin =</span> conf_lo, <span class="at">xmax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">height =</span> <span class="fl">0.5</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimate"</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Groupwise Heterogeneity of dui_mod2"</span>) <span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># plot pairwise heterogeneity</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>fig2 <span class="ot">=</span> (</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    dui_mod2_pair_hete <span class="sc">%&gt;%</span> </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> hypothesis, <span class="at">color =</span> hypothesis)) <span class="sc">+</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">xmin =</span> conf_lo, <span class="at">xmax =</span> conf_hi), <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">height =</span> <span class="fl">0.5</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">pvalue</span>(pv, <span class="at">add_p =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimate"</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"Pairwise Heterogeneity of dui_mod2"</span>) <span class="sc">+</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into one figure</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>(fig1, fig2) <span class="sc">+</span> </span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Fig 3.3: Heterogeneity Test of dui_mod2"</span>)</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-23-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="econ_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="tests" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="tests"><span class="header-section-number">2.3</span> Tests</h2>
<section id="sec-did-es" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="sec-did-es"><span class="header-section-number">2.3.1</span> Event Study</h3>
<ul>
<li><p>事件分析：主要研究政策冲击对政策之前和之后的处理组的影响；</p></li>
<li><p>Event Study: to analyze the pre- and post-significance of policy shock;</p></li>
<li><p>若 pre-treat 不显著但是 post-treat 显著，则政策具有显著效果，可能是正向也可能是负向；</p></li>
<li><p>并且 post-treat 尽量满足单调性，否则很容易被评审认为政策结果是偶然而不是必然；</p></li>
<li><p>pre-treat 不显著，post-treat 显著且满足一定单调减，证明政策具有显著效应；</p></li>
<li><p>即政策实施后，抑制或降低了交通事故伤亡人数，对交通安全起了显著促进作用；</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run event study test</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>dui <span class="ot">=</span> dui <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">month_lag =</span> <span class="fu">month</span>(date) <span class="sc">-</span> <span class="dv">6</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot Event Study figure</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>( </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">feols</span>(</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">fml =</span> cases <span class="sc">~</span> <span class="fu">i</span>(month_lag, treat, <span class="dv">1</span>) <span class="sc">|</span> city <span class="sc">+</span> date <span class="sc">|</span> cars <span class="sc">~</span> bikes,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="sc">~</span>city,</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dui</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggiplot</span>(<span class="at">main =</span> <span class="st">"Fig 3.4: Event Study"</span>)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-24-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="econ_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-did-placebo" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="sec-did-placebo"><span class="header-section-number">2.3.2</span> Placebo Tests</h3>
<p>Event Study 对原数据当中的 treat 乱序排列后形成新的数据组，然后再跑模型，观察乱序模型的显著性；如果乱序模型也显著，说明原科学模型的效果甚至不如随机抽样的效果，原模型即宣告无效。EG: 张三正在备考不定向选择题，李四每次都随机填答案，最后李四比张三还多十分，安慰剂胜，张三卒。安慰剂检测中，应该以表格为主、图表为辅，因为一张表格可以容下非常多维度的数据，远超图表；结果显示，极少数 placebo 的 post-treat 显著，绝大多数不显著，甚至还有部分 pre-treat 也显著；综上，placebo 不满足 post-treat significance 条件，原模型通过 Event Study Test。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create 6 placebos by sampling treat column</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) {</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    dui <span class="ot">=</span> dui <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i) <span class="sc">:</span><span class="er">=</span> <span class="fu">sample</span>(treat))</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot placebo event study</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(i) {</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>            dui <span class="sc">%&gt;%</span> </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename</span>(<span class="at">treat_plb_temp =</span> <span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">feols</span>(</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">fml =</span> cases <span class="sc">~</span> </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">i</span>(month_lag, treat_plb_temp, <span class="dv">0</span>) <span class="sc">|</span> </span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>                        city <span class="sc">+</span> date <span class="sc">|</span> </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>                        cars <span class="sc">~</span> bikes, </span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="sc">~</span>city</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ggiplot</span>(<span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Placebo: "</span>,i)) <span class="sc">+</span> </span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>() <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="econ_files/figure-html/unnamed-chunk-25-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="econ_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="3000"></a></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate placesbo table</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(i) {</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>            dui <span class="sc">%&gt;%</span> </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename</span>(<span class="at">treat_plb_temp =</span> <span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">feols</span>(</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">fml =</span> cases <span class="sc">~</span> </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">i</span>(month_lag, treat_plb_temp, <span class="dv">0</span>) <span class="sc">|</span> </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                        city <span class="sc">+</span> date <span class="sc">|</span> </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                        cars <span class="sc">~</span> bikes,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="sc">~</span> city</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># keep term and dynamic rename pvalues and drop all others</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">term =</span> term,</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!!</span><span class="fu">paste0</span>(<span class="st">"plb_"</span>, i, <span class="st">"_pv"</span>) <span class="sc">:</span><span class="er">=</span> p.value,</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">.keep =</span> <span class="st">"none"</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">"term"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Event Study of Placebos"</span>)</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_3mresavb8zketbdityol(i, j, css_id) {
          var table = document.getElementById("tinytable_3mresavb8zketbdityol");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_3mresavb8zketbdityol(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_3mresavb8zketbdityol");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '9', j: 0 }, { i: '9', j: 1 }, { i: '9', j: 3 }, { i: '9', j: 4 }, { i: '9', j: 5 }, { i: '9', j: 2 }, { i: '9', j: 6 },  ], css_id: 'tinytable_css_n2x9g7a8ysc5fltudf5n',}, 
          { positions: [ { i: '5', j: 0 }, { i: '2', j: 0 }, { i: '2', j: 2 }, { i: '6', j: 0 }, { i: '3', j: 0 }, { i: '2', j: 1 }, { i: '3', j: 1 }, { i: '1', j: 0 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '4', j: 0 }, { i: '8', j: 1 }, { i: '2', j: 3 }, { i: '7', j: 0 }, { i: '8', j: 0 }, { i: '5', j: 3 }, { i: '3', j: 2 }, { i: '1', j: 1 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '4', j: 1 }, { i: '8', j: 2 }, { i: '2', j: 4 }, { i: '7', j: 1 }, { i: '1', j: 3 }, { i: '5', j: 4 }, { i: '3', j: 3 }, { i: '1', j: 2 }, { i: '8', j: 4 }, { i: '6', j: 3 }, { i: '4', j: 2 }, { i: '8', j: 3 }, { i: '2', j: 5 }, { i: '7', j: 2 }, { i: '1', j: 4 }, { i: '5', j: 5 }, { i: '3', j: 4 }, { i: '4', j: 4 }, { i: '8', j: 5 }, { i: '6', j: 4 }, { i: '4', j: 3 }, { i: '1', j: 6 }, { i: '2', j: 6 }, { i: '7', j: 3 }, { i: '1', j: 5 }, { i: '5', j: 6 }, { i: '3', j: 5 }, { i: '4', j: 5 }, { i: '8', j: 6 }, { i: '6', j: 5 }, { i: '7', j: 5 }, { i: '6', j: 6 }, { i: '3', j: 6 }, { i: '7', j: 4 }, { i: '7', j: 6 }, { i: '4', j: 6 },  ], css_id: 'tinytable_css_vglkf9vp5bikf8fihw10',}, 
          { positions: [ { i: '0', j: 0 }, { i: '0', j: 4 }, { i: '0', j: 1 }, { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 5 }, { i: '0', j: 6 },  ], css_id: 'tinytable_css_mrw23pdv8oaszssv6mbb',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_3mresavb8zketbdityol(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_n2x9g7a8ysc5fltudf5n, .table th.tinytable_css_n2x9g7a8ysc5fltudf5n { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_vglkf9vp5bikf8fihw10, .table th.tinytable_css_vglkf9vp5bikf8fihw10 { text-align: left; }
      .table td.tinytable_css_mrw23pdv8oaszssv6mbb, .table th.tinytable_css_mrw23pdv8oaszssv6mbb { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_3mresavb8zketbdityol" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Event Study of Placebos</caption>
              <tbody><tr>
                <th scope="col" data-row="0" data-col="0">term</th>
                <th scope="col" data-row="0" data-col="1">plb_1_pv</th>
                <th scope="col" data-row="0" data-col="2">plb_2_pv</th>
                <th scope="col" data-row="0" data-col="3">plb_3_pv</th>
                <th scope="col" data-row="0" data-col="4">plb_4_pv</th>
                <th scope="col" data-row="0" data-col="5">plb_5_pv</th>
                <th scope="col" data-row="0" data-col="6">plb_6_pv</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td data-row="1" data-col="0">fit_cars</td>
                  <td data-row="1" data-col="1">0.00</td>
                  <td data-row="1" data-col="2">0.00</td>
                  <td data-row="1" data-col="3">0.00</td>
                  <td data-row="1" data-col="4">0.01</td>
                  <td data-row="1" data-col="5">0.00</td>
                  <td data-row="1" data-col="6">0.02</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0">month_lag::-5:treat_plb_temp</td>
                  <td data-row="2" data-col="1">0.43</td>
                  <td data-row="2" data-col="2">0.75</td>
                  <td data-row="2" data-col="3">0.81</td>
                  <td data-row="2" data-col="4">0.30</td>
                  <td data-row="2" data-col="5">0.36</td>
                  <td data-row="2" data-col="6">0.05</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">month_lag::-4:treat_plb_temp</td>
                  <td data-row="3" data-col="1">0.17</td>
                  <td data-row="3" data-col="2">0.44</td>
                  <td data-row="3" data-col="3">0.87</td>
                  <td data-row="3" data-col="4">0.48</td>
                  <td data-row="3" data-col="5">0.21</td>
                  <td data-row="3" data-col="6">0.47</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0">month_lag::-2:treat_plb_temp</td>
                  <td data-row="4" data-col="1">0.79</td>
                  <td data-row="4" data-col="2">0.83</td>
                  <td data-row="4" data-col="3">0.47</td>
                  <td data-row="4" data-col="4">NA</td>
                  <td data-row="4" data-col="5">0.31</td>
                  <td data-row="4" data-col="6">0.09</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">month_lag::-1:treat_plb_temp</td>
                  <td data-row="5" data-col="1">0.00</td>
                  <td data-row="5" data-col="2">0.00</td>
                  <td data-row="5" data-col="3">0.19</td>
                  <td data-row="5" data-col="4">0.08</td>
                  <td data-row="5" data-col="5">NA</td>
                  <td data-row="5" data-col="6">NA</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0">month_lag::2:treat_plb_temp</td>
                  <td data-row="6" data-col="1">0.27</td>
                  <td data-row="6" data-col="2">0.75</td>
                  <td data-row="6" data-col="3">0.43</td>
                  <td data-row="6" data-col="4">0.61</td>
                  <td data-row="6" data-col="5">0.89</td>
                  <td data-row="6" data-col="6">0.86</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">month_lag::3:treat_plb_temp</td>
                  <td data-row="7" data-col="1">0.06</td>
                  <td data-row="7" data-col="2">0.10</td>
                  <td data-row="7" data-col="3">0.34</td>
                  <td data-row="7" data-col="4">0.34</td>
                  <td data-row="7" data-col="5">0.49</td>
                  <td data-row="7" data-col="6">0.31</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0">month_lag::4:treat_plb_temp</td>
                  <td data-row="8" data-col="1">0.31</td>
                  <td data-row="8" data-col="2">0.21</td>
                  <td data-row="8" data-col="3">NA</td>
                  <td data-row="8" data-col="4">0.18</td>
                  <td data-row="8" data-col="5">0.03</td>
                  <td data-row="8" data-col="6">0.06</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">month_lag::5:treat_plb_temp</td>
                  <td data-row="9" data-col="1">0.56</td>
                  <td data-row="9" data-col="2">0.08</td>
                  <td data-row="9" data-col="3">0.03</td>
                  <td data-row="9" data-col="4">0.75</td>
                  <td data-row="9" data-col="5">0.80</td>
                  <td data-row="9" data-col="6">1.00</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</section>
</section>
<section id="staggered-did" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="staggered-did"><span class="header-section-number">2.4</span> Staggered DID</h2>
<p>Staggered DID 本质是比较多个样本组经历了多次政策冲击前、冲击后的差异性；策在 <span class="math inline">\(t_1\)</span> 对 <span class="math inline">\(x_1\)</span> 生效，在 <span class="math inline">\(t_2\)</span> 对 <span class="math inline">\(x_2\)</span> 生效，在 <span class="math inline">\(t_3\)</span> 对 <span class="math inline">\(x_3\)</span> 生效，以此类推；这样的情况，标准 DID 会遇到 negative weighting, heterogeneity, dynamic effects 等技术挑战。于是 Callaway &amp; Sant’Anna 2020, Sun and Abraham 2021 都提出了非常优秀的解决方案。</p>
<p>某市公安局 2020 年开展“精神文明城市”建设行动，重点在于切实降低本小市的刑事案件发生数量；市局决定 5～7月重点防控 A 市，7～9月重点防控 B 市，C 和 D 市作为对照组按常规流程检查；加密数据并绘图如下，发现 A 和 B 市虽然有过一定程度下降，但是很快又在攀升过程。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create sample data</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>cars2 <span class="ot">=</span> (</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">month =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">as.yearmon</span>(<span class="st">"2020-1"</span>), <span class="at">to =</span> <span class="fu">as.yearmon</span>(<span class="st">"2020-12"</span>), <span class="at">by =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>),</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">AAA =</span> <span class="fu">c</span>(<span class="dv">207</span>, <span class="dv">228</span>, <span class="dv">205</span>, <span class="dv">187</span>, <span class="dv">152</span>, <span class="dv">113</span>, <span class="dv">97</span>, <span class="dv">91</span>, <span class="dv">99</span>, <span class="dv">108</span>, <span class="dv">119</span>, <span class="dv">126</span>),</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">BBB =</span> <span class="fu">c</span>(<span class="dv">175</span>, <span class="dv">199</span>, <span class="dv">181</span>, <span class="dv">164</span>, <span class="dv">171</span>, <span class="dv">165</span>, <span class="dv">128</span>, <span class="dv">107</span>, <span class="dv">82</span>, <span class="dv">96</span>, <span class="dv">102</span>, <span class="dv">113</span>),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">CCC =</span> <span class="fu">c</span>(<span class="dv">71</span>, <span class="dv">88</span>, <span class="dv">64</span>, <span class="dv">59</span>, <span class="dv">61</span>, <span class="dv">68</span>, <span class="dv">71</span>, <span class="dv">61</span>, <span class="dv">59</span>, <span class="dv">79</span>, <span class="dv">68</span>, <span class="dv">59</span>),</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">DDD =</span> <span class="fu">c</span>(<span class="dv">94</span>, <span class="dv">107</span>, <span class="dv">87</span>, <span class="dv">71</span>, <span class="dv">78</span>, <span class="dv">69</span>, <span class="dv">72</span>, <span class="dv">80</span>, <span class="dv">72</span>, <span class="dv">91</span>, <span class="dv">82</span>, <span class="dv">77</span>),</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>month, <span class="at">names_to =</span> <span class="st">"city"</span>, <span class="at">values_to =</span> <span class="st">"cases"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cases =</span> <span class="fu">log</span>(cases))</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co"># plot sample figure</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> cases, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as.yearmon</span>(<span class="st">"2020-5"</span>)), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as.yearmon</span>(<span class="st">"2020-7"</span>)), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Criminal Cases"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Cases Num"</span>) <span class="sc">+</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>基于标准 DID 模型，Staggered DID 考虑了时间和样本的动态变化，提出如下公式；</p>
<p><span class="math display">\[
Y_{it} =
    \sum_{k=-K}^{-2} \beta_k \cdot D_{it}^k +
    \sum_{k=0}^{L} \beta_k \cdot D_{it}^k +
    \alpha_i + \gamma_t + \epsilon_{it}
\]</span></p>
<ul>
<li><span class="math inline">\(D_{it}^k\)</span>: relative time indicators;</li>
<li><span class="math inline">\(G_i\)</span>: treatment adoption period;</li>
<li><span class="math inline">\(k = -K,...,L\)</span>: time relative to treatment;</li>
<li><span class="math inline">\(\alpha_i\)</span>: unit fixed effects;</li>
<li><span class="math inline">\(\gamma_t\)</span>: time fixed effects;</li>
<li><span class="math inline">\(k = -1\)</span>: reference period;</li>
</ul>
<p>参考标准 DID 的数据结构，建模如下：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>y <span class="sc">~</span> <span class="fu">sunab</span>(treat <span class="sc">*</span> post) <span class="sc">|</span> month <span class="sc">+</span> city</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>sunab()</code> 是 Laurent Berge 在 2022 年将 Sun and Abraham 的理论移植在了 <code>fixest</code> 当中；对比 2018 年发布的标准 DID 模型，我们就能够看到 <code>tidyverse</code> 的底层架构的前瞻性，只需要修改一点细微之处，就可以让旧的模型适应最新理论发展，并无缝衔接原有的庞大生态链；绕过复杂的代码架构和数学理论，我们战练结合，直接跑代码看结果。</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>y <span class="sc">~</span> treat <span class="sc">*</span> post <span class="sc">|</span> month <span class="sc">+</span> city</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Event Study 分析过程跟标准 DID 基本一致，不再逐个讨论；下图显示 pre-treat 不显著，但是 post-treat 显著，即政策显著降低了刑事案件数量。综上，模型在 treat-post 的对比中存在显著差异性，通过事件检验；但是随着政策时间拉长，刑事案件数量逐渐回升，说明政策效力在逐渐衰退，这是另一个深度的问题了。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create three fundamental columns for cars2</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>cars2 <span class="ot">=</span> (</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">month_num =</span> <span class="fu">month</span>(month),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">treat_num =</span> </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">case_when</span>(</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                city <span class="sc">==</span> <span class="st">"AAA"</span> <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                city <span class="sc">==</span> <span class="st">"BBB"</span> <span class="sc">~</span> <span class="dv">7</span>,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                city <span class="sc">==</span> <span class="st">"CCC"</span> <span class="sc">~</span> <span class="dv">999</span>,</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                city <span class="sc">==</span> <span class="st">"DDD"</span> <span class="sc">~</span> <span class="dv">999</span>,</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">post =</span> month_num <span class="sc">&gt;</span> treat_num,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot event study figure</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">feols</span>(</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>        cases <span class="sc">~</span> <span class="fu">sunab</span>(treat_num, month_num) <span class="sc">|</span> city <span class="sc">+</span> month_num,</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="sc">~</span> city</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggiplot</span>(<span class="at">main =</span> <span class="st">"Event Study of cars2"</span>)</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Hetetogeneity 重要说明，当样本的空间划分和时间采样都很小的时候，该测试并不严谨，非常容易在边缘徘徊；A 和 B 相对于 control 都单独显著，注意此处的参照物是 control 整体，而不是 CCC 或 DDD。既然 A 和 B 独立跟 control 显著，那么 treat 总体必然与 control 显著；综上，模型在 treat 的子类当中不存在较大异质性，通过异质检验。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heterogeneity figure</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">feols</span>(</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        cases <span class="sc">~</span> <span class="fu">i</span>(city, treat_num <span class="sc">*</span> post) <span class="sc">|</span> city <span class="sc">+</span> month_num, </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov =</span> <span class="sc">~</span> city</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggiplot</span>(<span class="at">main =</span> <span class="st">"Heterogeneity of cars2"</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Event Study 此处的安慰剂检测跟标准 DID 检测一样，略过细节，关注结论；几乎所有的 post-treat 都不显著，极少数显著的组，可能正好选中了 False Positive；综上，安慰剂不满足 post-treat significance 条件。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the procedures are very similar to standard DID part </span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># first create placebo columns and then run ES and Hete tests</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create 6 placebo columns by sampling treat column, for consistency</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) {</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    cars2 <span class="ot">=</span> </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i) <span class="sc">:</span><span class="er">=</span> <span class="fu">sample</span>(treat_num))</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co"># plot event study table</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(i) {</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>            cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename</span>(<span class="at">treat_plb_temp =</span> <span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">feols</span>(</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>                cases <span class="sc">~</span> <span class="fu">sunab</span>(treat_plb_temp, month_num) <span class="sc">|</span> city <span class="sc">+</span> month_num,</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="sc">~</span> city</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">term =</span> term,</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!!</span><span class="fu">paste0</span>(<span class="st">"plb_"</span>, i, <span class="st">"_pv"</span>) <span class="sc">:</span><span class="er">=</span> p.value,</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">.keep =</span> <span class="st">"none"</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">"term"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Event Study of Placebos of cars2"</span>)</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Heterogeneity 无论是 treat 当中的 A 或 B，它们对应的安慰剂组几乎都不显著；至于 C 或 D，它们本身就是 control 组，其显著性并无任何意义；综上，安慰剂不满足 cross-group significance 条件。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heterogeneity table</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(i) {</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>            cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename</span>(<span class="at">treat_plb_temp =</span> <span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">feols</span>(</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                cases <span class="sc">~</span> <span class="fu">i</span>(city, treat_plb_temp <span class="sc">*</span> post) <span class="sc">|</span> city <span class="sc">+</span> month_num,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="sc">~</span> city</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">term =</span> term,</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!!</span><span class="fu">paste0</span>(<span class="st">"plb_"</span>, i, <span class="st">"_pv"</span>) <span class="sc">:</span><span class="er">=</span> p.value,</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">.keep =</span> <span class="st">"none"</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">"term"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Event Study of Placebos of cars2"</span>)</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot event study figure</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i) {</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>        cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">treat_plb_temp =</span> <span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">feols</span>(</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>            cases <span class="sc">~</span> <span class="fu">sunab</span>(treat_plb_temp, month_num) <span class="sc">|</span> city <span class="sc">+</span> month_num,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">vcov =</span> <span class="sc">~</span>city</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggiplot</span>(<span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Placebo: "</span>, i)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>() <span class="sc">+</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="dv">2</span>, <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Event Study of Placebos  of cars2"</span>)</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heterogeneity figure</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(i) {</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>            cars2 <span class="sc">%&gt;%</span> </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename</span>(<span class="at">treat_plb_temp =</span> <span class="fu">paste0</span>(<span class="st">"treat_plb_"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">feols</span>(</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>                cases <span class="sc">~</span> <span class="fu">i</span>(city, treat_plb_temp <span class="sc">*</span> post) <span class="sc">|</span> city <span class="sc">+</span> month_num,</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="sc">~</span> city</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ggiplot</span>(<span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Placebo: "</span>,i)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrap_plots</span>() <span class="sc">+</span> </span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="dv">2</span>, <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Heterogeneity Test of Placebos  of cars2"</span>)</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="arima" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> ARIMA</h1>
<section id="overview" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">3.1</span> Overview</h2>
<p>将 wide-table 清理为适合需要的 long-table 格式；Quater: 时间变量，可见数值从 1980 Q1 开始，但看不到结束的季度；Category: 分类变量，可见数值有 Beer, Tobacco, Bricks, Cement 等；Value: 数值变量，代表对应分类变量在当前季度的产量，已经取对数；</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clean raw data to long data</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>prod_long <span class="ot">=</span> (</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    aus_production <span class="sc">%&gt;%</span> </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="sc">-</span>Quarter,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"Category"</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"Value"</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Value =</span> <span class="fu">log</span>(Value)) <span class="sc">%&gt;%</span> </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>((<span class="fu">year</span>(Quarter) <span class="sc">&gt;=</span> <span class="dv">1990</span>) <span class="sc">&amp;</span> (<span class="fu">year</span>(Quarter) <span class="sc">&lt;=</span> <span class="dv">2000</span>))</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co"># get wide data</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>prod_wide <span class="ot">=</span> (</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    prod_long <span class="sc">%&gt;%</span> </span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_cols =</span> Quarter, <span class="at">names_from =</span> <span class="st">"Category"</span>, <span class="at">values_from =</span> <span class="st">"Value"</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="co"># show tidy table</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>prod_wide <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Wide Table of Production"</span>)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>prod_long <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Long Table of Production"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot overview</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">=</span> (</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    prod_long <span class="sc">%&gt;%</span> </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autoplot</span>(Value) <span class="sc">+</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Commodity Production"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="co"># plot sub-seasonal values</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>fig2 <span class="ot">=</span> (</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    prod_long <span class="sc">%&gt;%</span> </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gg_subseries</span>(<span class="at">y =</span> Value) <span class="sc">+</span> </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Subseasonal Plot"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="co"># plot lag  </span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>fig3 <span class="ot">=</span> (</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    prod_long <span class="sc">%&gt;%</span> </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Category <span class="sc">==</span> <span class="st">"Beer"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gg_lag</span>(Value, <span class="at">geom =</span> <span class="st">"point"</span>) <span class="sc">+</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Lag of Beer"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Lag"</span>) <span class="sc">+</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="co"># plot autocorrelation</span></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>fig4 <span class="ot">=</span> (</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>    prod_long <span class="sc">%&gt;%</span> </span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ACF</span>(<span class="at">y =</span> Value) <span class="sc">%&gt;%</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Autocorrelation of All"</span>, <span class="at">x =</span> <span class="st">"Lag"</span>, <span class="at">y =</span> <span class="st">"ACF"</span>) <span class="sc">+</span></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> Category)</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into one figure</span></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(fig1, fig2, fig3, fig4)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>对一个具有真正时间性质的时间序列数据，我们基于 Season-Trend-Loess Decomposition 的方法，可以将其拆解为如下结构：</p>
<p><span class="math display">\[
Y_t = T_t + S_t + C_t + R_t
\]</span></p>
<ul>
<li><span class="math inline">\(T_t\)</span> : trend，长期的增长或降低趋势；</li>
<li><span class="math inline">\(S_t\)</span> : seasonality，短期的波动；</li>
<li><span class="math inline">\(C_t\)</span> : circle，全局的在数据之外的周期特征；</li>
<li><span class="math inline">\(R_t\)</span> : remainder，原始数据与预测数据之间的残差；</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># decompose components</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>prod_long_comp <span class="ot">=</span> (</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    prod_long <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">model</span>(<span class="at">mod_stl =</span> <span class="fu">STL</span>(Value)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">components</span>()</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co"># show decomposition df</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    prod_long_comp <span class="sc">%&gt;%</span> </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Decomposition"</span>)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>trend 反应 Beer 总体上确实在缓慢地下降； seasonal_year 反应 Beer 在下降过程中保持了稳定的周期性； remainder 反应 Beer 的下降过程比较平稳顺滑，不存在突然暴跌； remainder 是重中之重，将在下一页深入分析；</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot components of Beer</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    prod_long_comp <span class="sc">%&gt;%</span> </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Category <span class="sc">==</span> <span class="st">"Beer"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autoplot</span>(Value) <span class="sc">+</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Decomposition of Beer"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="modeling-1" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="modeling-1"><span class="header-section-number">3.2</span> Modeling</h2>
<p>ARIMA(p,d,q) 表示因变量只受到自己往期值的影响，没有其他外界变量影响；</p>
<p><span class="math display">\[
y_t \sim \text{ARIMA(p,d,q)}
\]</span></p>
<p>三条支线任务同时推进，将一个有较大周期波动的数据平滑为一个相对线性的数据；</p>
<p>Dif(d): 对原始数据进行 d 次差分计算，消除毛刺，趋于平滑；</p>
<p><span class="math display">\[
\Delta^{(d)} y_t = \sum_{k=0}^{d} \binom{d}{k} (-1)^k y_{t-k}
\]</span></p>
<p>AR(p): 对原始数据进行 p 次自相关回归，消除毛刺，趋于平滑；</p>
<p><span class="math display">\[
AR(p) = \sum_{i=1}^{p} \phi_i y_{t-i}
\]</span></p>
<p>MA(q): 对原始数据进行 q 次移动回归计算，消除毛刺，趋于平滑；</p>
<p><span class="math display">\[
MA(q) = \sum_{j = 1}^q \theta_j \epsilon_{t - j} + \epsilon_t
\]</span></p>
<p>它的线性方程是：</p>
<p><span class="math display">\[
\begin{aligned}
\text{Dif(d)} &amp;= \text{AR}(p) + \text{MA}(q) \\
\Delta^{(d)} y_t &amp;=
    c + \sum_{i=1}^{p} \phi_i \Delta^d y_{t-i} +
    \sum_{j=1}^{q} \theta_j \epsilon_{t-j} + \epsilon_t
\end{aligned}
\]</span></p>
<p>代码显示 summary，coeffecients，accuracy 三张表格；总之，模型相关性和准确性较高，暂不展开，继续往下推导。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit an ARIMA model</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>prod_arima <span class="ot">=</span> prod_long <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="at">mod_arima =</span> <span class="fu">ARIMA</span>(Value))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co"># show ARIMA summary</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    prod_arima <span class="sc">%&gt;%</span> </span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>ar_roots, <span class="sc">-</span>ma_roots) <span class="sc">%&gt;%</span> </span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Summary of ARIMA"</span>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="co"># show coefficients</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    prod_arima <span class="sc">%&gt;%</span> </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Samples of Coef of ARIMA"</span>)</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="co"># show accuracy</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="co">#prod_arima %&gt;% accuracy() %&gt;% datasummary_df(title = "Accuracy of ARIMA")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="prediction" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="prediction"><span class="header-section-number">3.3</span> Prediction</h2>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract predictions</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>prod_arima_pred <span class="ot">=</span> (</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">forecast</span>(prod_arima, <span class="at">h =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pi80 =</span> <span class="fu">hilo</span>(Value, <span class="dv">80</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unpack_hilo</span>(<span class="st">"pi80"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">pred_mean =</span> .mean, <span class="at">pred_80lo =</span> pi80_lower, <span class="at">pred_80hi =</span> pi80_upper) <span class="sc">%&gt;%</span> </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Quarter, Category, pred_mean, pred_80lo, pred_80hi)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co"># show in table</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    prod_arima_pred <span class="sc">%&gt;%</span> </span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Predictions of ARIMA"</span>)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot predictions with raw data</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> prod_long,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Quarter, <span class="at">y =</span> Value, <span class="at">color =</span> Category)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> prod_arima_pred, </span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Quarter, <span class="at">y =</span> pred_mean, <span class="at">color =</span> Category),</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> prod_arima_pred, </span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Quarter, <span class="at">ymin =</span> pred_80lo, <span class="at">ymax =</span> pred_80hi, <span class="at">fill =</span> Category),</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.3</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions of 8 Quarters by ARIMA"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="residuals-1" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="residuals-1"><span class="header-section-number">3.4</span> Residuals</h2>
<p>我们在 1.3 对 GLM 进行了残差检验，包括正态性，独立性，同方差性；简要回顾，希望 AD, DW, BP Test 都满足 <span class="math inline">\(p &gt; 0.05\)</span>，注意是不显著。为了保证 ARIMA 的准确性和严谨性，需要进行残差检验，理论过程一样；代码逻辑也跟 GLM 的逻辑一致，只是 ARIMA 在提取参数的流程上更加复杂；不讨论深层次的技术细节，让代码先跑起来，结果在后面列报。</p>
<p>自相关性 Autocorrelation 是时间序列独有的残差检验；本期的残差应该跟过往的任何一期的残差无关，by Lung-Box test；<span class="math inline">\(H_0\)</span>: 残差之间是独立分布，即不存在自相关，反之则存在自相关；若 <span class="math inline">\(p &lt; 0.05\)</span>，则拒绝原假设，即残差存在自相关，反之则无法拒绝原假设。</p>
<p>总体来看，数据通过独立性、同方差、自相关检验，但未通过正态性检验；分类来看，Gas 未通过正态性检验，其余变量通过全部检验，考虑对 Gas 进行单独处理；对于严谨的学术论文，不能仅仅汇报总体结果，必须将分类变量拆分检测，同时汇报拆分的结果。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># append residuals and fitted values to source</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>prod_arima_aug <span class="ot">=</span> (</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    prod_arima <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">augment</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">arima_res =</span> .resid, <span class="at">arima_fit =</span> .fitted)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co"># check residuals of all categories</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>prod_resi_all <span class="ot">=</span> (</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">AD_pv =</span> <span class="fu">ad.test</span>(arima_res) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"p.value"</span>),</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">DW_pv =</span> <span class="fu">dwtest</span>(arima_res <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"p.value"</span>),</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">BP_pv =</span> <span class="fu">bptest</span>(arima_res <span class="sc">~</span> arima_fit) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"p.value"</span>),</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">LB_pv =</span> <span class="fu">ljung_box</span>(arima_res) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"lb_pvalue"</span>)</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Category =</span> <span class="st">"All"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Category, <span class="fu">everything</span>())</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="co"># chech residuals of each category</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>prod_resi_each <span class="ot">=</span> (</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Category) <span class="sc">%&gt;%</span> </span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">AD_pv =</span> <span class="fu">ad.test</span>(arima_res) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"p.value"</span>),</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">DW_pv =</span> <span class="fu">dwtest</span>(arima_res <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"p.value"</span>),</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">BP_pv =</span> <span class="fu">bptest</span>(arima_res <span class="sc">~</span> arima_fit) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"p.value"</span>),</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">LB_pv =</span> <span class="fu">ljung_box</span>(arima_res) <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"lb_pvalue"</span>)</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into single tibble</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(prod_resi_all, prod_resi_each) <span class="sc">%&gt;%</span> </span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Diagnostics of ARIMA"</span>)</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># check normality</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">=</span> (</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> arima_res, <span class="at">color =</span> Category)) <span class="sc">+</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_qq_line</span>() <span class="sc">+</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">" Normality"</span>, <span class="at">x =</span> <span class="st">"Theoretical QQ"</span>, <span class="at">y =</span> <span class="st">"Sample QQ"</span>) <span class="sc">+</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="co"># check independence</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>fig2 <span class="ot">=</span> (</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">seq_along</span>(arima_res), <span class="at">y =</span> arima_res, <span class="at">color =</span> Category)) <span class="sc">+</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Independence"</span>, <span class="at">x =</span> <span class="st">"Index"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>) <span class="sc">+</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a><span class="co"># check homosedasticity</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>fig3 <span class="ot">=</span> (</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> arima_fit, <span class="at">y =</span> arima_res, <span class="at">color =</span> Category)) <span class="sc">+</span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Homoscedasticity"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>) <span class="sc">+</span></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a><span class="co"># check autocorrelation</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>fig4 <span class="ot">=</span> (</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ACF</span>(arima_res) <span class="sc">%&gt;%</span> </span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf, <span class="at">color =</span> Category)) <span class="sc">+</span></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> lag, <span class="at">yend =</span> <span class="dv">0</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> Category)) <span class="sc">+</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="fl">0.2</span>), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fl">0.2</span>), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Autocorrelation"</span>, <span class="at">x =</span> <span class="st">"Lags"</span>, <span class="at">y =</span> <span class="st">"Autocorrelation"</span>) <span class="sc">+</span></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> Category, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a><span class="co"># combine into one figure</span></span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(fig1, fig2, fig3, fig4)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="stationarity" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="stationarity"><span class="header-section-number">3.5</span> Stationarity</h2>
<p>Stationarity 平稳性：数据的方差在整个时间维度内保持基本稳定，constant variance over time；几乎所有宏观经济数据都可以轻易处理为平稳，但是微观金融数据非常难以处理为平稳；平稳性检验是时间序列最重要的特征之一，是判断模型质量的重要标准，也是区分论文水平的标准。</p>
<p>建模之前，KPSS 作用于原始数据，建模之后，KPSS 作用于残差数据；<span class="math inline">\(H_0\)</span>: 数据具有平稳性，反之则不具有平稳性；若 <span class="math inline">\(p &lt; 0.05\)</span>，则拒绝原假设，认为数据不具有平稳性，反之则具有平稳性。</p>
<p>ARIMA 建模完成后，会在模型内存储一对 AR 和 MA 的实根和虚根；当且仅当 AR 和 MA 的根都在单位圆外，即 <span class="math inline">\(r &gt; 1\)</span>，说明模型不随时间变化，即满足平稳性。若 AR 或 MA 的跟在单位圆内或圆周上，即 <span class="math inline">\(r \le 1\)</span>，说明模型随着时间会变化，即不满足平稳性；具体原理涉及到高维多项式求解，非常复杂，不展开，记住主要结论即可。</p>
<p>建模前，只有 Bricks 满足平稳性，其余变量不满足平稳性，建模后，所有残差数据都满足平稳性；AR 和 MA 的根都在单位元外，满足平稳性要求，ARIMA 模型实现了数据从不平稳到平稳的转型。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test pre-and-post stationarity</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>kpss_pre <span class="ot">=</span> (</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">features</span>(Value, unitroot_kpss) <span class="sc">%&gt;%</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">KPSS_pv_pre =</span> kpss_pvalue) <span class="sc">%&gt;%</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Category, KPSS_pv_pre)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>kpss_post <span class="ot">=</span> (</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    prod_arima_aug <span class="sc">%&gt;%</span> </span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">features</span>(arima_res, unitroot_kpss) <span class="sc">%&gt;%</span> </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">KPSS_pv_post =</span> kpss_pvalue) <span class="sc">%&gt;%</span> </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Category, KPSS_pv_post)</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a><span class="co"># join into single table</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(kpss_pre, kpss_post) <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Pre-and-Post Stationarity"</span>)</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a><span class="co"># plot by built-in function</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a><span class="co"># prod_arima %&gt;% gg_arma() + theme_light()</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot by manually function</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a><span class="co"># extract unit roots from ARIMA</span></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>prod_arima_roots <span class="ot">=</span> (</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    prod_arima <span class="sc">%&gt;%</span> </span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(ar_roots, <span class="at">keep_empty =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(ma_roots, <span class="at">keep_empty =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">ar_roots_real =</span> <span class="fu">Re</span>(ar_roots),</span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">ar_roots_imag =</span> <span class="fu">Im</span>(ar_roots),</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">ma_roots_real =</span> <span class="fu">Re</span>(ma_roots),</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">ma_roots_imag =</span> <span class="fu">Im</span>(ma_roots),</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>.model, <span class="sc">-</span>sigma2, <span class="sc">-</span>log_lik, <span class="sc">-</span>AIC, <span class="sc">-</span>AICc, <span class="sc">-</span>BIC) <span class="sc">%&gt;%</span> </span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(ar_roots_real, ar_roots_imag, ma_roots_real, ma_roots_imag),</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"roots_type"</span>,</span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"roots_value"</span></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">roots_part =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"real"</span>, roots_type), <span class="st">"roots_real"</span>, <span class="st">"roots_imag"</span>),</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">roots_type =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"ar"</span>, roots_type), <span class="st">"AR"</span>, <span class="st">"MA"</span>)</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> roots_part,</span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> roots_value</span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Category, roots_type, roots_real, roots_imag)</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a><span class="co"># plot unit circle</span></span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a>    prod_arima_roots <span class="sc">%&gt;%</span></span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> roots_real, <span class="at">y =</span> roots_imag, <span class="at">color =</span> roots_type, <span class="at">shape =</span> Category)) <span class="sc">+</span></span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_circle</span>(<span class="fu">aes</span>(<span class="at">x0 =</span> <span class="dv">0</span>, <span class="at">y0 =</span> <span class="dv">0</span>, <span class="at">r =</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"lightgray"</span>) <span class="sc">+</span></span>
<span id="cb74-64"><a href="#cb74-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_iterm</span>() <span class="sc">+</span></span>
<span id="cb74-65"><a href="#cb74-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Inverse Unit Circle Test"</span>, <span class="at">x =</span> <span class="st">"Real Parts"</span>, <span class="at">y =</span> <span class="st">"Imaginary Parts"</span>) <span class="sc">+</span></span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_equal</span>(<span class="at">ratio =</span> <span class="dv">1</span>)</span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="darimax" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="darimax"><span class="header-section-number">3.6</span> DARIMAX</h2>
<p>Dynamic ARIMA with Regressors，它在 ARIMAX 的基础上再进化一层；DARIMAX 不考虑实值，而考虑自变量经过 ARIMA 处理之后的残差 res 和预测 fit。残差 res 用来检验自变量对因变量的短期冲击效应 short-term shocks；预测 fit 用来检验自变量对因变量的长期影响效应 long-term effects；它的公式和模型为：</p>
<p><span class="math display">\[
y_t \sim \text{ARIMA(p,d,q)} + \text{Res} (X) + \text{Fit} (X)
\]</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>Beer <span class="sc">~</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ARIMAX</span>(p, d, q) <span class="sc">+</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    res_Tobacco <span class="sc">+</span> res_Bricks <span class="sc">+</span> res_Cement <span class="sc">+</span> res_Electricity <span class="sc">+</span> res_Gas <span class="sc">+</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    fit_Tobacco <span class="sc">+</span> fit_Bricks <span class="sc">+</span> fit_Cement <span class="sc">+</span> fit_Electricity <span class="sc">+</span> fit_Gas</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Cement 对 Beer 有短期负向冲击效果，其余变量对 Beer 短期效果不显著；Cement 对 Beer 有长期正向影响作用，其余变量对 Beer 长期影响不显著。</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create dynamic ARIMA with regressors (DARIMAX)</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co"># "res_xxx": test short-term shocks between variables and y</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># "fit_xxx": test long-term effects between variables and y</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>prod_darimax <span class="ot">=</span> (</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    prod_wide <span class="sc">%&gt;%</span> </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_bricks =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Bricks)) <span class="sc">%&gt;%</span> <span class="fu">residuals</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".resid"</span>),</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_cement =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Cement)) <span class="sc">%&gt;%</span> <span class="fu">residuals</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".resid"</span>),</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_elec =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Electricity)) <span class="sc">%&gt;%</span> <span class="fu">residuals</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".resid"</span>),</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_gas =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Gas)) <span class="sc">%&gt;%</span> <span class="fu">residuals</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".resid"</span>),</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">res_tobacco =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Tobacco)) <span class="sc">%&gt;%</span> <span class="fu">residuals</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".resid"</span>),</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit_bricks =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Bricks)) <span class="sc">%&gt;%</span> <span class="fu">fitted</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".fitted"</span>),</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit_cement =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Cement)) <span class="sc">%&gt;%</span> <span class="fu">fitted</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".fitted"</span>),</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit_elec =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Electricity)) <span class="sc">%&gt;%</span> <span class="fu">fitted</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".fitted"</span>),</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit_gas =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Gas)) <span class="sc">%&gt;%</span> <span class="fu">fitted</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".fitted"</span>),</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit_tobacco =</span> prod_wide <span class="sc">%&gt;%</span> <span class="fu">model</span>(<span class="fu">ARIMA</span>(Tobacco)) <span class="sc">%&gt;%</span> <span class="fu">fitted</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">".fitted"</span>)</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">model</span>(</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">mod_darimax =</span> <span class="fu">ARIMA</span>(</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>            Beer <span class="sc">~</span> </span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>                res_bricks <span class="sc">+</span> res_cement <span class="sc">+</span> res_elec <span class="sc">+</span> res_gas <span class="sc">+</span> res_tobacco <span class="sc">+</span> </span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>                fit_bricks <span class="sc">+</span> fit_cement <span class="sc">+</span> fit_elec <span class="sc">+</span> fit_gas <span class="sc">+</span> fit_tobacco</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="co"># show model summary</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    prod_darimax <span class="sc">%&gt;%</span> </span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>ar_roots, <span class="sc">-</span>ma_roots) <span class="sc">%&gt;%</span> </span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Summary of DARIMAX"</span>)</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a><span class="co"># show model coef</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>prod_darimax <span class="sc">%&gt;%</span> <span class="fu">coef</span>() <span class="sc">%&gt;%</span> <span class="fu">datasummary_df</span>(<span class="at">title =</span> <span class="st">"Coef of DARIMAX"</span>)</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a><span class="co"># show model accuracy</span></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a><span class="co">#prod_darimax %&gt;% accuracy() %&gt;% datasummary_df(title = "Accuracy of DARIMAX")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/liaobingjie\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>